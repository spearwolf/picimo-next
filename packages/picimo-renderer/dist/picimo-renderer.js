/*!
@file @picimo/renderer - part of the hottest webgl library on earth ::( picture-in-motion ):: make sprites & shaders fun again ;-)
@author Wolfger Schramm <wolfger@spearwolf.de>
@version 0.0.1

Copyright 2016-2018 Wolfger Schramm

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@picimo/utils"),require("@picimo/core"),require("loglevel")):"function"==typeof define&&define.amd?define(["exports","@picimo/utils","@picimo/core","loglevel"],e):e(t.PicimoRenderer={},t.PicimoUtils,t.PicimoCore,t.log)}(this,function(t,e,r,n){"use strict";function i(t,e){return t(e={exports:{}},e.exports),e.exports}n=n&&n.hasOwnProperty("default")?n.default:n;var o=i(function(t){var e=t.exports={version:"2.5.7"};"number"==typeof __e&&(__e=e)}),a=(o.version,i(function(t){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)})),u=i(function(t){var e=a["__core-js_shared__"]||(a["__core-js_shared__"]={});(t.exports=function(t,r){return e[t]||(e[t]=void 0!==r?r:{})})("versions",[]).push({version:o.version,mode:"global",copyright:"Â© 2018 Denis Pushkarev (zloirock.ru)"})}),s=0,f=Math.random(),c=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++s+f).toString(36))},l=i(function(t){var e=u("wks"),r=a.Symbol,n="function"==typeof r;(t.exports=function(t){return e[t]||(e[t]=n&&r[t]||(n?r:c)("Symbol."+t))}).store=e}),h=function(t){return"object"==typeof t?null!==t:"function"==typeof t},d=function(t){if(!h(t))throw TypeError(t+" is not an object!");return t},v=function(t){try{return!!t()}catch(t){return!0}},g=!v(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),p=a.document,y=h(p)&&h(p.createElement),b=function(t){return y?p.createElement(t):{}},m=!g&&!v(function(){return 7!=Object.defineProperty(b("div"),"a",{get:function(){return 7}}).a}),E=function(t,e){if(!h(t))return t;var r,n;if(e&&"function"==typeof(r=t.toString)&&!h(n=r.call(t)))return n;if("function"==typeof(r=t.valueOf)&&!h(n=r.call(t)))return n;if(!e&&"function"==typeof(r=t.toString)&&!h(n=r.call(t)))return n;throw TypeError("Can't convert object to primitive value")},_=Object.defineProperty,x={f:g?Object.defineProperty:function(t,e,r){if(d(t),e=E(e,!0),d(r),m)try{return _(t,e,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[e]=r.value),t}},A=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},T=g?function(t,e,r){return x.f(t,e,A(1,r))}:function(t,e,r){return t[e]=r,t},w=l("unscopables"),S=Array.prototype;null==S[w]&&T(S,w,{});var P=function(t){S[w][t]=!0},R=function(t,e){return{value:e,done:!!t}},I={},O={}.toString,B=function(t){return O.call(t).slice(8,-1)},L=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==B(t)?t.split(""):Object(t)},N=function(t){if(null==t)throw TypeError("Can't call method on  "+t);return t},U=function(t){return L(N(t))},k={}.hasOwnProperty,F=function(t,e){return k.call(t,e)},M=i(function(t){var e=c("src"),r=Function.toString,n=(""+r).split("toString");o.inspectSource=function(t){return r.call(t)},(t.exports=function(t,r,i,o){var u="function"==typeof i;u&&(F(i,"name")||T(i,"name",r)),t[r]!==i&&(u&&(F(i,e)||T(i,e,t[r]?""+t[r]:n.join(String(r)))),t===a?t[r]=i:o?t[r]?t[r]=i:T(t,r,i):(delete t[r],T(t,r,i)))})(Function.prototype,"toString",function(){return"function"==typeof this&&this[e]||r.call(this)})}),D=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t},G=function(t,e,r){if(D(t),void 0===e)return t;switch(r){case 1:return function(r){return t.call(e,r)};case 2:return function(r,n){return t.call(e,r,n)};case 3:return function(r,n,i){return t.call(e,r,n,i)}}return function(){return t.apply(e,arguments)}},C=function(t,e,r){var n,i,u,s,f=t&C.F,c=t&C.G,l=t&C.S,h=t&C.P,d=t&C.B,v=c?a:l?a[e]||(a[e]={}):(a[e]||{}).prototype,g=c?o:o[e]||(o[e]={}),p=g.prototype||(g.prototype={});for(n in c&&(r=e),r)u=((i=!f&&v&&void 0!==v[n])?v:r)[n],s=d&&i?G(u,a):h&&"function"==typeof u?G(Function.call,u):u,v&&M(v,n,u,t&C.U),g[n]!=u&&T(g,n,s),h&&p[n]!=u&&(p[n]=u)};a.core=o,C.F=1,C.G=2,C.S=4,C.P=8,C.B=16,C.W=32,C.U=64,C.R=128;var W=C,j=Math.ceil,V=Math.floor,Y=function(t){return isNaN(t=+t)?0:(t>0?V:j)(t)},X=Math.min,H=function(t){return t>0?X(Y(t),9007199254740991):0},z=Math.max,K=Math.min,q=function(t,e){return(t=Y(t))<0?z(t+e,0):K(t,e)},J=function(t){return function(e,r,n){var i,o=U(e),a=H(o.length),u=q(n,a);if(t&&r!=r){for(;a>u;)if((i=o[u++])!=i)return!0}else for(;a>u;u++)if((t||u in o)&&o[u]===r)return t||u||0;return!t&&-1}},Q=u("keys"),Z=function(t){return Q[t]||(Q[t]=c(t))},$=J(!1),tt=Z("IE_PROTO"),et=function(t,e){var r,n=U(t),i=0,o=[];for(r in n)r!=tt&&F(n,r)&&o.push(r);for(;e.length>i;)F(n,r=e[i++])&&(~$(o,r)||o.push(r));return o},rt="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),nt=Object.keys||function(t){return et(t,rt)},it=g?Object.defineProperties:function(t,e){d(t);for(var r,n=nt(e),i=n.length,o=0;i>o;)x.f(t,r=n[o++],e[r]);return t},ot=a.document,at=ot&&ot.documentElement,ut=Z("IE_PROTO"),st=function(){},ft=function(){var t,e=b("iframe"),r=rt.length;for(e.style.display="none",at.appendChild(e),e.src="javascript:",(t=e.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),ft=t.F;r--;)delete ft.prototype[rt[r]];return ft()},ct=Object.create||function(t,e){var r;return null!==t?(st.prototype=d(t),r=new st,st.prototype=null,r[ut]=t):r=ft(),void 0===e?r:it(r,e)},lt=x.f,ht=l("toStringTag"),dt=function(t,e,r){t&&!F(t=r?t:t.prototype,ht)&&lt(t,ht,{configurable:!0,value:e})},vt={};T(vt,l("iterator"),function(){return this});var gt=function(t,e,r){t.prototype=ct(vt,{next:A(1,r)}),dt(t,e+" Iterator")},pt=function(t){return Object(N(t))},yt=Z("IE_PROTO"),bt=Object.prototype,mt=Object.getPrototypeOf||function(t){return t=pt(t),F(t,yt)?t[yt]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?bt:null},Et=l("iterator"),_t=!([].keys&&"next"in[].keys()),xt=function(){return this},At=function(t,e,r,n,i,o,a){gt(r,e,n);var u,s,f,c=function(t){if(!_t&&t in v)return v[t];switch(t){case"keys":case"values":return function(){return new r(this,t)}}return function(){return new r(this,t)}},l=e+" Iterator",h="values"==i,d=!1,v=t.prototype,g=v[Et]||v["@@iterator"]||i&&v[i],p=g||c(i),y=i?h?c("entries"):p:void 0,b="Array"==e&&v.entries||g;if(b&&(f=mt(b.call(new t)))!==Object.prototype&&f.next&&(dt(f,l,!0),"function"!=typeof f[Et]&&T(f,Et,xt)),h&&g&&"values"!==g.name&&(d=!0,p=function(){return g.call(this)}),(_t||d||!v[Et])&&T(v,Et,p),I[e]=p,I[l]=xt,i)if(u={values:h?p:c("values"),keys:o?p:c("keys"),entries:y},a)for(s in u)s in v||M(v,s,u[s]);else W(W.P+W.F*(_t||d),e,u);return u},Tt=At(Array,"Array",function(t,e){this._t=U(t),this._i=0,this._k=e},function(){var t=this._t,e=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,R(1)):R(0,"keys"==e?r:"values"==e?t[r]:[r,t[r]])},"values");I.Arguments=I.Array,P("keys"),P("values"),P("entries");for(var wt=l("iterator"),St=l("toStringTag"),Pt=I.Array,Rt={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},It=nt(Rt),Ot=0;Ot<It.length;Ot++){var Bt,Lt=It[Ot],Nt=Rt[Lt],Ut=a[Lt],kt=Ut&&Ut.prototype;if(kt&&(kt[wt]||T(kt,wt,Pt),kt[St]||T(kt,St,Lt),I[Lt]=Pt,Nt))for(Bt in Tt)kt[Bt]||M(kt,Bt,Tt[Bt],!0)}var Ft,Mt=(Ft=!0,function(t,e){var r,n,i=String(N(t)),o=Y(e),a=i.length;return o<0||o>=a?Ft?"":void 0:(r=i.charCodeAt(o))<55296||r>56319||o+1===a||(n=i.charCodeAt(o+1))<56320||n>57343?Ft?i.charAt(o):r:Ft?i.slice(o,o+2):n-56320+(r-55296<<10)+65536});At(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,e=this._t,r=this._i;return r>=e.length?{value:void 0,done:!0}:(t=Mt(e,r),this._i+=t.length,{value:t,done:!1})});var Dt=function(t,e,r){for(var n in e)M(t,n,e[n],r);return t},Gt=function(t,e,r,n){if(!(t instanceof e)||void 0!==n&&n in t)throw TypeError(r+": incorrect invocation!");return t},Ct=function(t,e,r,n){try{return n?e(d(r)[0],r[1]):e(r)}catch(e){var i=t.return;throw void 0!==i&&d(i.call(t)),e}},Wt=l("iterator"),jt=Array.prototype,Vt=function(t){return void 0!==t&&(I.Array===t||jt[Wt]===t)},Yt=l("toStringTag"),Xt="Arguments"==B(function(){return arguments}()),Ht=function(t){var e,r,n;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=function(t,e){try{return t[e]}catch(t){}}(e=Object(t),Yt))?r:Xt?B(e):"Object"==(n=B(e))&&"function"==typeof e.callee?"Arguments":n},zt=l("iterator"),Kt=o.getIteratorMethod=function(t){if(null!=t)return t[zt]||t["@@iterator"]||I[Ht(t)]},qt=i(function(t){var e={},r={},n=t.exports=function(t,n,i,o,a){var u,s,f,c,l=a?function(){return t}:Kt(t),h=G(i,o,n?2:1),v=0;if("function"!=typeof l)throw TypeError(t+" is not iterable!");if(Vt(l)){for(u=H(t.length);u>v;v++)if((c=n?h(d(s=t[v])[0],s[1]):h(t[v]))===e||c===r)return c}else for(f=l.call(t);!(s=f.next()).done;)if((c=Ct(f,h,s.value,n))===e||c===r)return c};n.BREAK=e,n.RETURN=r}),Jt=l("species"),Qt=function(t){var e=a[t];g&&e&&!e[Jt]&&x.f(e,Jt,{configurable:!0,get:function(){return this}})},Zt=i(function(t){var e=c("meta"),r=x.f,n=0,i=Object.isExtensible||function(){return!0},o=!v(function(){return i(Object.preventExtensions({}))}),a=function(t){r(t,e,{value:{i:"O"+ ++n,w:{}}})},u=t.exports={KEY:e,NEED:!1,fastKey:function(t,r){if(!h(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!F(t,e)){if(!i(t))return"F";if(!r)return"E";a(t)}return t[e].i},getWeak:function(t,r){if(!F(t,e)){if(!i(t))return!0;if(!r)return!1;a(t)}return t[e].w},onFreeze:function(t){return o&&u.NEED&&i(t)&&!F(t,e)&&a(t),t}}}),$t=(Zt.KEY,Zt.NEED,Zt.fastKey,Zt.getWeak,Zt.onFreeze,function(t,e){if(!h(t)||t._t!==e)throw TypeError("Incompatible receiver, "+e+" required!");return t}),te=x.f,ee=Zt.fastKey,re=g?"_s":"size",ne=function(t,e){var r,n=ee(e);if("F"!==n)return t._i[n];for(r=t._f;r;r=r.n)if(r.k==e)return r},ie={getConstructor:function(t,e,r,n){var i=t(function(t,o){Gt(t,i,e,"_i"),t._t=e,t._i=ct(null),t._f=void 0,t._l=void 0,t[re]=0,null!=o&&qt(o,r,t[n],t)});return Dt(i.prototype,{clear:function(){for(var t=$t(this,e),r=t._i,n=t._f;n;n=n.n)n.r=!0,n.p&&(n.p=n.p.n=void 0),delete r[n.i];t._f=t._l=void 0,t[re]=0},delete:function(t){var r=$t(this,e),n=ne(r,t);if(n){var i=n.n,o=n.p;delete r._i[n.i],n.r=!0,o&&(o.n=i),i&&(i.p=o),r._f==n&&(r._f=i),r._l==n&&(r._l=o),r[re]--}return!!n},forEach:function(t){$t(this,e);for(var r,n=G(t,arguments.length>1?arguments[1]:void 0,3);r=r?r.n:this._f;)for(n(r.v,r.k,this);r&&r.r;)r=r.p},has:function(t){return!!ne($t(this,e),t)}}),g&&te(i.prototype,"size",{get:function(){return $t(this,e)[re]}}),i},def:function(t,e,r){var n,i,o=ne(t,e);return o?o.v=r:(t._l=o={i:i=ee(e,!0),k:e,v:r,p:n=t._l,n:void 0,r:!1},t._f||(t._f=o),n&&(n.n=o),t[re]++,"F"!==i&&(t._i[i]=o)),t},getEntry:ne,setStrong:function(t,e,r){At(t,e,function(t,r){this._t=$t(t,e),this._k=r,this._l=void 0},function(){for(var t=this._k,e=this._l;e&&e.r;)e=e.p;return this._t&&(this._l=e=e?e.n:this._t._f)?R(0,"keys"==t?e.k:"values"==t?e.v:[e.k,e.v]):(this._t=void 0,R(1))},r?"entries":"values",!r,!0),Qt(e)}},oe=l("iterator"),ae=!1;try{[7][oe]().return=function(){ae=!0}}catch(t){}var ue=function(t,e){if(!e&&!ae)return!1;var r=!1;try{var n=[7],i=n[oe]();i.next=function(){return{done:r=!0}},n[oe]=function(){return i},t(n)}catch(t){}return r},se={f:{}.propertyIsEnumerable},fe=Object.getOwnPropertyDescriptor,ce={f:g?fe:function(t,e){if(t=U(t),e=E(e,!0),m)try{return fe(t,e)}catch(t){}if(F(t,e))return A(!se.f.call(t,e),t[e])}},le=function(t,e){if(d(t),!h(e)&&null!==e)throw TypeError(e+": can't set as prototype!")},he={set:Object.setPrototypeOf||("__proto__"in{}?function(t,e,r){try{(r=G(Function.call,ce.f(Object.prototype,"__proto__").set,2))(t,[]),e=!(t instanceof Array)}catch(t){e=!0}return function(t,n){return le(t,n),e?t.__proto__=n:r(t,n),t}}({},!1):void 0),check:le}.set,de=function(t,e,r,n,i,o){var u=a[t],s=u,f=i?"set":"add",c=s&&s.prototype,l={},d=function(t){var e=c[t];M(c,t,"delete"==t?function(t){return!(o&&!h(t))&&e.call(this,0===t?0:t)}:"has"==t?function(t){return!(o&&!h(t))&&e.call(this,0===t?0:t)}:"get"==t?function(t){return o&&!h(t)?void 0:e.call(this,0===t?0:t)}:"add"==t?function(t){return e.call(this,0===t?0:t),this}:function(t,r){return e.call(this,0===t?0:t,r),this})};if("function"==typeof s&&(o||c.forEach&&!v(function(){(new s).entries().next()}))){var g=new s,p=g[f](o?{}:-0,1)!=g,y=v(function(){g.has(1)}),b=ue(function(t){new s(t)}),m=!o&&v(function(){for(var t=new s,e=5;e--;)t[f](e,e);return!t.has(-0)});b||((s=e(function(e,r){Gt(e,s,t);var n=function(t,e,r){var n,i=e.constructor;return i!==r&&"function"==typeof i&&(n=i.prototype)!==r.prototype&&h(n)&&he&&he(t,n),t}(new u,e,s);return null!=r&&qt(r,i,n[f],n),n})).prototype=c,c.constructor=s),(y||m)&&(d("delete"),d("has"),i&&d("get")),(m||p)&&d(f),o&&c.clear&&delete c.clear}else s=n.getConstructor(e,t,i,f),Dt(s.prototype,r),Zt.NEED=!0;return dt(s,t),l[t]=s,W(W.G+W.W+W.F*(s!=u),l),o||n.setStrong(s,t,i),s};de("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var e=ie.getEntry($t(this,"Map"),t);return e&&e.v},set:function(t,e){return ie.def($t(this,"Map"),0===t?0:t,e)}},ie,!0);function ve(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function ge(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function pe(t,e,r){return e&&ge(t.prototype,e),r&&ge(t,r),t}function ye(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&me(t,e)}function be(t){return(be=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function me(t,e){return(me=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function Ee(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}for(var _e,xe=null,Ae=function(){function t(e){var r=e.enable,n=e.sfactor,i=void 0===n?null:n,o=e.dfactor,a=void 0===o?null:o;ve(this,t),this.enable=r,this.sfactor=i,this.dfactor=a}return pe(t,null,[{key:"make",value:function(e,r){null===xe&&(xe=new Map,t.make("off",{enable:!1}),t.make("additive",{enable:!0,sfactor:"SRC_ALPHA",dfactor:"ONE"}),t.make("orderDependent",{enable:!0,sfactor:"SRC_ALPHA",dfactor:"ONE_MINUS_SRC_ALPHA"}));var n=xe.get(e);if(n)return n;if(r){var i,o,a,u,s,f,c=(o=(i=r).enable,a=i.sfactor,u=void 0===a?"":a,s=i.dfactor,f=void 0===s?"":s,JSON.stringify([o,u,f]));return(n=xe.get(c))?(xe.set(e,n),n):(n=new t(r),xe.set(c,n),xe.set(e,n),n)}}}]),pe(t,[{key:"isEqual",value:function(t){return t&&this.enable===t.enable&&this._sfactor===t.sfactor&&this._dfactor===t.dfactor}},{key:"sfactor",set:function(t){this._sfactor="string"==typeof t?t:void 0},get:function(){return this._sfactor}},{key:"dfactor",set:function(t){this._dfactor="string"==typeof t?t:void 0},get:function(){return this._dfactor}}]),t}(),Te=c("typed_array"),we=c("view"),Se=!(!a.ArrayBuffer||!a.DataView),Pe=Se,Re=0,Ie="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");Re<9;)(_e=a[Ie[Re++]])?(T(_e.prototype,Te,!0),T(_e.prototype,we,!0)):Pe=!1;var Oe={ABV:Se,CONSTR:Pe,TYPED:Te,VIEW:we},Be=function(t){if(void 0===t)return 0;var e=Y(t),r=H(e);if(e!==r)throw RangeError("Wrong length!");return r},Le=rt.concat("length","prototype"),Ne={f:Object.getOwnPropertyNames||function(t){return et(t,Le)}},Ue=function(t){for(var e=pt(this),r=H(e.length),n=arguments.length,i=q(n>1?arguments[1]:void 0,r),o=n>2?arguments[2]:void 0,a=void 0===o?r:q(o,r);a>i;)e[i++]=t;return e},ke=i(function(t,e){var r=Ne.f,n=x.f,i="prototype",o="Wrong index!",u=a.ArrayBuffer,s=a.DataView,f=a.Math,c=a.RangeError,l=a.Infinity,h=u,d=f.abs,p=f.pow,y=f.floor,b=f.log,m=f.LN2,E=g?"_b":"buffer",_=g?"_l":"byteLength",A=g?"_o":"byteOffset";function w(t,e,r){var n,i,o,a=new Array(r),u=8*r-e-1,s=(1<<u)-1,f=s>>1,c=23===e?p(2,-24)-p(2,-77):0,h=0,v=t<0||0===t&&1/t<0?1:0;for((t=d(t))!=t||t===l?(i=t!=t?1:0,n=s):(n=y(b(t)/m),t*(o=p(2,-n))<1&&(n--,o*=2),(t+=n+f>=1?c/o:c*p(2,1-f))*o>=2&&(n++,o/=2),n+f>=s?(i=0,n=s):n+f>=1?(i=(t*o-1)*p(2,e),n+=f):(i=t*p(2,f-1)*p(2,e),n=0));e>=8;a[h++]=255&i,i/=256,e-=8);for(n=n<<e|i,u+=e;u>0;a[h++]=255&n,n/=256,u-=8);return a[--h]|=128*v,a}function S(t,e,r){var n,i=8*r-e-1,o=(1<<i)-1,a=o>>1,u=i-7,s=r-1,f=t[s--],c=127&f;for(f>>=7;u>0;c=256*c+t[s],s--,u-=8);for(n=c&(1<<-u)-1,c>>=-u,u+=e;u>0;n=256*n+t[s],s--,u-=8);if(0===c)c=1-a;else{if(c===o)return n?NaN:f?-l:l;n+=p(2,e),c-=a}return(f?-1:1)*n*p(2,c-e)}function P(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]}function R(t){return[255&t]}function I(t){return[255&t,t>>8&255]}function O(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]}function B(t){return w(t,52,8)}function L(t){return w(t,23,4)}function N(t,e,r){n(t[i],e,{get:function(){return this[r]}})}function U(t,e,r,n){var i=Be(+r);if(i+e>t[_])throw c(o);var a=t[E]._b,u=i+t[A],s=a.slice(u,u+e);return n?s:s.reverse()}function k(t,e,r,n,i,a){var u=Be(+r);if(u+e>t[_])throw c(o);for(var s=t[E]._b,f=u+t[A],l=n(+i),h=0;h<e;h++)s[f+h]=l[a?h:e-h-1]}if(Oe.ABV){if(!v(function(){u(1)})||!v(function(){new u(-1)})||v(function(){return new u,new u(1.5),new u(NaN),"ArrayBuffer"!=u.name})){for(var F,M=(u=function(t){return Gt(this,u),new h(Be(t))})[i]=h[i],D=r(h),G=0;D.length>G;)(F=D[G++])in u||T(u,F,h[F]);M.constructor=u}var C=new s(new u(2)),W=s[i].setInt8;C.setInt8(0,2147483648),C.setInt8(1,2147483649),!C.getInt8(0)&&C.getInt8(1)||Dt(s[i],{setInt8:function(t,e){W.call(this,t,e<<24>>24)},setUint8:function(t,e){W.call(this,t,e<<24>>24)}},!0)}else u=function(t){Gt(this,u,"ArrayBuffer");var e=Be(t);this._b=Ue.call(new Array(e),0),this[_]=e},s=function(t,e,r){Gt(this,s,"DataView"),Gt(t,u,"DataView");var n=t[_],i=Y(e);if(i<0||i>n)throw c("Wrong offset!");if(i+(r=void 0===r?n-i:H(r))>n)throw c("Wrong length!");this[E]=t,this[A]=i,this[_]=r},g&&(N(u,"byteLength","_l"),N(s,"buffer","_b"),N(s,"byteLength","_l"),N(s,"byteOffset","_o")),Dt(s[i],{getInt8:function(t){return U(this,1,t)[0]<<24>>24},getUint8:function(t){return U(this,1,t)[0]},getInt16:function(t){var e=U(this,2,t,arguments[1]);return(e[1]<<8|e[0])<<16>>16},getUint16:function(t){var e=U(this,2,t,arguments[1]);return e[1]<<8|e[0]},getInt32:function(t){return P(U(this,4,t,arguments[1]))},getUint32:function(t){return P(U(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return S(U(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return S(U(this,8,t,arguments[1]),52,8)},setInt8:function(t,e){k(this,1,t,R,e)},setUint8:function(t,e){k(this,1,t,R,e)},setInt16:function(t,e){k(this,2,t,I,e,arguments[2])},setUint16:function(t,e){k(this,2,t,I,e,arguments[2])},setInt32:function(t,e){k(this,4,t,O,e,arguments[2])},setUint32:function(t,e){k(this,4,t,O,e,arguments[2])},setFloat32:function(t,e){k(this,4,t,L,e,arguments[2])},setFloat64:function(t,e){k(this,8,t,B,e,arguments[2])}});dt(u,"ArrayBuffer"),dt(s,"DataView"),T(s[i],Oe.VIEW,!0),e.ArrayBuffer=u,e.DataView=s}),Fe=Array.isArray||function(t){return"Array"==B(t)},Me=l("species"),De=function(t,e){return new(function(t){var e;return Fe(t)&&("function"!=typeof(e=t.constructor)||e!==Array&&!Fe(e.prototype)||(e=void 0),h(e)&&null===(e=e[Me])&&(e=void 0)),void 0===e?Array:e}(t))(e)},Ge=function(t,e){var r=1==t,n=2==t,i=3==t,o=4==t,a=6==t,u=5==t||a,s=e||De;return function(e,f,c){for(var l,h,d=pt(e),v=L(d),g=G(f,c,3),p=H(v.length),y=0,b=r?s(e,p):n?s(e,0):void 0;p>y;y++)if((u||y in v)&&(h=g(l=v[y],y,d),t))if(r)b[y]=h;else if(h)switch(t){case 3:return!0;case 5:return l;case 6:return y;case 2:b.push(l)}else if(o)return!1;return a?-1:i||o?o:b}},Ce=l("species"),We=function(t,e){var r,n=d(t).constructor;return void 0===n||null==(r=d(n)[Ce])?e:D(r)},je=[].copyWithin||function(t,e){var r=pt(this),n=H(r.length),i=q(t,n),o=q(e,n),a=arguments.length>2?arguments[2]:void 0,u=Math.min((void 0===a?n:q(a,n))-o,n-i),s=1;for(o<i&&i<o+u&&(s=-1,o+=u-1,i+=u-1);u-- >0;)o in r?r[i]=r[o]:delete r[i],i+=s,o+=s;return r},Ve=i(function(t){if(g){var e=a,r=v,n=W,i=Oe,o=ke,u=G,s=Gt,f=A,d=T,p=Dt,y=Y,b=H,m=Be,_=q,w=E,S=F,P=Ht,R=h,O=pt,B=Vt,L=ct,N=mt,U=Ne.f,k=Kt,M=c,D=l,C=Ge,j=J,V=We,X=Tt,z=I,K=ue,Q=Qt,Z=Ue,$=je,tt=x,et=ce,rt=tt.f,nt=et.f,it=e.RangeError,ot=e.TypeError,at=e.Uint8Array,ut=Array.prototype,st=o.ArrayBuffer,ft=o.DataView,lt=C(0),ht=C(2),dt=C(3),vt=C(4),gt=C(5),yt=C(6),bt=j(!0),Et=j(!1),_t=X.values,xt=X.keys,At=X.entries,wt=ut.lastIndexOf,St=ut.reduce,Pt=ut.reduceRight,Rt=ut.join,It=ut.sort,Ot=ut.slice,Bt=ut.toString,Lt=ut.toLocaleString,Nt=D("iterator"),Ut=D("toStringTag"),kt=M("typed_constructor"),Ft=M("def_constructor"),Mt=i.CONSTR,Ct=i.TYPED,Wt=i.VIEW,jt=C(1,function(t,e){return Jt(V(t,t[Ft]),e)}),Yt=r(function(){return 1===new at(new Uint16Array([1]).buffer)[0]}),Xt=!!at&&!!at.prototype.set&&r(function(){new at(1).set({})}),zt=function(t,e){var r=y(t);if(r<0||r%e)throw it("Wrong offset!");return r},qt=function(t){if(R(t)&&Ct in t)return t;throw ot(t+" is not a typed array!")},Jt=function(t,e){if(!(R(t)&&kt in t))throw ot("It is not a typed array constructor!");return new t(e)},Zt=function(t,e){return $t(V(t,t[Ft]),e)},$t=function(t,e){for(var r=0,n=e.length,i=Jt(t,n);n>r;)i[r]=e[r++];return i},te=function(t,e,r){rt(t,e,{get:function(){return this._d[r]}})},ee=function(t){var e,r,n,i,o,a,s=O(t),f=arguments.length,c=f>1?arguments[1]:void 0,l=void 0!==c,h=k(s);if(null!=h&&!B(h)){for(a=h.call(s),n=[],e=0;!(o=a.next()).done;e++)n.push(o.value);s=n}for(l&&f>2&&(c=u(c,arguments[2],2)),e=0,r=b(s.length),i=Jt(this,r);r>e;e++)i[e]=l?c(s[e],e):s[e];return i},re=function(){for(var t=0,e=arguments.length,r=Jt(this,e);e>t;)r[t]=arguments[t++];return r},ne=!!at&&r(function(){Lt.call(new at(1))}),ie=function(){return Lt.apply(ne?Ot.call(qt(this)):qt(this),arguments)},oe={copyWithin:function(t,e){return $.call(qt(this),t,e,arguments.length>2?arguments[2]:void 0)},every:function(t){return vt(qt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return Z.apply(qt(this),arguments)},filter:function(t){return Zt(this,ht(qt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return gt(qt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return yt(qt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){lt(qt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return Et(qt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return bt(qt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return Rt.apply(qt(this),arguments)},lastIndexOf:function(t){return wt.apply(qt(this),arguments)},map:function(t){return jt(qt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return St.apply(qt(this),arguments)},reduceRight:function(t){return Pt.apply(qt(this),arguments)},reverse:function(){for(var t,e=qt(this).length,r=Math.floor(e/2),n=0;n<r;)t=this[n],this[n++]=this[--e],this[e]=t;return this},some:function(t){return dt(qt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return It.call(qt(this),t)},subarray:function(t,e){var r=qt(this),n=r.length,i=_(t,n);return new(V(r,r[Ft]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,b((void 0===e?n:_(e,n))-i))}},ae=function(t,e){return Zt(this,Ot.call(qt(this),t,e))},se=function(t){qt(this);var e=zt(arguments[1],1),r=this.length,n=O(t),i=b(n.length),o=0;if(i+e>r)throw it("Wrong length!");for(;o<i;)this[e+o]=n[o++]},fe={entries:function(){return At.call(qt(this))},keys:function(){return xt.call(qt(this))},values:function(){return _t.call(qt(this))}},le=function(t,e){return R(t)&&t[Ct]&&"symbol"!=typeof e&&e in t&&String(+e)==String(e)},he=function(t,e){return le(t,e=w(e,!0))?f(2,t[e]):nt(t,e)},de=function(t,e,r){return!(le(t,e=w(e,!0))&&R(r)&&S(r,"value"))||S(r,"get")||S(r,"set")||r.configurable||S(r,"writable")&&!r.writable||S(r,"enumerable")&&!r.enumerable?rt(t,e,r):(t[e]=r.value,t)};Mt||(et.f=he,tt.f=de),n(n.S+n.F*!Mt,"Object",{getOwnPropertyDescriptor:he,defineProperty:de}),r(function(){Bt.call({})})&&(Bt=Lt=function(){return Rt.call(this)});var ve=p({},oe);p(ve,fe),d(ve,Nt,fe.values),p(ve,{slice:ae,set:se,constructor:function(){},toString:Bt,toLocaleString:ie}),te(ve,"buffer","b"),te(ve,"byteOffset","o"),te(ve,"byteLength","l"),te(ve,"length","e"),rt(ve,Ut,{get:function(){return this[Ct]}}),t.exports=function(t,o,a,u){var f=t+((u=!!u)?"Clamped":"")+"Array",c="get"+t,l="set"+t,h=e[f],v=h||{},g=h&&N(h),p=!h||!i.ABV,y={},E=h&&h.prototype,_=function(t,e){rt(t,e,{get:function(){return function(t,e){var r=t._d;return r.v[c](e*o+r.o,Yt)}(this,e)},set:function(t){return function(t,e,r){var n=t._d;u&&(r=(r=Math.round(r))<0?0:r>255?255:255&r),n.v[l](e*o+n.o,r,Yt)}(this,e,t)},enumerable:!0})};p?(h=a(function(t,e,r,n){s(t,h,f,"_d");var i,a,u,c,l=0,v=0;if(R(e)){if(!(e instanceof st||"ArrayBuffer"==(c=P(e))||"SharedArrayBuffer"==c))return Ct in e?$t(h,e):ee.call(h,e);i=e,v=zt(r,o);var g=e.byteLength;if(void 0===n){if(g%o)throw it("Wrong length!");if((a=g-v)<0)throw it("Wrong length!")}else if((a=b(n)*o)+v>g)throw it("Wrong length!");u=a/o}else u=m(e),i=new st(a=u*o);for(d(t,"_d",{b:i,o:v,l:a,e:u,v:new ft(i)});l<u;)_(t,l++)}),E=h.prototype=L(ve),d(E,"constructor",h)):r(function(){h(1)})&&r(function(){new h(-1)})&&K(function(t){new h,new h(null),new h(1.5),new h(t)},!0)||(h=a(function(t,e,r,n){var i;return s(t,h,f),R(e)?e instanceof st||"ArrayBuffer"==(i=P(e))||"SharedArrayBuffer"==i?void 0!==n?new v(e,zt(r,o),n):void 0!==r?new v(e,zt(r,o)):new v(e):Ct in e?$t(h,e):ee.call(h,e):new v(m(e))}),lt(g!==Function.prototype?U(v).concat(U(g)):U(v),function(t){t in h||d(h,t,v[t])}),h.prototype=E,E.constructor=h);var x=E[Nt],A=!!x&&("values"==x.name||null==x.name),T=fe.values;d(h,kt,!0),d(E,Ct,f),d(E,Wt,!0),d(E,Ft,h),(u?new h(1)[Ut]==f:Ut in E)||rt(E,Ut,{get:function(){return f}}),y[f]=h,n(n.G+n.W+n.F*(h!=v),y),n(n.S,f,{BYTES_PER_ELEMENT:o}),n(n.S+n.F*r(function(){v.of.call(h,1)}),f,{from:ee,of:re}),"BYTES_PER_ELEMENT"in E||d(E,"BYTES_PER_ELEMENT",o),n(n.P,f,oe),Q(f),n(n.P+n.F*Xt,f,{set:se}),n(n.P+n.F*!A,f,fe),E.toString!=Bt&&(E.toString=Bt),n(n.P+n.F*r(function(){new h(1).slice()}),f,{slice:ae}),n(n.P+n.F*(r(function(){return[1,2].toLocaleString()!=new h([1,2]).toLocaleString()})||!r(function(){E.toLocaleString.call([1,2])})),f,{toLocaleString:ie}),z[f]=A?x:T,A||d(E,Nt,T)}}else t.exports=function(){}});Ve("Uint8",1,function(t){return function(e,r,n){return t(this,e,r,n)}},!0);var Ye=function(t,e,r){e in t?x.f(t,e,A(0,r)):t[e]=r};W(W.S+W.F*!ue(function(t){}),"Array",{from:function(t){var e,r,n,i,o=pt(t),a="function"==typeof this?this:Array,u=arguments.length,s=u>1?arguments[1]:void 0,f=void 0!==s,c=0,l=Kt(o);if(f&&(s=G(s,u>2?arguments[2]:void 0,2)),null==l||a==Array&&Vt(l))for(r=new a(e=H(o.length));e>c;c++)Ye(r,c,f?s(o[c],c):o[c]);else for(i=l.call(o),r=new a;!(n=i.next()).done;c++)Ye(r,c,f?Ct(i,s,[n.value,c],!0):n.value);return r.length=c,r}});var Xe=function(t,e){return!!t&&v(function(){e?t.call(null,function(){},1):t.call(null)})},He=Ge(0),ze=Xe([].forEach,!0);W(W.P+W.F*!ze,"Array",{forEach:function(t){return He(this,t,arguments[1])}}),Ve("Uint8",1,function(t){return function(e,r,n){return t(this,e,r,n)}});de("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return ie.def($t(this,"Set"),t=0===t?0:t,t)}},ie);var Ke=J(!1),qe=[].indexOf,Je=!!qe&&1/[1].indexOf(1,-0)<0;W(W.P+W.F*(Je||!Xe(qe)),"Array",{indexOf:function(t){return Je?qe.apply(this,arguments)||0:Ke(this,t,arguments[1])}});var Qe=Ge(2);W(W.P+W.F*!Xe([].filter,!0),"Array",{filter:function(t){return Qe(this,t,arguments[1])}});var Ze=function(){function t(e){ve(this,t),this.glx=e,this.boundTextures=new Array(e.MAX_TEXTURE_IMAGE_UNITS);for(var r=0;r<this.boundTextures.length;++r)this.boundTextures[r]=null;this.lastBoundTexUnit=0}return pe(t,[{key:"bindWebGlTexture",value:function(t){var e=this.boundTextures.indexOf(t);if(e<0){for(var r=0;r<this.boundTextures.length;++r)if(!this.boundTextures[r]){e=r,this.boundTextures[r]=t;break}if(e<0){e=this.lastBoundTexUnit;var n=this.boundTextures[e];n&&(n.texUnit=-1),this.lastBoundTexUnit=(this.lastBoundTexUnit+1)%this.glx.MAX_TEXTURE_IMAGE_UNITS}this.glx.activeTexture(e),this.glx.bindTexture2d(t.glTexObj),t.texUnit=e}return e}}]),t}(),$e=function(t){var e=t.gl;t.DEPTH_BITS=e.getParameter(e.DEPTH_BITS),t.STENCIL_BITS=e.getParameter(e.STENCIL_BITS),t.MAX_TEXTURE_IMAGE_UNITS=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),t.boundBuffers.set(e.ARRAY_BUFFER,e.getParameter(e.ARRAY_BUFFER_BINDING)),t.boundBuffers.set(e.ELEMENT_ARRAY_BUFFER,e.getParameter(e.ELEMENT_ARRAY_BUFFER_BINDING)),t.currentProgram=e.getParameter(e.CURRENT_PROGRAM),t.blendEnabled=e.getParameter(e.BLEND)},tr=function(){function t(e){ve(this,t),this.gl=e,this.contextAttributes=e.getContextAttributes(),this.currentBlendMode=null,this.boundBuffers=new Map,$e(this,e),this.boundTextures=new Array(this.MAX_TEXTURE_IMAGE_UNITS);for(var r=0;r<this.boundTextures.length;r++)this.boundTextures[r]={TEXTURE_2D:null};this.textureUnitManager=new Ze(this),this.enabledVertexAttribLocations=[],this.activeTexture(0)}return pe(t,[{key:"bindBuffer",value:function(t,e){this.boundBuffers.get(t)!==e&&(this.gl.bindBuffer(t,e),this.boundBuffers.set(t,e))}},{key:"activeTexture",value:function(t){var e=this.gl,r=e.TEXTURE0+t;this.activeTexUnit!==r&&(this.activeTexUnit=r,e.activeTexture(this.activeTexUnit))}},{key:"bindTexture2d",value:function(t){var e=this.gl,r=this.boundTextures[this.activeTexUnit-e.TEXTURE0];r.TEXTURE_2D!==t&&(r.TEXTURE_2D=t,e.bindTexture(e.TEXTURE_2D,t))}},{key:"useProgram",value:function(t){return this.currentProgram!==t&&(this.gl.useProgram(t),this.currentProgram=t,!0)}},{key:"enableVertexAttribArrays",value:function(t){var e=this,r=this.gl;this.enabledVertexAttribLocations.filter(function(e){return-1===t.indexOf(e)}).forEach(function(n){r.disableVertexAttribArray(n),e.enabledVertexAttribLocations.splice(t.indexOf(n),1)}),t.forEach(function(t){-1===e.enabledVertexAttribLocations.indexOf(t)&&(r.enableVertexAttribArray(t),e.enabledVertexAttribLocations.push(t))})}},{key:"blend",value:function(t){if(t!==this.currentBlendMode){this.currentBlendMode=t;var e=this.gl;t.enable?(this.blendEnabled||(e.enable(e.BLEND),this.blendEnabled=!0),e.blendFunc(e[t.sfactor],e[t.dfactor])):this.blendEnabled&&(e.disable(e.BLEND),this.blendEnabled=!1)}}}]),t}(),er=function(t){function e(t){var r;return ve(this,e),(r=Ee(this,be(e).call(this,t))).isWebGL1=!0,r.ANGLE_instanced_arrays=t.getExtension("ANGLE_instanced_arrays"),r}return ye(e,tr),pe(e,[{key:"vertexAttribDivisor",value:function(t,e){this.ANGLE_instanced_arrays.vertexAttribDivisorANGLE(t,e)}},{key:"drawElementsInstanced",value:function(t,e,r,n,i){this.ANGLE_instanced_arrays.drawElementsInstancedANGLE(t,e,r,n,i)}}]),e}(),rr=function(t){function e(t){var r;return ve(this,e),(r=Ee(this,be(e).call(this,t))).isWebGL2=!0,r}return ye(e,tr),pe(e,[{key:"vertexAttribDivisor",value:function(t,e){this.gl.vertexAttribDivisor(t,e)}},{key:"drawElementsInstanced",value:function(t,e,r,n,i){this.gl.drawElementsInstanced(t,e,r,n,i)}}]),e}(),nr=function(t,r){var n,i=function(t){return{alpha:e.readOption(t,"alpha",!1),depth:e.readOption(t,"depth",!0),stencil:e.readOption(t,"stencil",!0),antialias:e.readOption(t,"antialias",!1),premultipliedAlpha:e.readOption(t,"premultipliedAlpha",!0),preserveDrawingBuffer:e.readOption(t,"preserveDrawingBuffer",!1),preferLowPowerToHighPerformance:e.readOption(t,"preferLowPowerToHighPerformance",!1),failIfMajorPerformanceCaveat:e.readOption(t,"failIfMajorPerformanceCaveat",!1)}}(r);if(!e.readOption(r,"disableWebGL2",!1)&&(n=t.getContext("webgl2",i)))return new rr(n);if(null==(n=t.getContext("webgl",i)||t.getContext("experimental-webgl",i)))throw Error("createWebGlContext: could not create webgl context with attributes: ".concat(JSON.stringify(i)));return new er(n)},ir=function(){function t(e,r,n,i){ve(this,t),this.glx=e;var o=e.gl;this.target=o[r],this.usage=o[n],this.typedArray=i,this.clonedTypedArray=void 0,this.lastTypedArray=void 0,this.glBuffer=o.createBuffer()}return pe(t,[{key:"bindBuffer",value:function(){this.glx.bindBuffer(this.target,this.glBuffer)}},{key:"bufferData",value:function(t){this.bindBuffer(),this.glx.gl.bufferData(this.target,t||this.typedArray,this.usage)}},{key:"doubleBufferData",value:function(t){var e=t||this.typedArray;void 0===this.clonedTypedArray||e!==this.lastTypedArray?(this.clonedTypedArray=new e.constructor(e.length),this.clonedTypedArray.set(e),this.lastTypedArray=e):this.clonedTypedArray.set(e),this.bufferData(this.clonedTypedArray)}},{key:"deleteBuffer",value:function(){this.glx.gl.deleteBuffer(this.glBuffer)}}]),t}();ir.ARRAY_BUFFER="ARRAY_BUFFER",ir.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",ir.STATIC_DRAW="STATIC_DRAW",ir.DYNAMIC_DRAW="DYNAMIC_DRAW";var or=n.getLogger("picimo.renderer.WebGlShader"),ar=function t(e,n){if(ve(this,t),this.glx=e,!(n instanceof r.ShaderSource))throw new Error("WebGlShader panic! source must be an instance of ShaderSource!");this.source=n;var i=e.gl;this.shaderType=i[n.type],this.glShader=i.createShader(this.shaderType),function(t){var e=t.glx.gl,r=t.glShader,n=t.source.compile({glx:t.glx});if(e.shaderSource(r,n),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){var i=e.getShaderInfoLog(r);throw or.debug("WebGlShader: vertex shader source =>\n".concat(n)),new Error("WebGlShader: gl.compileShader(..) panic!\n".concat(i))}}(this)},ur=[].slice,sr={},fr=Function.bind||function(t){var e=D(this),r=ur.call(arguments,1),n=function(){var i=r.concat(ur.call(arguments));return this instanceof n?function(t,e,r){if(!(e in sr)){for(var n=[],i=0;i<e;i++)n[i]="a["+i+"]";sr[e]=Function("F,a","return new F("+n.join(",")+")")}return sr[e](t,r)}(e,i.length,i):function(t,e,r){var n=void 0===r;switch(e.length){case 0:return n?t():t.call(r);case 1:return n?t(e[0]):t.call(r,e[0]);case 2:return n?t(e[0],e[1]):t.call(r,e[0],e[1]);case 3:return n?t(e[0],e[1],e[2]):t.call(r,e[0],e[1],e[2]);case 4:return n?t(e[0],e[1],e[2],e[3]):t.call(r,e[0],e[1],e[2],e[3])}return t.apply(r,e)}(e,i,t)};return h(e.prototype)&&(n.prototype=e.prototype),n};W(W.P,"Function",{bind:fr});var cr=x.f,lr=Function.prototype,hr=/^\s*function ([^ (]*)/;"name"in lr||g&&cr(lr,"name",{configurable:!0,get:function(){try{return(""+this).match(hr)[1]}catch(t){return""}}});var dr=function t(e,r){ve(this,t),this.program=e,this.glx=e.glx;var n=e.glx.gl,i=e.glProgram,o=n.getActiveUniform(i,r),a=o.name,u=o.size,s=o.type;this.name=a,this.size=u,this.type=s,this.location=n.getUniformLocation(i,a),this.setValue=function(t){var e=t.type,r=t.location,n=t.glx.gl;switch(e){case n.FLOAT:return function(t){return n.uniform1f(r,t)};case n.FLOAT_VEC2:return function(t){return n.uniform2f(r,t[0],t[1])};case n.FLOAT_VEC3:return function(t){return n.uniform3f(r,t[0],t[1],t[2])};case n.FLOAT_VEC4:return function(t){return n.uniform4f(r,t[0],t[1],t[2],t[3])};case n.FLOAT_MAT4:return function(t){return n.uniformMatrix4fv(r,n.FALSE,t.mat4)};case n.SAMPLER_2D:return function(t){return n.uniform1i(r,t)};default:throw new Error("WebGlUniform: unknown uniform type:".concat(e))}}(this)},vr={float32:"FLOAT",int16:"SHORT",int32:"INT",int8:"BYTE",uint16:"UNSIGNED_SHORT",uint32:"UNSIGNED_INT",uint8:"UNSIGNED_BYTE"},gr=function(){function t(e,r){ve(this,t),this.program=e,this.glx=e.glx;var n=e.glx.gl,i=e.glProgram,o=n.getActiveAttrib(i,r),a=o.name,u=o.size,s=o.type;this.name=a,this.size=u,this.type=s,this.location=n.getAttribLocation(i,a)}return pe(t,[{key:"vertexAttribPointer",value:function(t){var e=this.glx.gl,r=t.attr[this.name],n=function(t,e){return t[vr[e]]}(e,r.type);e.vertexAttribPointer(this.location,r.size,n,!1,t.bytesPerVertex,r.byteOffset),t.isInstanced&&this.glx.vertexAttribDivisor(this.location,1)}}]),t}(),pr=n.getLogger("picimo.renderer.WebGlProgram");var yr=function(){function t(e,r,n){ve(this,t),this.glx=e,this.vertexShader=r,this.fragmentShader=n;var i=e.gl;this.glProgram=i.createProgram(),function(t,e,r){var n=t.glx.gl,i=t.glProgram;if(n.attachShader(i,e),n.attachShader(i,r),n.linkProgram(i),!n.getProgramParameter(i,n.LINK_STATUS))throw new Error("WebGlProgram: link panic!")}(this,this.vertexShader.glShader,this.fragmentShader.glShader),function(t){var e=t.glx.gl,r=e.getProgramParameter(t.glProgram,e.ACTIVE_UNIFORMS);t.uniforms={},t.uniformNames=[];for(var n=0;n<r;++n){var i=new dr(t,n);t.uniforms[i.name]=i,t.uniformNames.push(i.name)}}(this),function(t){var e=t.glx.gl,r=e.getProgramParameter(t.glProgram,e.ACTIVE_ATTRIBUTES);t.attributes={},t.attributeNames=[],t.attributeLocations=[];for(var n=0;n<r;++n){var i=new gr(t,n);t.attributes[i.name]=i,t.attributeNames.push(i.name),t.attributeLocations.push(i.location)}}(this)}return pe(t,[{key:"use",value:function(){var t=this.glx;return!!t.useProgram(this.glProgram)&&(t.enableVertexAttribArrays(this.attributeLocations),!0)}},{key:"loadUniforms",value:function(t,e){var r=this,n=!0;return this.uniformNames.forEach(function(i){var o=t.curUniform(i);if(null==o){if(!(o=t.curTex2d(i)))return pr.error("WebGlProgram: could not load uniform:",i),void(n=!1);var a=o.texture;a&&(o.data=e.syncTexture(a).bind())}r.uniforms[i].setValue(o.data)}),n}},{key:"loadAttributes",value:function(t,e){var r=this,n=!0;return this.attributeNames.forEach(function(i){var o=t.curAttrib(i);if(o){var a=o.data;e.syncBuffer(a).bindBuffer(),r.attributes[i].vertexAttribPointer(a.descriptor)}else pr.error("WebGlProgram: could not load attribute:",i),n=!1}),n}}]),t}(),br=function(){function t(e,r){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];ve(this,t),this.glx=e,this.imgEl=r,this.flipY=n,this.repeatable=i,this.premultiplyAlpha=o,this.nearest=a,this.isInitialized=!1,this.glTexObj=e.gl.createTexture(),this.texUnit=-1}return pe(t,[{key:"bind",value:function(){return this.glx.textureUnitManager.bindWebGlTexture(this)}},{key:"uploadImageData",value:function(){if(null!=this.imgEl){this.isInitialized||(!function(t){var e=t.glx.gl;t.bind(),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha);var r=t.repeatable?e.REPEAT:e.CLAMP_TO_EDGE;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,r);var n=t.nearest?e.NEAREST:e.LINEAR;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.imgEl.width,t.imgEl.height,0,e.RGBA,e.UNSIGNED_BYTE,null)}(this),this.isInitialized=!0),this.bind();var t=this.glx.gl;t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.imgEl)}}}]),t}(),mr={static:ir.STATIC_DRAW,dynamic:ir.DYNAMIC_DRAW},Er=function(t,e,r){var n=t.get(e.id);return n||(n=r(e),t.set(e.id,n)),n},_r=n.getLogger("picimo.renderer.WebGlResourceLibrary"),xr=function(){function t(e){ve(this,t),this.glx=e,this.vertexShader=new Map,this.fragmentShader=new Map,this.shaderProgram=new Map,this.buffer=new Map,this.texture=new Map}return pe(t,[{key:"loadBuffer",value:function(t){var n=this;return Er(this.buffer,t,function(){if("VOArray"===t.type||"ElementIndexArray"===t.type){var i=e.readOption(t.hints,"target",ir.ARRAY_BUFFER),o=e.readOption(t.hints,"usage","dynamic"),a=e.readOption(t.hints,"typedArray"),u=new ir(n.glx,i,mr[o],a);return new r.DataRef("WebGlBuffer",u,{id:t.id,serial:0})}_r.warn('WebGlResourceLibrary.loadBuffer() ref.type="'.concat(t.type,'" mismatch! (should be "VOArray" or "ElementIndexArray")'))})}},{key:"findBuffer",value:function(t){return this.buffer.get(t.id)}},{key:"freeBuffer",value:function(t){var e=this.findBuffer(t);e&&(this.buffer.delete(e.id),e.data.deleteBuffer())}},{key:"loadVertexShader",value:function(t){var e=this;return Er(this.vertexShader,t,function(){return new ar(e.glx,t)})}},{key:"loadFragementShader",value:function(t){var e=this;return Er(this.fragmentShader,t,function(){return new ar(e.glx,t)})}},{key:"loadProgram",value:function(t){var e=this;return Er(this.shaderProgram,t,function(){var r=e.loadVertexShader(t.vertexShader),n=e.loadFragementShader(t.fragmentShader);return new yr(e.glx,r,n)})}},{key:"loadTexture",value:function(t){var e=this.texture.get(t.id);if(!e){var n=new br(this.glx,t.data.imgEl,t.hints.flipY,t.hints.repeatable,t.hints.premultiplyAlpha,t.hints.nearest);e=new r.DataRef("WebGlTexture",n,{id:t.id,serial:0}),this.texture.set(t.id,e)}return e}}]),t}(),Ar=function(t){if("CANVAS"===t.tagName)return t;var e=document.createElement("canvas");return t.appendChild(e),e},Tr=function(t){var e=t.universalContext.get("blend");e&&t.glx.blend(e)},wr=function(){function t(n,i){ve(this,t),this.domElement=n,this.canvas=Ar(n),this.glx=nr(this.canvas,i),this.resources=new xr(this.glx),this.shaderContext=new r.ShaderContext,this.universalContext=new r.StackedContext,this.now=0,this.lastFrameTime=0,this.frameNo=0,this.timeFrameOffset=0,this._pixelRatio=e.readOption(i,"pixelRatio"),this._touchedWithinFrame=new Set,this.shaderGlobals=new r.ShaderUniformGroup({time:0,resolution:[0,0],projection:new r.Projection({pixelRatio:1})}),this.resize()}return pe(t,[{key:"pushBlendMode",value:function(t){var e=t instanceof Ae?t:Ae.make(t);return this.universalContext.push("blend",e)}},{key:"popBlendMode",value:function(t){return this.universalContext.pop("blend",t)}},{key:"resize",value:function(){var t=this.canvas,e=this.domElement,r=window.getComputedStyle(t,null),n=(("inline"===r.display||""===r.display)&&e===t?e.parentNode:e)||{clientWidth:t.width,clientHeight:t.height},i=n.clientWidth,o=n.clientHeight;t.style.width="".concat(i,"px"),t.style.height="".concat(o,"px");var a=this.pixelRatio,u=Math.round(i*a),s=Math.round(o*a);u===t.width&&s===t.height||(t.width=u,t.height=s),u===this.width&&s===this.height||(this.width=u,this.height=s,this.shaderGlobals.resolution=[u,s],this.shaderGlobals.projectionUniform.update(u,s))}},{key:"readPixels",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=this.gl,r=e.drawingBufferWidth,n=e.drawingBufferHeight,i=new Uint8Array(r*n*4);return e.readPixels(0,0,r,n,e.RGBA,e.UNSIGNED_BYTE,i),t&&Array.from({length:n},function(t,e){return i.slice(e*r*4,(e+1)*r*4)}).forEach(function(t,e){return i.set(t,(n-e-1)*r*4)}),new ImageData(Uint8ClampedArray.from(i),r,n)}},{key:"initFrame",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.performance.now();++this.frameNo,this.now=t/1e3,1!==this.frameNo&&(this.timeFrameOffset=this.now-this.lastFrameTime),this.lastFrameTime=this.now,this.shaderGlobals.time=this.now,this._touchedWithinFrame.clear(),this.universalContext.clear(),this.pushBlendMode("orderDependent"),this.shaderContext.clear(),this.shaderGlobals.pushVar(this.shaderContext),this.glx.gl.viewport(0,0,this.width,this.height)}},{key:"syncBuffer",value:function(t){var e=t.ref;e.hasHint("autotouch",!0)&&function(t,e){e.has(t.id)||(e.add(t.id),t.touch())}(e,this._touchedWithinFrame);var r=this.resources.loadBuffer(e);return r.sync(e,function(t){e.hasHint("doubleBuffer",!0)?t.doubleBufferData():t.bufferData()}),r.data}},{key:"syncTexture",value:function(t){var e=t.ref,r=this.resources.loadTexture(e);return r.sync(e,function(t){return t.uploadImageData()}),r.data}},{key:"useShaderProgram",value:function(t){var e=this.resources.loadProgram(t),r=this.shaderContext,n=e.use(),i=e.loadUniforms(r,this),o=e.loadAttributes(r,this);return n&&i&&o}},{key:"drawArrays",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;Tr(this);var n=this.glx.gl;n.drawArrays(n[t],r,e)}},{key:"drawIndexed",value:function(t,e,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;Tr(this),this.syncBuffer(e).bindBuffer();var i=this.glx.gl;i.drawElements(i[t],r||e.length,i.UNSIGNED_SHORT,n*e.array.BYTES_PER_ELEMENT)}},{key:"drawIndexedInstanced",value:function(t,e,r,n,i){Tr(this),this.syncBuffer(e).bindBuffer();var o=this.glx,a=o.gl;o.drawElementsInstanced(a[t],r||e.length,a.UNSIGNED_SHORT,n*e.array.BYTES_PER_ELEMENT,i)}},{key:"drawPrimitive",value:function(t,e,r){var n=t.primitiveType,i=t.elementIndexArray,o=i.itemCount;this.drawIndexed(n,i,e*o,r*o)}},{key:"drawPrimitiveIndexed",value:function(t,e,r,n){var i=t.primitiveType,o=t.elementIndexArray,a=o.itemCount;this.drawIndexedInstanced(i,o,e*a,r*a,n)}},{key:"drawSpriteGroup",value:function(t){var e=this,n=function(){var r=t.base;r&&(e.syncBuffer(r.voPool.voArray),e.shaderContext.pushVar(r.voPoolShaderAttribs)),e.syncBuffer(t.voPool.voArray),e.shaderContext.pushVar(t.voPoolShaderAttribs),e.useShaderProgram(t.shaderProgram),r?e.drawPrimitiveIndexed(r.primitive,r.usedCount,0,t.usedCount):e.drawPrimitive(t.primitive,t.usedCount,0)};t instanceof r.TexturedSpriteGroup?t.whenTexturesLoaded(function(t){e.shaderContext.pushVar(t),n()}):n()}},{key:"pixelRatio",get:function(){return this._pixelRatio||window.devicePixelRatio||1}}]),t}();t.BlendMode=Ae,t.WebGlRenderer=wr,t.WebGlTexture=br,t.WebGlBuffer=ir,t.WebGlResourceLibrary=xr,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=picimo-renderer.js.map
