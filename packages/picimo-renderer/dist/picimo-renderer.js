import{readOption}from"@picimo/utils";import{ShaderSource,DataRef,Projection,ShaderContext,ShaderUniformGroup,StackedContext,TexturedSpriteGroup}from"@picimo/core";import{getLogger}from"loglevel";function createCommonjsModule(t,e){return t(e={exports:{}},e.exports),e.exports}var _core=createCommonjsModule(function(t){var e=t.exports={version:"2.5.7"};"number"==typeof __e&&(__e=e)}),_core_1=_core.version,_global=createCommonjsModule(function(t){var e=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=e)}),_library=!1,_shared=createCommonjsModule(function(t){var e=_global["__core-js_shared__"]||(_global["__core-js_shared__"]={});(t.exports=function(t,r){return e[t]||(e[t]=void 0!==r?r:{})})("versions",[]).push({version:_core.version,mode:"global",copyright:"Â© 2018 Denis Pushkarev (zloirock.ru)"})}),id=0,px=Math.random(),_uid=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++id+px).toString(36))},_wks=createCommonjsModule(function(t){var e=_shared("wks"),r=_global.Symbol,n="function"==typeof r;(t.exports=function(t){return e[t]||(e[t]=n&&r[t]||(n?r:_uid)("Symbol."+t))}).store=e}),_isObject=function(t){return"object"==typeof t?null!==t:"function"==typeof t},_anObject=function(t){if(!_isObject(t))throw TypeError(t+" is not an object!");return t},_fails=function(t){try{return!!t()}catch(t){return!0}},_descriptors=!_fails(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),document$1=_global.document,is=_isObject(document$1)&&_isObject(document$1.createElement),_domCreate=function(t){return is?document$1.createElement(t):{}},_ie8DomDefine=!_descriptors&&!_fails(function(){return 7!=Object.defineProperty(_domCreate("div"),"a",{get:function(){return 7}}).a}),_toPrimitive=function(t,e){if(!_isObject(t))return t;var r,n;if(e&&"function"==typeof(r=t.toString)&&!_isObject(n=r.call(t)))return n;if("function"==typeof(r=t.valueOf)&&!_isObject(n=r.call(t)))return n;if(!e&&"function"==typeof(r=t.toString)&&!_isObject(n=r.call(t)))return n;throw TypeError("Can't convert object to primitive value")},dP=Object.defineProperty,f=_descriptors?Object.defineProperty:function(t,e,r){if(_anObject(t),e=_toPrimitive(e,!0),_anObject(r),_ie8DomDefine)try{return dP(t,e,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[e]=r.value),t},_objectDp={f:f},_propertyDesc=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},_hide=_descriptors?function(t,e,r){return _objectDp.f(t,e,_propertyDesc(1,r))}:function(t,e,r){return t[e]=r,t},UNSCOPABLES=_wks("unscopables"),ArrayProto=Array.prototype;null==ArrayProto[UNSCOPABLES]&&_hide(ArrayProto,UNSCOPABLES,{});var _addToUnscopables=function(t){ArrayProto[UNSCOPABLES][t]=!0},_iterStep=function(t,e){return{value:e,done:!!t}},_iterators={},toString={}.toString,_cof=function(t){return toString.call(t).slice(8,-1)},_iobject=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==_cof(t)?t.split(""):Object(t)},_defined=function(t){if(null==t)throw TypeError("Can't call method on  "+t);return t},_toIobject=function(t){return _iobject(_defined(t))},hasOwnProperty={}.hasOwnProperty,_has=function(t,e){return hasOwnProperty.call(t,e)},_redefine=createCommonjsModule(function(t){var e=_uid("src"),r=Function.toString,n=(""+r).split("toString");_core.inspectSource=function(t){return r.call(t)},(t.exports=function(t,r,i,o){var a="function"==typeof i;a&&(_has(i,"name")||_hide(i,"name",r)),t[r]!==i&&(a&&(_has(i,e)||_hide(i,e,t[r]?""+t[r]:n.join(String(r)))),t===_global?t[r]=i:o?t[r]?t[r]=i:_hide(t,r,i):(delete t[r],_hide(t,r,i)))})(Function.prototype,"toString",function(){return"function"==typeof this&&this[e]||r.call(this)})}),_aFunction=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t},_ctx=function(t,e,r){if(_aFunction(t),void 0===e)return t;switch(r){case 1:return function(r){return t.call(e,r)};case 2:return function(r,n){return t.call(e,r,n)};case 3:return function(r,n,i){return t.call(e,r,n,i)}}return function(){return t.apply(e,arguments)}},PROTOTYPE="prototype",$export=function(t,e,r){var n,i,o,a,s=t&$export.F,u=t&$export.G,c=t&$export.S,l=t&$export.P,f=t&$export.B,h=u?_global:c?_global[e]||(_global[e]={}):(_global[e]||{})[PROTOTYPE],_=u?_core:_core[e]||(_core[e]={}),d=_[PROTOTYPE]||(_[PROTOTYPE]={});for(n in u&&(r=e),r)o=((i=!s&&h&&void 0!==h[n])?h:r)[n],a=f&&i?_ctx(o,_global):l&&"function"==typeof o?_ctx(Function.call,o):o,h&&_redefine(h,n,o,t&$export.U),_[n]!=o&&_hide(_,n,a),l&&d[n]!=o&&(d[n]=o)};_global.core=_core,$export.F=1,$export.G=2,$export.S=4,$export.P=8,$export.B=16,$export.W=32,$export.U=64,$export.R=128;var _export=$export,ceil=Math.ceil,floor=Math.floor,_toInteger=function(t){return isNaN(t=+t)?0:(t>0?floor:ceil)(t)},min=Math.min,_toLength=function(t){return t>0?min(_toInteger(t),9007199254740991):0},max=Math.max,min$1=Math.min,_toAbsoluteIndex=function(t,e){return(t=_toInteger(t))<0?max(t+e,0):min$1(t,e)},_arrayIncludes=function(t){return function(e,r,n){var i,o=_toIobject(e),a=_toLength(o.length),s=_toAbsoluteIndex(n,a);if(t&&r!=r){for(;a>s;)if((i=o[s++])!=i)return!0}else for(;a>s;s++)if((t||s in o)&&o[s]===r)return t||s||0;return!t&&-1}},shared=_shared("keys"),_sharedKey=function(t){return shared[t]||(shared[t]=_uid(t))},arrayIndexOf=_arrayIncludes(!1),IE_PROTO=_sharedKey("IE_PROTO"),_objectKeysInternal=function(t,e){var r,n=_toIobject(t),i=0,o=[];for(r in n)r!=IE_PROTO&&_has(n,r)&&o.push(r);for(;e.length>i;)_has(n,r=e[i++])&&(~arrayIndexOf(o,r)||o.push(r));return o},_enumBugKeys="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),_objectKeys=Object.keys||function(t){return _objectKeysInternal(t,_enumBugKeys)},_objectDps=_descriptors?Object.defineProperties:function(t,e){_anObject(t);for(var r,n=_objectKeys(e),i=n.length,o=0;i>o;)_objectDp.f(t,r=n[o++],e[r]);return t},document$2=_global.document,_html=document$2&&document$2.documentElement,IE_PROTO$1=_sharedKey("IE_PROTO"),Empty=function(){},PROTOTYPE$1="prototype",createDict=function(){var t,e=_domCreate("iframe"),r=_enumBugKeys.length;for(e.style.display="none",_html.appendChild(e),e.src="javascript:",(t=e.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),createDict=t.F;r--;)delete createDict[PROTOTYPE$1][_enumBugKeys[r]];return createDict()},_objectCreate=Object.create||function(t,e){var r;return null!==t?(Empty[PROTOTYPE$1]=_anObject(t),r=new Empty,Empty[PROTOTYPE$1]=null,r[IE_PROTO$1]=t):r=createDict(),void 0===e?r:_objectDps(r,e)},def=_objectDp.f,TAG=_wks("toStringTag"),_setToStringTag=function(t,e,r){t&&!_has(t=r?t:t.prototype,TAG)&&def(t,TAG,{configurable:!0,value:e})},IteratorPrototype={};_hide(IteratorPrototype,_wks("iterator"),function(){return this});var _iterCreate=function(t,e,r){t.prototype=_objectCreate(IteratorPrototype,{next:_propertyDesc(1,r)}),_setToStringTag(t,e+" Iterator")},_toObject=function(t){return Object(_defined(t))},IE_PROTO$2=_sharedKey("IE_PROTO"),ObjectProto=Object.prototype,_objectGpo=Object.getPrototypeOf||function(t){return t=_toObject(t),_has(t,IE_PROTO$2)?t[IE_PROTO$2]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?ObjectProto:null},ITERATOR=_wks("iterator"),BUGGY=!([].keys&&"next"in[].keys()),FF_ITERATOR="@@iterator",KEYS="keys",VALUES="values",returnThis=function(){return this},_iterDefine=function(t,e,r,n,i,o,a){_iterCreate(r,e,n);var s,u,c,l=function(t){if(!BUGGY&&t in d)return d[t];switch(t){case KEYS:case VALUES:return function(){return new r(this,t)}}return function(){return new r(this,t)}},f=e+" Iterator",h=i==VALUES,_=!1,d=t.prototype,p=d[ITERATOR]||d[FF_ITERATOR]||i&&d[i],g=p||l(i),y=i?h?l("entries"):g:void 0,v="Array"==e&&d.entries||p;if(v&&(c=_objectGpo(v.call(new t)))!==Object.prototype&&c.next&&(_setToStringTag(c,f,!0),_library||"function"==typeof c[ITERATOR]||_hide(c,ITERATOR,returnThis)),h&&p&&p.name!==VALUES&&(_=!0,g=function(){return p.call(this)}),_library&&!a||!BUGGY&&!_&&d[ITERATOR]||_hide(d,ITERATOR,g),_iterators[e]=g,_iterators[f]=returnThis,i)if(s={values:h?g:l(VALUES),keys:o?g:l(KEYS),entries:y},a)for(u in s)u in d||_redefine(d,u,s[u]);else _export(_export.P+_export.F*(BUGGY||_),e,s);return s},es6_array_iterator=_iterDefine(Array,"Array",function(t,e){this._t=_toIobject(t),this._i=0,this._k=e},function(){var t=this._t,e=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,_iterStep(1)):_iterStep(0,"keys"==e?r:"values"==e?t[r]:[r,t[r]])},"values");_iterators.Arguments=_iterators.Array,_addToUnscopables("keys"),_addToUnscopables("values"),_addToUnscopables("entries");for(var ITERATOR$1=_wks("iterator"),TO_STRING_TAG=_wks("toStringTag"),ArrayValues=_iterators.Array,DOMIterables={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},collections=_objectKeys(DOMIterables),i=0;i<collections.length;i++){var key,NAME=collections[i],explicit=DOMIterables[NAME],Collection=_global[NAME],proto=Collection&&Collection.prototype;if(proto&&(proto[ITERATOR$1]||_hide(proto,ITERATOR$1,ArrayValues),proto[TO_STRING_TAG]||_hide(proto,TO_STRING_TAG,NAME),_iterators[NAME]=ArrayValues,explicit))for(key in es6_array_iterator)proto[key]||_redefine(proto,key,es6_array_iterator[key],!0)}var _stringAt=function(t){return function(e,r){var n,i,o=String(_defined(e)),a=_toInteger(r),s=o.length;return a<0||a>=s?t?"":void 0:(n=o.charCodeAt(a))<55296||n>56319||a+1===s||(i=o.charCodeAt(a+1))<56320||i>57343?t?o.charAt(a):n:t?o.slice(a,a+2):i-56320+(n-55296<<10)+65536}},$at=_stringAt(!0);_iterDefine(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,e=this._t,r=this._i;return r>=e.length?{value:void 0,done:!0}:(t=$at(e,r),this._i+=t.length,{value:t,done:!1})});var _redefineAll=function(t,e,r){for(var n in e)_redefine(t,n,e[n],r);return t},_anInstance=function(t,e,r,n){if(!(t instanceof e)||void 0!==n&&n in t)throw TypeError(r+": incorrect invocation!");return t},_iterCall=function(t,e,r,n){try{return n?e(_anObject(r)[0],r[1]):e(r)}catch(e){var i=t.return;throw void 0!==i&&_anObject(i.call(t)),e}},ITERATOR$2=_wks("iterator"),ArrayProto$1=Array.prototype,_isArrayIter=function(t){return void 0!==t&&(_iterators.Array===t||ArrayProto$1[ITERATOR$2]===t)},TAG$1=_wks("toStringTag"),ARG="Arguments"==_cof(function(){return arguments}()),tryGet=function(t,e){try{return t[e]}catch(t){}},_classof=function(t){var e,r,n;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=tryGet(e=Object(t),TAG$1))?r:ARG?_cof(e):"Object"==(n=_cof(e))&&"function"==typeof e.callee?"Arguments":n},ITERATOR$3=_wks("iterator"),core_getIteratorMethod=_core.getIteratorMethod=function(t){if(null!=t)return t[ITERATOR$3]||t["@@iterator"]||_iterators[_classof(t)]},_forOf=createCommonjsModule(function(t){var e={},r={},n=t.exports=function(t,n,i,o,a){var s,u,c,l,f=a?function(){return t}:core_getIteratorMethod(t),h=_ctx(i,o,n?2:1),_=0;if("function"!=typeof f)throw TypeError(t+" is not iterable!");if(_isArrayIter(f)){for(s=_toLength(t.length);s>_;_++)if((l=n?h(_anObject(u=t[_])[0],u[1]):h(t[_]))===e||l===r)return l}else for(c=f.call(t);!(u=c.next()).done;)if((l=_iterCall(c,h,u.value,n))===e||l===r)return l};n.BREAK=e,n.RETURN=r}),SPECIES=_wks("species"),_setSpecies=function(t){var e=_global[t];_descriptors&&e&&!e[SPECIES]&&_objectDp.f(e,SPECIES,{configurable:!0,get:function(){return this}})},_meta=createCommonjsModule(function(t){var e=_uid("meta"),r=_objectDp.f,n=0,i=Object.isExtensible||function(){return!0},o=!_fails(function(){return i(Object.preventExtensions({}))}),a=function(t){r(t,e,{value:{i:"O"+ ++n,w:{}}})},s=t.exports={KEY:e,NEED:!1,fastKey:function(t,r){if(!_isObject(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!_has(t,e)){if(!i(t))return"F";if(!r)return"E";a(t)}return t[e].i},getWeak:function(t,r){if(!_has(t,e)){if(!i(t))return!0;if(!r)return!1;a(t)}return t[e].w},onFreeze:function(t){return o&&s.NEED&&i(t)&&!_has(t,e)&&a(t),t}}}),_meta_1=_meta.KEY,_meta_2=_meta.NEED,_meta_3=_meta.fastKey,_meta_4=_meta.getWeak,_meta_5=_meta.onFreeze,_validateCollection=function(t,e){if(!_isObject(t)||t._t!==e)throw TypeError("Incompatible receiver, "+e+" required!");return t},dP$1=_objectDp.f,fastKey=_meta.fastKey,SIZE=_descriptors?"_s":"size",getEntry=function(t,e){var r,n=fastKey(e);if("F"!==n)return t._i[n];for(r=t._f;r;r=r.n)if(r.k==e)return r},_collectionStrong={getConstructor:function(t,e,r,n){var i=t(function(t,o){_anInstance(t,i,e,"_i"),t._t=e,t._i=_objectCreate(null),t._f=void 0,t._l=void 0,t[SIZE]=0,null!=o&&_forOf(o,r,t[n],t)});return _redefineAll(i.prototype,{clear:function(){for(var t=_validateCollection(this,e),r=t._i,n=t._f;n;n=n.n)n.r=!0,n.p&&(n.p=n.p.n=void 0),delete r[n.i];t._f=t._l=void 0,t[SIZE]=0},delete:function(t){var r=_validateCollection(this,e),n=getEntry(r,t);if(n){var i=n.n,o=n.p;delete r._i[n.i],n.r=!0,o&&(o.n=i),i&&(i.p=o),r._f==n&&(r._f=i),r._l==n&&(r._l=o),r[SIZE]--}return!!n},forEach:function(t){_validateCollection(this,e);for(var r,n=_ctx(t,arguments.length>1?arguments[1]:void 0,3);r=r?r.n:this._f;)for(n(r.v,r.k,this);r&&r.r;)r=r.p},has:function(t){return!!getEntry(_validateCollection(this,e),t)}}),_descriptors&&dP$1(i.prototype,"size",{get:function(){return _validateCollection(this,e)[SIZE]}}),i},def:function(t,e,r){var n,i,o=getEntry(t,e);return o?o.v=r:(t._l=o={i:i=fastKey(e,!0),k:e,v:r,p:n=t._l,n:void 0,r:!1},t._f||(t._f=o),n&&(n.n=o),t[SIZE]++,"F"!==i&&(t._i[i]=o)),t},getEntry:getEntry,setStrong:function(t,e,r){_iterDefine(t,e,function(t,r){this._t=_validateCollection(t,e),this._k=r,this._l=void 0},function(){for(var t=this._k,e=this._l;e&&e.r;)e=e.p;return this._t&&(this._l=e=e?e.n:this._t._f)?_iterStep(0,"keys"==t?e.k:"values"==t?e.v:[e.k,e.v]):(this._t=void 0,_iterStep(1))},r?"entries":"values",!r,!0),_setSpecies(e)}},ITERATOR$4=_wks("iterator"),SAFE_CLOSING=!1;try{var riter=[7][ITERATOR$4]();riter.return=function(){SAFE_CLOSING=!0}}catch(t){}var _iterDetect=function(t,e){if(!e&&!SAFE_CLOSING)return!1;var r=!1;try{var n=[7],i=n[ITERATOR$4]();i.next=function(){return{done:r=!0}},n[ITERATOR$4]=function(){return i},t(n)}catch(t){}return r},f$1={}.propertyIsEnumerable,_objectPie={f:f$1},gOPD=Object.getOwnPropertyDescriptor,f$2=_descriptors?gOPD:function(t,e){if(t=_toIobject(t),e=_toPrimitive(e,!0),_ie8DomDefine)try{return gOPD(t,e)}catch(t){}if(_has(t,e))return _propertyDesc(!_objectPie.f.call(t,e),t[e])},_objectGopd={f:f$2},check=function(t,e){if(_anObject(t),!_isObject(e)&&null!==e)throw TypeError(e+": can't set as prototype!")},_setProto={set:Object.setPrototypeOf||("__proto__"in{}?function(t,e,r){try{(r=_ctx(Function.call,_objectGopd.f(Object.prototype,"__proto__").set,2))(t,[]),e=!(t instanceof Array)}catch(t){e=!0}return function(t,n){return check(t,n),e?t.__proto__=n:r(t,n),t}}({},!1):void 0),check:check},setPrototypeOf=_setProto.set,_inheritIfRequired=function(t,e,r){var n,i=e.constructor;return i!==r&&"function"==typeof i&&(n=i.prototype)!==r.prototype&&_isObject(n)&&setPrototypeOf&&setPrototypeOf(t,n),t},_collection=function(t,e,r,n,i,o){var a=_global[t],s=a,u=i?"set":"add",c=s&&s.prototype,l={},f=function(t){var e=c[t];_redefine(c,t,"delete"==t?function(t){return!(o&&!_isObject(t))&&e.call(this,0===t?0:t)}:"has"==t?function(t){return!(o&&!_isObject(t))&&e.call(this,0===t?0:t)}:"get"==t?function(t){return o&&!_isObject(t)?void 0:e.call(this,0===t?0:t)}:"add"==t?function(t){return e.call(this,0===t?0:t),this}:function(t,r){return e.call(this,0===t?0:t,r),this})};if("function"==typeof s&&(o||c.forEach&&!_fails(function(){(new s).entries().next()}))){var h=new s,_=h[u](o?{}:-0,1)!=h,d=_fails(function(){h.has(1)}),p=_iterDetect(function(t){new s(t)}),g=!o&&_fails(function(){for(var t=new s,e=5;e--;)t[u](e,e);return!t.has(-0)});p||((s=e(function(e,r){_anInstance(e,s,t);var n=_inheritIfRequired(new a,e,s);return null!=r&&_forOf(r,i,n[u],n),n})).prototype=c,c.constructor=s),(d||g)&&(f("delete"),f("has"),i&&f("get")),(g||_)&&f(u),o&&c.clear&&delete c.clear}else s=n.getConstructor(e,t,i,u),_redefineAll(s.prototype,r),_meta.NEED=!0;return _setToStringTag(s,t),l[t]=s,_export(_export.G+_export.W+_export.F*(s!=a),l),o||n.setStrong(s,t,i),s},MAP="Map",es6_map=_collection(MAP,function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var e=_collectionStrong.getEntry(_validateCollection(this,MAP),t);return e&&e.v},set:function(t,e){return _collectionStrong.def(_validateCollection(this,MAP),0===t?0:t,e)}},_collectionStrong,!0);function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),t}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _possibleConstructorReturn(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?_assertThisInitialized(t):e}for(var Typed,toString$1=function(t){var e=t.enable,r=t.sfactor,n=void 0===r?"":r,i=t.dfactor,o=void 0===i?"":i;return JSON.stringify([e,n,o])},blendModeCache=null,BlendMode=function(){function t(e){var r=e.enable,n=e.sfactor,i=void 0===n?null:n,o=e.dfactor,a=void 0===o?null:o;_classCallCheck(this,t),this.enable=r,this.sfactor=i,this.dfactor=a}return _createClass(t,null,[{key:"make",value:function(e,r){null===blendModeCache&&(blendModeCache=new Map,t.make("off",{enable:!1}),t.make("additive",{enable:!0,sfactor:"SRC_ALPHA",dfactor:"ONE"}),t.make("orderDependent",{enable:!0,sfactor:"SRC_ALPHA",dfactor:"ONE_MINUS_SRC_ALPHA"}));var n=blendModeCache.get(e);if(n)return n;if(r){var i=toString$1(r);return(n=blendModeCache.get(i))?(blendModeCache.set(e,n),n):(n=new t(r),blendModeCache.set(i,n),blendModeCache.set(e,n),n)}}}]),_createClass(t,[{key:"isEqual",value:function(t){return t&&this.enable===t.enable&&this._sfactor===t.sfactor&&this._dfactor===t.dfactor}},{key:"sfactor",set:function(t){this._sfactor="string"==typeof t?t:void 0},get:function(){return this._sfactor}},{key:"dfactor",set:function(t){this._dfactor="string"==typeof t?t:void 0},get:function(){return this._dfactor}}]),t}(),TYPED=_uid("typed_array"),VIEW=_uid("view"),ABV=!(!_global.ArrayBuffer||!_global.DataView),CONSTR=ABV,i$1=0,l=9,TypedArrayConstructors="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");i$1<l;)(Typed=_global[TypedArrayConstructors[i$1++]])?(_hide(Typed.prototype,TYPED,!0),_hide(Typed.prototype,VIEW,!0)):CONSTR=!1;var _typed={ABV:ABV,CONSTR:CONSTR,TYPED:TYPED,VIEW:VIEW},_toIndex=function(t){if(void 0===t)return 0;var e=_toInteger(t),r=_toLength(e);if(e!==r)throw RangeError("Wrong length!");return r},hiddenKeys=_enumBugKeys.concat("length","prototype"),f$3=Object.getOwnPropertyNames||function(t){return _objectKeysInternal(t,hiddenKeys)},_objectGopn={f:f$3},_arrayFill=function(t){for(var e=_toObject(this),r=_toLength(e.length),n=arguments.length,i=_toAbsoluteIndex(n>1?arguments[1]:void 0,r),o=n>2?arguments[2]:void 0,a=void 0===o?r:_toAbsoluteIndex(o,r);a>i;)e[i++]=t;return e},_typedBuffer=createCommonjsModule(function(t,e){var r=_objectGopn.f,n=_objectDp.f,i="prototype",o="Wrong index!",a=_global.ArrayBuffer,s=_global.DataView,u=_global.Math,c=_global.RangeError,l=_global.Infinity,f=a,h=u.abs,_=u.pow,d=u.floor,p=u.log,g=u.LN2,y=_descriptors?"_b":"buffer",v=_descriptors?"_l":"byteLength",b=_descriptors?"_o":"byteOffset";function E(t,e,r){var n,i,o,a=new Array(r),s=8*r-e-1,u=(1<<s)-1,c=u>>1,f=23===e?_(2,-24)-_(2,-77):0,y=0,v=t<0||0===t&&1/t<0?1:0;for((t=h(t))!=t||t===l?(i=t!=t?1:0,n=u):(n=d(p(t)/g),t*(o=_(2,-n))<1&&(n--,o*=2),(t+=n+c>=1?f/o:f*_(2,1-c))*o>=2&&(n++,o/=2),n+c>=u?(i=0,n=u):n+c>=1?(i=(t*o-1)*_(2,e),n+=c):(i=t*_(2,c-1)*_(2,e),n=0));e>=8;a[y++]=255&i,i/=256,e-=8);for(n=n<<e|i,s+=e;s>0;a[y++]=255&n,n/=256,s-=8);return a[--y]|=128*v,a}function T(t,e,r){var n,i=8*r-e-1,o=(1<<i)-1,a=o>>1,s=i-7,u=r-1,c=t[u--],f=127&c;for(c>>=7;s>0;f=256*f+t[u],u--,s-=8);for(n=f&(1<<-s)-1,f>>=-s,s+=e;s>0;n=256*n+t[u],u--,s-=8);if(0===f)f=1-a;else{if(f===o)return n?NaN:c?-l:l;n+=_(2,e),f-=a}return(c?-1:1)*n*_(2,f-e)}function m(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]}function A(t){return[255&t]}function x(t){return[255&t,t>>8&255]}function S(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]}function O(t){return E(t,52,8)}function P(t){return E(t,23,4)}function I(t,e,r){n(t[i],e,{get:function(){return this[r]}})}function w(t,e,r,n){var i=_toIndex(+r);if(i+e>t[v])throw c(o);var a=t[y]._b,s=i+t[b],u=a.slice(s,s+e);return n?u:u.reverse()}function C(t,e,r,n,i,a){var s=_toIndex(+r);if(s+e>t[v])throw c(o);for(var u=t[y]._b,l=s+t[b],f=n(+i),h=0;h<e;h++)u[l+h]=f[a?h:e-h-1]}if(_typed.ABV){if(!_fails(function(){a(1)})||!_fails(function(){new a(-1)})||_fails(function(){return new a,new a(1.5),new a(NaN),"ArrayBuffer"!=a.name})){for(var R,G=(a=function(t){return _anInstance(this,a),new f(_toIndex(t))})[i]=f[i],B=r(f),j=0;B.length>j;)(R=B[j++])in a||_hide(a,R,f[R]);G.constructor=a}var L=new s(new a(2)),M=s[i].setInt8;L.setInt8(0,2147483648),L.setInt8(1,2147483649),!L.getInt8(0)&&L.getInt8(1)||_redefineAll(s[i],{setInt8:function(t,e){M.call(this,t,e<<24>>24)},setUint8:function(t,e){M.call(this,t,e<<24>>24)}},!0)}else a=function(t){_anInstance(this,a,"ArrayBuffer");var e=_toIndex(t);this._b=_arrayFill.call(new Array(e),0),this[v]=e},s=function(t,e,r){_anInstance(this,s,"DataView"),_anInstance(t,a,"DataView");var n=t[v],i=_toInteger(e);if(i<0||i>n)throw c("Wrong offset!");if(i+(r=void 0===r?n-i:_toLength(r))>n)throw c("Wrong length!");this[y]=t,this[b]=i,this[v]=r},_descriptors&&(I(a,"byteLength","_l"),I(s,"buffer","_b"),I(s,"byteLength","_l"),I(s,"byteOffset","_o")),_redefineAll(s[i],{getInt8:function(t){return w(this,1,t)[0]<<24>>24},getUint8:function(t){return w(this,1,t)[0]},getInt16:function(t){var e=w(this,2,t,arguments[1]);return(e[1]<<8|e[0])<<16>>16},getUint16:function(t){var e=w(this,2,t,arguments[1]);return e[1]<<8|e[0]},getInt32:function(t){return m(w(this,4,t,arguments[1]))},getUint32:function(t){return m(w(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return T(w(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return T(w(this,8,t,arguments[1]),52,8)},setInt8:function(t,e){C(this,1,t,A,e)},setUint8:function(t,e){C(this,1,t,A,e)},setInt16:function(t,e){C(this,2,t,x,e,arguments[2])},setUint16:function(t,e){C(this,2,t,x,e,arguments[2])},setInt32:function(t,e){C(this,4,t,S,e,arguments[2])},setUint32:function(t,e){C(this,4,t,S,e,arguments[2])},setFloat32:function(t,e){C(this,4,t,P,e,arguments[2])},setFloat64:function(t,e){C(this,8,t,O,e,arguments[2])}});_setToStringTag(a,"ArrayBuffer"),_setToStringTag(s,"DataView"),_hide(s[i],_typed.VIEW,!0),e.ArrayBuffer=a,e.DataView=s}),_isArray=Array.isArray||function(t){return"Array"==_cof(t)},SPECIES$1=_wks("species"),_arraySpeciesConstructor=function(t){var e;return _isArray(t)&&("function"!=typeof(e=t.constructor)||e!==Array&&!_isArray(e.prototype)||(e=void 0),_isObject(e)&&null===(e=e[SPECIES$1])&&(e=void 0)),void 0===e?Array:e},_arraySpeciesCreate=function(t,e){return new(_arraySpeciesConstructor(t))(e)},_arrayMethods=function(t,e){var r=1==t,n=2==t,i=3==t,o=4==t,a=6==t,s=5==t||a,u=e||_arraySpeciesCreate;return function(e,c,l){for(var f,h,_=_toObject(e),d=_iobject(_),p=_ctx(c,l,3),g=_toLength(d.length),y=0,v=r?u(e,g):n?u(e,0):void 0;g>y;y++)if((s||y in d)&&(h=p(f=d[y],y,_),t))if(r)v[y]=h;else if(h)switch(t){case 3:return!0;case 5:return f;case 6:return y;case 2:v.push(f)}else if(o)return!1;return a?-1:i||o?o:v}},SPECIES$2=_wks("species"),_speciesConstructor=function(t,e){var r,n=_anObject(t).constructor;return void 0===n||null==(r=_anObject(n)[SPECIES$2])?e:_aFunction(r)},_arrayCopyWithin=[].copyWithin||function(t,e){var r=_toObject(this),n=_toLength(r.length),i=_toAbsoluteIndex(t,n),o=_toAbsoluteIndex(e,n),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?n:_toAbsoluteIndex(a,n))-o,n-i),u=1;for(o<i&&i<o+s&&(u=-1,o+=s-1,i+=s-1);s-- >0;)o in r?r[i]=r[o]:delete r[i],i+=u,o+=u;return r},_typedArray=createCommonjsModule(function(t){if(_descriptors){var e=_global,r=_fails,n=_export,i=_typed,o=_typedBuffer,a=_ctx,s=_anInstance,u=_propertyDesc,c=_hide,l=_redefineAll,f=_toInteger,h=_toLength,_=_toIndex,d=_toAbsoluteIndex,p=_toPrimitive,g=_has,y=_classof,v=_isObject,b=_toObject,E=_isArrayIter,T=_objectCreate,m=_objectGpo,A=_objectGopn.f,x=core_getIteratorMethod,S=_uid,O=_wks,P=_arrayMethods,I=_arrayIncludes,w=_speciesConstructor,C=es6_array_iterator,R=_iterators,G=_iterDetect,B=_setSpecies,j=_arrayFill,L=_arrayCopyWithin,M=_objectDp,D=_objectGopd,k=M.f,N=D.f,U=e.RangeError,F=e.TypeError,W=e.Uint8Array,$=Array.prototype,V=o.ArrayBuffer,Y=o.DataView,K=P(0),X=P(2),H=P(3),z=P(4),Z=P(5),q=P(6),J=I(!0),Q=I(!1),tt=C.values,et=C.keys,rt=C.entries,nt=$.lastIndexOf,it=$.reduce,ot=$.reduceRight,at=$.join,st=$.sort,ut=$.slice,ct=$.toString,lt=$.toLocaleString,ft=O("iterator"),ht=O("toStringTag"),_t=S("typed_constructor"),dt=S("def_constructor"),pt=i.CONSTR,gt=i.TYPED,yt=i.VIEW,vt=P(1,function(t,e){return At(w(t,t[dt]),e)}),bt=r(function(){return 1===new W(new Uint16Array([1]).buffer)[0]}),Et=!!W&&!!W.prototype.set&&r(function(){new W(1).set({})}),Tt=function(t,e){var r=f(t);if(r<0||r%e)throw U("Wrong offset!");return r},mt=function(t){if(v(t)&&gt in t)return t;throw F(t+" is not a typed array!")},At=function(t,e){if(!(v(t)&&_t in t))throw F("It is not a typed array constructor!");return new t(e)},xt=function(t,e){return St(w(t,t[dt]),e)},St=function(t,e){for(var r=0,n=e.length,i=At(t,n);n>r;)i[r]=e[r++];return i},Ot=function(t,e,r){k(t,e,{get:function(){return this._d[r]}})},Pt=function(t){var e,r,n,i,o,s,u=b(t),c=arguments.length,l=c>1?arguments[1]:void 0,f=void 0!==l,_=x(u);if(null!=_&&!E(_)){for(s=_.call(u),n=[],e=0;!(o=s.next()).done;e++)n.push(o.value);u=n}for(f&&c>2&&(l=a(l,arguments[2],2)),e=0,r=h(u.length),i=At(this,r);r>e;e++)i[e]=f?l(u[e],e):u[e];return i},It=function(){for(var t=0,e=arguments.length,r=At(this,e);e>t;)r[t]=arguments[t++];return r},wt=!!W&&r(function(){lt.call(new W(1))}),Ct=function(){return lt.apply(wt?ut.call(mt(this)):mt(this),arguments)},Rt={copyWithin:function(t,e){return L.call(mt(this),t,e,arguments.length>2?arguments[2]:void 0)},every:function(t){return z(mt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return j.apply(mt(this),arguments)},filter:function(t){return xt(this,X(mt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return Z(mt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return q(mt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){K(mt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return Q(mt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return J(mt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return at.apply(mt(this),arguments)},lastIndexOf:function(t){return nt.apply(mt(this),arguments)},map:function(t){return vt(mt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return it.apply(mt(this),arguments)},reduceRight:function(t){return ot.apply(mt(this),arguments)},reverse:function(){for(var t,e=mt(this).length,r=Math.floor(e/2),n=0;n<r;)t=this[n],this[n++]=this[--e],this[e]=t;return this},some:function(t){return H(mt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return st.call(mt(this),t)},subarray:function(t,e){var r=mt(this),n=r.length,i=d(t,n);return new(w(r,r[dt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,h((void 0===e?n:d(e,n))-i))}},Gt=function(t,e){return xt(this,ut.call(mt(this),t,e))},Bt=function(t){mt(this);var e=Tt(arguments[1],1),r=this.length,n=b(t),i=h(n.length),o=0;if(i+e>r)throw U("Wrong length!");for(;o<i;)this[e+o]=n[o++]},jt={entries:function(){return rt.call(mt(this))},keys:function(){return et.call(mt(this))},values:function(){return tt.call(mt(this))}},Lt=function(t,e){return v(t)&&t[gt]&&"symbol"!=typeof e&&e in t&&String(+e)==String(e)},Mt=function(t,e){return Lt(t,e=p(e,!0))?u(2,t[e]):N(t,e)},Dt=function(t,e,r){return!(Lt(t,e=p(e,!0))&&v(r)&&g(r,"value"))||g(r,"get")||g(r,"set")||r.configurable||g(r,"writable")&&!r.writable||g(r,"enumerable")&&!r.enumerable?k(t,e,r):(t[e]=r.value,t)};pt||(D.f=Mt,M.f=Dt),n(n.S+n.F*!pt,"Object",{getOwnPropertyDescriptor:Mt,defineProperty:Dt}),r(function(){ct.call({})})&&(ct=lt=function(){return at.call(this)});var kt=l({},Rt);l(kt,jt),c(kt,ft,jt.values),l(kt,{slice:Gt,set:Bt,constructor:function(){},toString:ct,toLocaleString:Ct}),Ot(kt,"buffer","b"),Ot(kt,"byteOffset","o"),Ot(kt,"byteLength","l"),Ot(kt,"length","e"),k(kt,ht,{get:function(){return this[gt]}}),t.exports=function(t,o,a,u){var l=t+((u=!!u)?"Clamped":"")+"Array",f="get"+t,d="set"+t,p=e[l],g=p||{},b=p&&m(p),E=!p||!i.ABV,x={},S=p&&p.prototype,O=function(t,e){k(t,e,{get:function(){return function(t,e){var r=t._d;return r.v[f](e*o+r.o,bt)}(this,e)},set:function(t){return function(t,e,r){var n=t._d;u&&(r=(r=Math.round(r))<0?0:r>255?255:255&r),n.v[d](e*o+n.o,r,bt)}(this,e,t)},enumerable:!0})};E?(p=a(function(t,e,r,n){s(t,p,l,"_d");var i,a,u,f,d=0,g=0;if(v(e)){if(!(e instanceof V||"ArrayBuffer"==(f=y(e))||"SharedArrayBuffer"==f))return gt in e?St(p,e):Pt.call(p,e);i=e,g=Tt(r,o);var b=e.byteLength;if(void 0===n){if(b%o)throw U("Wrong length!");if((a=b-g)<0)throw U("Wrong length!")}else if((a=h(n)*o)+g>b)throw U("Wrong length!");u=a/o}else u=_(e),i=new V(a=u*o);for(c(t,"_d",{b:i,o:g,l:a,e:u,v:new Y(i)});d<u;)O(t,d++)}),S=p.prototype=T(kt),c(S,"constructor",p)):r(function(){p(1)})&&r(function(){new p(-1)})&&G(function(t){new p,new p(null),new p(1.5),new p(t)},!0)||(p=a(function(t,e,r,n){var i;return s(t,p,l),v(e)?e instanceof V||"ArrayBuffer"==(i=y(e))||"SharedArrayBuffer"==i?void 0!==n?new g(e,Tt(r,o),n):void 0!==r?new g(e,Tt(r,o)):new g(e):gt in e?St(p,e):Pt.call(p,e):new g(_(e))}),K(b!==Function.prototype?A(g).concat(A(b)):A(g),function(t){t in p||c(p,t,g[t])}),p.prototype=S,S.constructor=p);var P=S[ft],I=!!P&&("values"==P.name||null==P.name),w=jt.values;c(p,_t,!0),c(S,gt,l),c(S,yt,!0),c(S,dt,p),(u?new p(1)[ht]==l:ht in S)||k(S,ht,{get:function(){return l}}),x[l]=p,n(n.G+n.W+n.F*(p!=g),x),n(n.S,l,{BYTES_PER_ELEMENT:o}),n(n.S+n.F*r(function(){g.of.call(p,1)}),l,{from:Pt,of:It}),"BYTES_PER_ELEMENT"in S||c(S,"BYTES_PER_ELEMENT",o),n(n.P,l,Rt),B(l),n(n.P+n.F*Et,l,{set:Bt}),n(n.P+n.F*!I,l,jt),S.toString!=ct&&(S.toString=ct),n(n.P+n.F*r(function(){new p(1).slice()}),l,{slice:Gt}),n(n.P+n.F*(r(function(){return[1,2].toLocaleString()!=new p([1,2]).toLocaleString()})||!r(function(){S.toLocaleString.call([1,2])})),l,{toLocaleString:Ct}),R[l]=I?P:w,I||c(S,ft,w)}}else t.exports=function(){}});_typedArray("Uint8",1,function(t){return function(e,r,n){return t(this,e,r,n)}},!0);var _createProperty=function(t,e,r){e in t?_objectDp.f(t,e,_propertyDesc(0,r)):t[e]=r};_export(_export.S+_export.F*!_iterDetect(function(t){}),"Array",{from:function(t){var e,r,n,i,o=_toObject(t),a="function"==typeof this?this:Array,s=arguments.length,u=s>1?arguments[1]:void 0,c=void 0!==u,l=0,f=core_getIteratorMethod(o);if(c&&(u=_ctx(u,s>2?arguments[2]:void 0,2)),null==f||a==Array&&_isArrayIter(f))for(r=new a(e=_toLength(o.length));e>l;l++)_createProperty(r,l,c?u(o[l],l):o[l]);else for(i=f.call(o),r=new a;!(n=i.next()).done;l++)_createProperty(r,l,c?_iterCall(i,u,[n.value,l],!0):n.value);return r.length=l,r}});var _strictMethod=function(t,e){return!!t&&_fails(function(){e?t.call(null,function(){},1):t.call(null)})},$forEach=_arrayMethods(0),STRICT=_strictMethod([].forEach,!0);_export(_export.P+_export.F*!STRICT,"Array",{forEach:function(t){return $forEach(this,t,arguments[1])}}),_typedArray("Uint8",1,function(t){return function(e,r,n){return t(this,e,r,n)}});var SET="Set",es6_set=_collection(SET,function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return _collectionStrong.def(_validateCollection(this,SET),t=0===t?0:t,t)}},_collectionStrong),$indexOf=_arrayIncludes(!1),$native=[].indexOf,NEGATIVE_ZERO=!!$native&&1/[1].indexOf(1,-0)<0;_export(_export.P+_export.F*(NEGATIVE_ZERO||!_strictMethod($native)),"Array",{indexOf:function(t){return NEGATIVE_ZERO?$native.apply(this,arguments)||0:$indexOf(this,t,arguments[1])}});var $filter=_arrayMethods(2);_export(_export.P+_export.F*!_strictMethod([].filter,!0),"Array",{filter:function(t){return $filter(this,t,arguments[1])}});var TextureUnitManager=function(){function t(e){_classCallCheck(this,t),this.glx=e,this.boundTextures=new Array(e.MAX_TEXTURE_IMAGE_UNITS);for(var r=0;r<this.boundTextures.length;++r)this.boundTextures[r]=null;this.lastBoundTexUnit=0}return _createClass(t,[{key:"bindWebGlTexture",value:function(t){var e=this.boundTextures.indexOf(t);if(e<0){for(var r=0;r<this.boundTextures.length;++r)if(!this.boundTextures[r]){e=r,this.boundTextures[r]=t;break}if(e<0){e=this.lastBoundTexUnit;var n=this.boundTextures[e];n&&(n.texUnit=-1),this.lastBoundTexUnit=(this.lastBoundTexUnit+1)%this.glx.MAX_TEXTURE_IMAGE_UNITS}this.glx.activeTexture(e),this.glx.bindTexture2d(t.glTexObj),t.texUnit=e}return e}}]),t}(),readGlState=function(t){var e=t.gl;t.DEPTH_BITS=e.getParameter(e.DEPTH_BITS),t.STENCIL_BITS=e.getParameter(e.STENCIL_BITS),t.MAX_TEXTURE_IMAGE_UNITS=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),t.boundBuffers.set(e.ARRAY_BUFFER,e.getParameter(e.ARRAY_BUFFER_BINDING)),t.boundBuffers.set(e.ELEMENT_ARRAY_BUFFER,e.getParameter(e.ELEMENT_ARRAY_BUFFER_BINDING)),t.currentProgram=e.getParameter(e.CURRENT_PROGRAM),t.blendEnabled=e.getParameter(e.BLEND)},WebGlContext=function(){function t(e){_classCallCheck(this,t),this.gl=e,this.contextAttributes=e.getContextAttributes(),this.currentBlendMode=null,this.boundBuffers=new Map,readGlState(this,e),this.boundTextures=new Array(this.MAX_TEXTURE_IMAGE_UNITS);for(var r=0;r<this.boundTextures.length;r++)this.boundTextures[r]={TEXTURE_2D:null};this.textureUnitManager=new TextureUnitManager(this),this.enabledVertexAttribLocations=[],this.activeTexture(0)}return _createClass(t,[{key:"bindBuffer",value:function(t,e){this.boundBuffers.get(t)!==e&&(this.gl.bindBuffer(t,e),this.boundBuffers.set(t,e))}},{key:"activeTexture",value:function(t){var e=this.gl,r=e.TEXTURE0+t;this.activeTexUnit!==r&&(this.activeTexUnit=r,e.activeTexture(this.activeTexUnit))}},{key:"bindTexture2d",value:function(t){var e=this.gl,r=this.boundTextures[this.activeTexUnit-e.TEXTURE0];r.TEXTURE_2D!==t&&(r.TEXTURE_2D=t,e.bindTexture(e.TEXTURE_2D,t))}},{key:"useProgram",value:function(t){return this.currentProgram!==t&&(this.gl.useProgram(t),this.currentProgram=t,!0)}},{key:"enableVertexAttribArrays",value:function(t){var e=this,r=this.gl;this.enabledVertexAttribLocations.filter(function(e){return-1===t.indexOf(e)}).forEach(function(n){r.disableVertexAttribArray(n),e.enabledVertexAttribLocations.splice(t.indexOf(n),1)}),t.forEach(function(t){-1===e.enabledVertexAttribLocations.indexOf(t)&&(r.enableVertexAttribArray(t),e.enabledVertexAttribLocations.push(t))})}},{key:"blend",value:function(t){if(t!==this.currentBlendMode){this.currentBlendMode=t;var e=this.gl;t.enable?(this.blendEnabled||(e.enable(e.BLEND),this.blendEnabled=!0),e.blendFunc(e[t.sfactor],e[t.dfactor])):this.blendEnabled&&(e.disable(e.BLEND),this.blendEnabled=!1)}}}]),t}(),WebGl1Context=function(t){function e(t){var r;return _classCallCheck(this,e),(r=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,t))).isWebGL1=!0,r.ANGLE_instanced_arrays=t.getExtension("ANGLE_instanced_arrays"),r}return _inherits(e,WebGlContext),_createClass(e,[{key:"vertexAttribDivisor",value:function(t,e){this.ANGLE_instanced_arrays.vertexAttribDivisorANGLE(t,e)}},{key:"drawElementsInstanced",value:function(t,e,r,n,i){this.ANGLE_instanced_arrays.drawElementsInstancedANGLE(t,e,r,n,i)}}]),e}(),WebGl2Context=function(t){function e(t){var r;return _classCallCheck(this,e),(r=_possibleConstructorReturn(this,_getPrototypeOf(e).call(this,t))).isWebGL2=!0,r}return _inherits(e,WebGlContext),_createClass(e,[{key:"vertexAttribDivisor",value:function(t,e){this.gl.vertexAttribDivisor(t,e)}},{key:"drawElementsInstanced",value:function(t,e,r,n,i){this.gl.drawElementsInstanced(t,e,r,n,i)}}]),e}(),readContextAttributes=function(t){return{alpha:readOption(t,"alpha",!1),depth:readOption(t,"depth",!0),stencil:readOption(t,"stencil",!0),antialias:readOption(t,"antialias",!1),premultipliedAlpha:readOption(t,"premultipliedAlpha",!0),preserveDrawingBuffer:readOption(t,"preserveDrawingBuffer",!1),preferLowPowerToHighPerformance:readOption(t,"preferLowPowerToHighPerformance",!1),failIfMajorPerformanceCaveat:readOption(t,"failIfMajorPerformanceCaveat",!1)}},createWebGlContext=function(t,e){var r,n=readContextAttributes(e);if(!readOption(e,"disableWebGL2",!1)&&(r=t.getContext("webgl2",n)))return new WebGl2Context(r);if(null==(r=t.getContext("webgl",n)||t.getContext("experimental-webgl",n)))throw Error("createWebGlContext: could not create webgl context with attributes: ".concat(JSON.stringify(n)));return new WebGl1Context(r)},WebGlBuffer=function(){function t(e,r,n,i){_classCallCheck(this,t),this.glx=e;var o=e.gl;this.target=o[r],this.usage=o[n],this.typedArray=i,this.clonedTypedArray=void 0,this.lastTypedArray=void 0,this.glBuffer=o.createBuffer()}return _createClass(t,[{key:"bindBuffer",value:function(){this.glx.bindBuffer(this.target,this.glBuffer)}},{key:"bufferData",value:function(t){this.bindBuffer(),this.glx.gl.bufferData(this.target,t||this.typedArray,this.usage)}},{key:"doubleBufferData",value:function(t){var e=t||this.typedArray;void 0===this.clonedTypedArray||e!==this.lastTypedArray?(this.clonedTypedArray=new e.constructor(e.length),this.clonedTypedArray.set(e),this.lastTypedArray=e):this.clonedTypedArray.set(e),this.bufferData(this.clonedTypedArray)}},{key:"deleteBuffer",value:function(){this.glx.gl.deleteBuffer(this.glBuffer)}}]),t}();WebGlBuffer.ARRAY_BUFFER="ARRAY_BUFFER",WebGlBuffer.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",WebGlBuffer.STATIC_DRAW="STATIC_DRAW",WebGlBuffer.DYNAMIC_DRAW="DYNAMIC_DRAW";var log=getLogger("picimo.renderer.WebGlShader"),compileShader=function(t){var e=t.glx.gl,r=t.glShader,n=t.source.compile({glx:t.glx});if(e.shaderSource(r,n),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){var i=e.getShaderInfoLog(r);throw log.debug("WebGlShader: vertex shader source =>\n".concat(n)),new Error("WebGlShader: gl.compileShader(..) panic!\n".concat(i))}},WebGlShader=function t(e,r){if(_classCallCheck(this,t),this.glx=e,!(r instanceof ShaderSource))throw new Error("WebGlShader panic! source must be an instance of ShaderSource!");this.source=r;var n=e.gl;this.shaderType=n[r.type],this.glShader=n.createShader(this.shaderType),compileShader(this)},_invoke=function(t,e,r){var n=void 0===r;switch(e.length){case 0:return n?t():t.call(r);case 1:return n?t(e[0]):t.call(r,e[0]);case 2:return n?t(e[0],e[1]):t.call(r,e[0],e[1]);case 3:return n?t(e[0],e[1],e[2]):t.call(r,e[0],e[1],e[2]);case 4:return n?t(e[0],e[1],e[2],e[3]):t.call(r,e[0],e[1],e[2],e[3])}return t.apply(r,e)},arraySlice=[].slice,factories={},construct=function(t,e,r){if(!(e in factories)){for(var n=[],i=0;i<e;i++)n[i]="a["+i+"]";factories[e]=Function("F,a","return new F("+n.join(",")+")")}return factories[e](t,r)},_bind=Function.bind||function(t){var e=_aFunction(this),r=arraySlice.call(arguments,1),n=function(){var i=r.concat(arraySlice.call(arguments));return this instanceof n?construct(e,i.length,i):_invoke(e,i,t)};return _isObject(e.prototype)&&(n.prototype=e.prototype),n};_export(_export.P,"Function",{bind:_bind});var dP$2=_objectDp.f,FProto=Function.prototype,nameRE=/^\s*function ([^ (]*)/,NAME$1="name";function createUniformSetter(t){var e=t.type,r=t.location,n=t.glx.gl;switch(e){case n.FLOAT:return function(t){return n.uniform1f(r,t)};case n.FLOAT_VEC2:return function(t){return n.uniform2f(r,t[0],t[1])};case n.FLOAT_VEC3:return function(t){return n.uniform3f(r,t[0],t[1],t[2])};case n.FLOAT_VEC4:return function(t){return n.uniform4f(r,t[0],t[1],t[2],t[3])};case n.FLOAT_MAT4:return function(t){return n.uniformMatrix4fv(r,n.FALSE,t.mat4)};case n.SAMPLER_2D:return function(t){return n.uniform1i(r,t)};default:throw new Error("WebGlUniform: unknown uniform type:".concat(e))}}NAME$1 in FProto||_descriptors&&dP$2(FProto,NAME$1,{configurable:!0,get:function(){try{return(""+this).match(nameRE)[1]}catch(t){return""}}});var WebGlUniform=function t(e,r){_classCallCheck(this,t),this.program=e,this.glx=e.glx;var n=e.glx.gl,i=e.glProgram,o=n.getActiveUniform(i,r),a=o.name,s=o.size,u=o.type;this.name=a,this.size=s,this.type=u,this.location=n.getUniformLocation(i,a),this.setValue=createUniformSetter(this)},GL_ITEM_TYPES={float32:"FLOAT",int16:"SHORT",int32:"INT",int8:"BYTE",uint16:"UNSIGNED_SHORT",uint32:"UNSIGNED_INT",uint8:"UNSIGNED_BYTE"},glType=function(t,e){return t[GL_ITEM_TYPES[e]]},WebGlAttribute=function(){function t(e,r){_classCallCheck(this,t),this.program=e,this.glx=e.glx;var n=e.glx.gl,i=e.glProgram,o=n.getActiveAttrib(i,r),a=o.name,s=o.size,u=o.type;this.name=a,this.size=s,this.type=u,this.location=n.getAttribLocation(i,a)}return _createClass(t,[{key:"vertexAttribPointer",value:function(t){var e=this.glx.gl,r=t.attr[this.name],n=glType(e,r.type);e.vertexAttribPointer(this.location,r.size,n,!1,t.bytesPerVertex,r.byteOffset),t.isInstanced&&this.glx.vertexAttribDivisor(this.location,1)}}]),t}(),log$1=getLogger("picimo.renderer.WebGlProgram");function createAttributes(t){var e=t.glx.gl,r=e.getProgramParameter(t.glProgram,e.ACTIVE_ATTRIBUTES);t.attributes={},t.attributeNames=[],t.attributeLocations=[];for(var n=0;n<r;++n){var i=new WebGlAttribute(t,n);t.attributes[i.name]=i,t.attributeNames.push(i.name),t.attributeLocations.push(i.location)}}function createUniforms(t){var e=t.glx.gl,r=e.getProgramParameter(t.glProgram,e.ACTIVE_UNIFORMS);t.uniforms={},t.uniformNames=[];for(var n=0;n<r;++n){var i=new WebGlUniform(t,n);t.uniforms[i.name]=i,t.uniformNames.push(i.name)}}function linkProgram(t,e,r){var n=t.glx.gl,i=t.glProgram;if(n.attachShader(i,e),n.attachShader(i,r),n.linkProgram(i),!n.getProgramParameter(i,n.LINK_STATUS))throw new Error("WebGlProgram: link panic!")}var WebGlProgram=function(){function t(e,r,n){_classCallCheck(this,t),this.glx=e,this.vertexShader=r,this.fragmentShader=n;var i=e.gl;this.glProgram=i.createProgram(),linkProgram(this,this.vertexShader.glShader,this.fragmentShader.glShader),createUniforms(this),createAttributes(this)}return _createClass(t,[{key:"use",value:function(){var t=this.glx;return!!t.useProgram(this.glProgram)&&(t.enableVertexAttribArrays(this.attributeLocations),!0)}},{key:"loadUniforms",value:function(t,e){var r=this,n=!0;return this.uniformNames.forEach(function(i){var o=t.curUniform(i);if(null==o){if(!(o=t.curTex2d(i)))return log$1.error("WebGlProgram: could not load uniform:",i),void(n=!1);var a=o.texture;a&&(o.data=e.syncTexture(a).bind())}r.uniforms[i].setValue(o.data)}),n}},{key:"loadAttributes",value:function(t,e){var r=this,n=!0;return this.attributeNames.forEach(function(i){var o=t.curAttrib(i);if(o){var a=o.data;e.syncBuffer(a).bindBuffer(),r.attributes[i].vertexAttribPointer(a.descriptor)}else log$1.error("WebGlProgram: could not load attribute:",i),n=!1}),n}}]),t}(),initTexGl=function(t){var e=t.glx.gl;t.bind(),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha);var r=t.repeatable?e.REPEAT:e.CLAMP_TO_EDGE;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,r);var n=t.nearest?e.NEAREST:e.LINEAR;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t.imgEl.width,t.imgEl.height,0,e.RGBA,e.UNSIGNED_BYTE,null)},WebGlTexture=function(){function t(e,r){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5];_classCallCheck(this,t),this.glx=e,this.imgEl=r,this.flipY=n,this.repeatable=i,this.premultiplyAlpha=o,this.nearest=a,this.isInitialized=!1,this.glTexObj=e.gl.createTexture(),this.texUnit=-1}return _createClass(t,[{key:"bind",value:function(){return this.glx.textureUnitManager.bindWebGlTexture(this)}},{key:"uploadImageData",value:function(){if(null!=this.imgEl){this.isInitialized||(initTexGl(this),this.isInitialized=!0),this.bind();var t=this.glx.gl;t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,this.imgEl)}}}]),t}(),WEB_GL_BUFFER_USAGE={static:WebGlBuffer.STATIC_DRAW,dynamic:WebGlBuffer.DYNAMIC_DRAW},loadResource=function(t,e,r){var n=t.get(e.id);return n||(n=r(e),t.set(e.id,n)),n},log$2=getLogger("picimo.renderer.WebGlResourceLibrary"),WebGlResourceLibrary=function(){function t(e){_classCallCheck(this,t),this.glx=e,this.vertexShader=new Map,this.fragmentShader=new Map,this.shaderProgram=new Map,this.buffer=new Map,this.texture=new Map}return _createClass(t,[{key:"loadBuffer",value:function(t){var e=this;return loadResource(this.buffer,t,function(){if("VOArray"===t.type||"ElementIndexArray"===t.type){var r=readOption(t.hints,"target",WebGlBuffer.ARRAY_BUFFER),n=readOption(t.hints,"usage","dynamic"),i=readOption(t.hints,"typedArray"),o=new WebGlBuffer(e.glx,r,WEB_GL_BUFFER_USAGE[n],i);return new DataRef("WebGlBuffer",o,{id:t.id,serial:0})}log$2.warn('WebGlResourceLibrary.loadBuffer() ref.type="'.concat(t.type,'" mismatch! (should be "VOArray" or "ElementIndexArray")'))})}},{key:"findBuffer",value:function(t){return this.buffer.get(t.id)}},{key:"freeBuffer",value:function(t){var e=this.findBuffer(t);e&&(this.buffer.delete(e.id),e.data.deleteBuffer())}},{key:"loadVertexShader",value:function(t){var e=this;return loadResource(this.vertexShader,t,function(){return new WebGlShader(e.glx,t)})}},{key:"loadFragementShader",value:function(t){var e=this;return loadResource(this.fragmentShader,t,function(){return new WebGlShader(e.glx,t)})}},{key:"loadProgram",value:function(t){var e=this;return loadResource(this.shaderProgram,t,function(){var r=e.loadVertexShader(t.vertexShader),n=e.loadFragementShader(t.fragmentShader);return new WebGlProgram(e.glx,r,n)})}},{key:"loadTexture",value:function(t){var e=this.texture.get(t.id);if(!e){var r=new WebGlTexture(this.glx,t.data.imgEl,t.hints.flipY,t.hints.repeatable,t.hints.premultiplyAlpha,t.hints.nearest);e=new DataRef("WebGlTexture",r,{id:t.id,serial:0}),this.texture.set(t.id,e)}return e}}]),t}(),CTX_BLEND_MODE="blend",createCanvas=function(t){if("CANVAS"===t.tagName)return t;var e=document.createElement("canvas");return t.appendChild(e),e},autotouchResource=function(t,e){e.has(t.id)||(e.add(t.id),t.touch())},applyBlendMode=function(t){var e=t.universalContext.get(CTX_BLEND_MODE);e&&t.glx.blend(e)},WebGlRenderer=function(){function t(e,r){_classCallCheck(this,t),this.domElement=e,this.canvas=createCanvas(e),this.glx=createWebGlContext(this.canvas,r),this.resources=new WebGlResourceLibrary(this.glx),this.shaderContext=new ShaderContext,this.universalContext=new StackedContext,this.now=0,this.lastFrameTime=0,this.frameNo=0,this.timeFrameOffset=0,this._pixelRatio=readOption(r,"pixelRatio"),this._touchedWithinFrame=new Set,this.shaderGlobals=new ShaderUniformGroup({time:0,resolution:[0,0],projection:new Projection({pixelRatio:1})}),this.resize()}return _createClass(t,[{key:"pushBlendMode",value:function(t){var e=t instanceof BlendMode?t:BlendMode.make(t);return this.universalContext.push(CTX_BLEND_MODE,e)}},{key:"popBlendMode",value:function(t){return this.universalContext.pop(CTX_BLEND_MODE,t)}},{key:"resize",value:function(){var t=this.canvas,e=this.domElement,r=window.getComputedStyle(t,null),n=(("inline"===r.display||""===r.display)&&e===t?e.parentNode:e)||{clientWidth:t.width,clientHeight:t.height},i=n.clientWidth,o=n.clientHeight;t.style.width="".concat(i,"px"),t.style.height="".concat(o,"px");var a=this.pixelRatio,s=Math.round(i*a),u=Math.round(o*a);s===t.width&&u===t.height||(t.width=s,t.height=u),s===this.width&&u===this.height||(this.width=s,this.height=u,this.shaderGlobals.resolution=[s,u],this.shaderGlobals.projectionUniform.update(s,u))}},{key:"readPixels",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=this.gl,r=e.drawingBufferWidth,n=e.drawingBufferHeight,i=new Uint8Array(r*n*4);return e.readPixels(0,0,r,n,e.RGBA,e.UNSIGNED_BYTE,i),t&&Array.from({length:n},function(t,e){return i.slice(e*r*4,(e+1)*r*4)}).forEach(function(t,e){return i.set(t,(n-e-1)*r*4)}),new ImageData(Uint8ClampedArray.from(i),r,n)}},{key:"initFrame",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.performance.now();++this.frameNo,this.now=t/1e3,1!==this.frameNo&&(this.timeFrameOffset=this.now-this.lastFrameTime),this.lastFrameTime=this.now,this.shaderGlobals.time=this.now,this._touchedWithinFrame.clear(),this.universalContext.clear(),this.pushBlendMode("orderDependent"),this.shaderContext.clear(),this.shaderGlobals.pushVar(this.shaderContext),this.glx.gl.viewport(0,0,this.width,this.height)}},{key:"syncBuffer",value:function(t){var e=t.ref;e.hasHint("autotouch",!0)&&autotouchResource(e,this._touchedWithinFrame);var r=this.resources.loadBuffer(e);return r.sync(e,function(t){e.hasHint("doubleBuffer",!0)?t.doubleBufferData():t.bufferData()}),r.data}},{key:"syncTexture",value:function(t){var e=t.ref,r=this.resources.loadTexture(e);return r.sync(e,function(t){return t.uploadImageData()}),r.data}},{key:"useShaderProgram",value:function(t){var e=this.resources.loadProgram(t),r=this.shaderContext,n=e.use(),i=e.loadUniforms(r,this),o=e.loadAttributes(r,this);return n&&i&&o}},{key:"drawArrays",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;applyBlendMode(this);var n=this.glx.gl;n.drawArrays(n[t],r,e)}},{key:"drawIndexed",value:function(t,e,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;applyBlendMode(this),this.syncBuffer(e).bindBuffer();var i=this.glx.gl;i.drawElements(i[t],r||e.length,i.UNSIGNED_SHORT,n*e.array.BYTES_PER_ELEMENT)}},{key:"drawIndexedInstanced",value:function(t,e,r,n,i){applyBlendMode(this),this.syncBuffer(e).bindBuffer();var o=this.glx,a=o.gl;o.drawElementsInstanced(a[t],r||e.length,a.UNSIGNED_SHORT,n*e.array.BYTES_PER_ELEMENT,i)}},{key:"drawPrimitive",value:function(t,e,r){var n=t.primitiveType,i=t.elementIndexArray,o=i.itemCount;this.drawIndexed(n,i,e*o,r*o)}},{key:"drawPrimitiveIndexed",value:function(t,e,r,n){var i=t.primitiveType,o=t.elementIndexArray,a=o.itemCount;this.drawIndexedInstanced(i,o,e*a,r*a,n)}},{key:"drawSpriteGroup",value:function(t){var e=this,r=function(){var r=t.base;r&&(e.syncBuffer(r.voPool.voArray),e.shaderContext.pushVar(r.voPoolShaderAttribs)),e.syncBuffer(t.voPool.voArray),e.shaderContext.pushVar(t.voPoolShaderAttribs),e.useShaderProgram(t.shaderProgram),r?e.drawPrimitiveIndexed(r.primitive,r.usedCount,0,t.usedCount):e.drawPrimitive(t.primitive,t.usedCount,0)};t instanceof TexturedSpriteGroup?t.whenTexturesLoaded(function(t){e.shaderContext.pushVar(t),r()}):r()}},{key:"pixelRatio",get:function(){return this._pixelRatio||window.devicePixelRatio||1}}]),t}();export{BlendMode,WebGlRenderer,WebGlTexture,WebGlBuffer,WebGlResourceLibrary};
//# sourceMappingURL=picimo-renderer.js.map
