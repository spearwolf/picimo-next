/*!
@file picimo - the hottest webgl library on earth ::( picture-in-motion ):: make sprites & shaders fun again ;-)
@author Wolfger Schramm <wolfger@spearwolf.de>
@version 0.0.1

Copyright 2016-2018 Wolfger Schramm

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

*/
var commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var _global=createCommonjsModule(function(e){var t=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=t)}),_core=createCommonjsModule(function(e){var t=e.exports={version:"2.5.7"};"number"==typeof __e&&(__e=t)}),_core_1=_core.version,_isObject=function(e){return"object"==typeof e?null!==e:"function"==typeof e},_anObject=function(e){if(!_isObject(e))throw TypeError(e+" is not an object!");return e},_fails=function(e){try{return!!e()}catch(e){return!0}},_descriptors=!_fails(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}),document$1=_global.document,is=_isObject(document$1)&&_isObject(document$1.createElement),_domCreate=function(e){return is?document$1.createElement(e):{}},_ie8DomDefine=!_descriptors&&!_fails(function(){return 7!=Object.defineProperty(_domCreate("div"),"a",{get:function(){return 7}}).a}),_toPrimitive=function(e,t){if(!_isObject(e))return e;var r,n;if(t&&"function"==typeof(r=e.toString)&&!_isObject(n=r.call(e)))return n;if("function"==typeof(r=e.valueOf)&&!_isObject(n=r.call(e)))return n;if(!t&&"function"==typeof(r=e.toString)&&!_isObject(n=r.call(e)))return n;throw TypeError("Can't convert object to primitive value")},dP=Object.defineProperty,f=_descriptors?Object.defineProperty:function(e,t,r){if(_anObject(e),t=_toPrimitive(t,!0),_anObject(r),_ie8DomDefine)try{return dP(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(e[t]=r.value),e},_objectDp={f:f},_propertyDesc=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},_hide=_descriptors?function(e,t,r){return _objectDp.f(e,t,_propertyDesc(1,r))}:function(e,t,r){return e[t]=r,e},hasOwnProperty={}.hasOwnProperty,_has=function(e,t){return hasOwnProperty.call(e,t)},id=0,px=Math.random(),_uid=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++id+px).toString(36))},_redefine=createCommonjsModule(function(e){var t=_uid("src"),r=Function.toString,n=(""+r).split("toString");_core.inspectSource=function(e){return r.call(e)},(e.exports=function(e,r,i,o){var a="function"==typeof i;a&&(_has(i,"name")||_hide(i,"name",r)),e[r]!==i&&(a&&(_has(i,t)||_hide(i,t,e[r]?""+e[r]:n.join(String(r)))),e===_global?e[r]=i:o?e[r]?e[r]=i:_hide(e,r,i):(delete e[r],_hide(e,r,i)))})(Function.prototype,"toString",function(){return"function"==typeof this&&this[t]||r.call(this)})}),_aFunction=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e},_ctx=function(e,t,r){if(_aFunction(e),void 0===t)return e;switch(r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,i){return e.call(t,r,n,i)}}return function(){return e.apply(t,arguments)}},PROTOTYPE="prototype",$export=function(e,t,r){var n,i,o,a,s=e&$export.F,c=e&$export.G,l=e&$export.S,u=e&$export.P,h=e&$export.B,f=c?_global:l?_global[t]||(_global[t]={}):(_global[t]||{})[PROTOTYPE],d=c?_core:_core[t]||(_core[t]={}),p=d[PROTOTYPE]||(d[PROTOTYPE]={});for(n in c&&(r=t),r)o=((i=!s&&f&&void 0!==f[n])?f:r)[n],a=h&&i?_ctx(o,_global):u&&"function"==typeof o?_ctx(Function.call,o):o,f&&_redefine(f,n,o,e&$export.U),d[n]!=o&&_hide(d,n,a),u&&p[n]!=o&&(p[n]=o)};_global.core=_core,$export.F=1,$export.G=2,$export.S=4,$export.P=8,$export.B=16,$export.W=32,$export.U=64,$export.R=128;var _export=$export,_defined=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e},_toObject=function(e){return Object(_defined(e))},_strictMethod=function(e,t){return!!e&&_fails(function(){t?e.call(null,function(){},1):e.call(null)})},$sort=[].sort,test=[1,2,3];_export(_export.P+_export.F*(_fails(function(){test.sort(void 0)})||!_fails(function(){test.sort(null)})||!_strictMethod($sort)),"Array",{sort:function(e){return void 0===e?$sort.call(_toObject(this)):$sort.call(_toObject(this),_aFunction(e))}});var _isFinite=_global.isFinite;_export(_export.S,"Number",{isFinite:function(e){return"number"==typeof e&&_isFinite(e)}}),_export(_export.S,"Number",{isNaN:function(e){return e!=e}});var _library=!1,_objectForcedPam=_library||!_fails(function(){var e=Math.random();__defineSetter__.call(null,e,function(){}),delete _global[e]});_descriptors&&_export(_export.P+_objectForcedPam,"Object",{__defineGetter__:function(e,t){_objectDp.f(_toObject(this),e,{get:_aFunction(t),enumerable:!0,configurable:!0})}}),_descriptors&&_export(_export.P+_objectForcedPam,"Object",{__defineSetter__:function(e,t){_objectDp.f(_toObject(this),e,{set:_aFunction(t),enumerable:!0,configurable:!0})}});var _shared=createCommonjsModule(function(e){var t=_global["__core-js_shared__"]||(_global["__core-js_shared__"]={});(e.exports=function(e,r){return t[e]||(t[e]=void 0!==r?r:{})})("versions",[]).push({version:_core.version,mode:"global",copyright:"Â© 2018 Denis Pushkarev (zloirock.ru)"})}),shared=_shared("keys"),_sharedKey=function(e){return shared[e]||(shared[e]=_uid(e))},IE_PROTO=_sharedKey("IE_PROTO"),ObjectProto=Object.prototype,_objectGpo=Object.getPrototypeOf||function(e){return e=_toObject(e),_has(e,IE_PROTO)?e[IE_PROTO]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?ObjectProto:null},f$1={}.propertyIsEnumerable,_objectPie={f:f$1},toString={}.toString,_cof=function(e){return toString.call(e).slice(8,-1)},_iobject=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==_cof(e)?e.split(""):Object(e)},_toIobject=function(e){return _iobject(_defined(e))},gOPD=Object.getOwnPropertyDescriptor,f$2=_descriptors?gOPD:function(e,t){if(e=_toIobject(e),t=_toPrimitive(t,!0),_ie8DomDefine)try{return gOPD(e,t)}catch(e){}if(_has(e,t))return _propertyDesc(!_objectPie.f.call(e,t),e[t])},_objectGopd={f:f$2},getOwnPropertyDescriptor=_objectGopd.f;_descriptors&&_export(_export.P+_objectForcedPam,"Object",{__lookupGetter__:function(e){var t,r=_toObject(this),n=_toPrimitive(e,!0);do{if(t=getOwnPropertyDescriptor(r,n))return t.get}while(r=_objectGpo(r))}});var getOwnPropertyDescriptor$1=_objectGopd.f;_descriptors&&_export(_export.P+_objectForcedPam,"Object",{__lookupSetter__:function(e){var t,r=_toObject(this),n=_toPrimitive(e,!0);do{if(t=getOwnPropertyDescriptor$1(r,n))return t.set}while(r=_objectGpo(r))}});var _sameValue=Object.is||function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t};_export(_export.S,"Object",{is:_sameValue});var _wks=createCommonjsModule(function(e){var t=_shared("wks"),r=_global.Symbol,n="function"==typeof r;(e.exports=function(e){return t[e]||(t[e]=n&&r[e]||(n?r:_uid)("Symbol."+e))}).store=t}),SPECIES=_wks("species"),_speciesConstructor=function(e,t){var r,n=_anObject(e).constructor;return void 0===n||null==(r=_anObject(n)[SPECIES])?t:_aFunction(r)};function PromiseCapability(e){var t,r;this.promise=new e(function(e,n){if(void 0!==t||void 0!==r)throw TypeError("Bad Promise constructor");t=e,r=n}),this.resolve=_aFunction(t),this.reject=_aFunction(r)}var f$3=function(e){return new PromiseCapability(e)},_newPromiseCapability={f:f$3},_promiseResolve=function(e,t){if(_anObject(e),_isObject(t)&&t.constructor===e)return t;var r=_newPromiseCapability.f(e);return(0,r.resolve)(t),r.promise};_export(_export.P+_export.R,"Promise",{finally:function(e){var t=_speciesConstructor(this,_core.Promise||_global.Promise),r="function"==typeof e;return this.then(r?function(r){return _promiseResolve(t,e()).then(function(){return r})}:e,r?function(r){return _promiseResolve(t,e()).then(function(){throw r})}:e)}});var check=function(e,t){if(_anObject(e),!_isObject(t)&&null!==t)throw TypeError(t+": can't set as prototype!")},_setProto={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,r){try{(r=_ctx(Function.call,_objectGopd.f(Object.prototype,"__proto__").set,2))(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,n){return check(e,n),t?e.__proto__=n:r(e,n),e}}({},!1):void 0),check:check},setPrototypeOf=_setProto.set,_inheritIfRequired=function(e,t,r){var n,i=t.constructor;return i!==r&&"function"==typeof i&&(n=i.prototype)!==r.prototype&&_isObject(n)&&setPrototypeOf&&setPrototypeOf(e,n),e},ceil=Math.ceil,floor=Math.floor,_toInteger=function(e){return isNaN(e=+e)?0:(e>0?floor:ceil)(e)},min=Math.min,_toLength=function(e){return e>0?min(_toInteger(e),9007199254740991):0},max=Math.max,min$1=Math.min,_toAbsoluteIndex=function(e,t){return(e=_toInteger(e))<0?max(e+t,0):min$1(e,t)},_arrayIncludes=function(e){return function(t,r,n){var i,o=_toIobject(t),a=_toLength(o.length),s=_toAbsoluteIndex(n,a);if(e&&r!=r){for(;a>s;)if((i=o[s++])!=i)return!0}else for(;a>s;s++)if((e||s in o)&&o[s]===r)return e||s||0;return!e&&-1}},arrayIndexOf=_arrayIncludes(!1),IE_PROTO$1=_sharedKey("IE_PROTO"),_objectKeysInternal=function(e,t){var r,n=_toIobject(e),i=0,o=[];for(r in n)r!=IE_PROTO$1&&_has(n,r)&&o.push(r);for(;t.length>i;)_has(n,r=t[i++])&&(~arrayIndexOf(o,r)||o.push(r));return o},_enumBugKeys="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(","),hiddenKeys=_enumBugKeys.concat("length","prototype"),f$4=Object.getOwnPropertyNames||function(e){return _objectKeysInternal(e,hiddenKeys)},_objectGopn={f:f$4},MATCH=_wks("match"),_isRegexp=function(e){var t;return _isObject(e)&&(void 0!==(t=e[MATCH])?!!t:"RegExp"==_cof(e))},_flags=function(){var e=_anObject(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t},SPECIES$1=_wks("species"),_setSpecies=function(e){var t=_global[e];_descriptors&&t&&!t[SPECIES$1]&&_objectDp.f(t,SPECIES$1,{configurable:!0,get:function(){return this}})},dP$1=_objectDp.f,gOPN=_objectGopn.f,$RegExp=_global.RegExp,Base=$RegExp,proto=$RegExp.prototype,re1=/a/g,re2=/a/g,CORRECT_NEW=new $RegExp(re1)!==re1;if(_descriptors&&(!CORRECT_NEW||_fails(function(){return re2[_wks("match")]=!1,$RegExp(re1)!=re1||$RegExp(re2)==re2||"/a/i"!=$RegExp(re1,"i")}))){$RegExp=function(e,t){var r=this instanceof $RegExp,n=_isRegexp(e),i=void 0===t;return!r&&n&&e.constructor===$RegExp&&i?e:_inheritIfRequired(CORRECT_NEW?new Base(n&&!i?e.source:e,t):Base((n=e instanceof $RegExp)?e.source:e,n&&i?_flags.call(e):t),r?this:proto,$RegExp)};for(var proxy=function(e){e in $RegExp||dP$1($RegExp,e,{configurable:!0,get:function(){return Base[e]},set:function(t){Base[e]=t}})},keys=gOPN(Base),i=0;keys.length>i;)proxy(keys[i++]);proto.constructor=$RegExp,$RegExp.prototype=proto,_redefine(_global,"RegExp",$RegExp)}_setSpecies("RegExp"),_descriptors&&"g"!=/./g.flags&&_objectDp.f(RegExp.prototype,"flags",{configurable:!0,get:_flags});var _fixReWks=function(e,t,r){var n=_wks(e),i=r(_defined,n,""[e]),o=i[0],a=i[1];_fails(function(){var t={};return t[n]=function(){return 7},7!=""[e](t)})&&(_redefine(String.prototype,e,o),_hide(RegExp.prototype,n,2==t?function(e,t){return a.call(e,this,t)}:function(e){return a.call(e,this)}))};_fixReWks("match",1,function(e,t,r){return[function(r){var n=e(this),i=null==r?void 0:r[t];return void 0!==i?i.call(r,n):new RegExp(r)[t](String(n))},r]}),_fixReWks("replace",2,function(e,t,r){return[function(n,i){var o=e(this),a=null==n?void 0:n[t];return void 0!==a?a.call(n,o,i):r.call(String(o),n,i)},r]}),_fixReWks("split",2,function(e,t,r){var n=_isRegexp,i=r,o=[].push;if("c"=="abbc".split(/(b)*/)[1]||4!="test".split(/(?:)/,-1).length||2!="ab".split(/(?:ab)*/).length||4!=".".split(/(.?)(.?)/).length||".".split(/()()/).length>1||"".split(/.?/).length){var a=void 0===/()??/.exec("")[1];r=function(e,t){var r=String(this);if(void 0===e&&0===t)return[];if(!n(e))return i.call(r,e,t);var s,c,l,u,h,f=[],d=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),p=0,g=void 0===t?4294967295:t>>>0,m=new RegExp(e.source,d+"g");for(a||(s=new RegExp("^"+m.source+"$(?!\\s)",d));(c=m.exec(r))&&!((l=c.index+c[0].length)>p&&(f.push(r.slice(p,c.index)),!a&&c.length>1&&c[0].replace(s,function(){for(h=1;h<arguments.length-2;h++)void 0===arguments[h]&&(c[h]=void 0)}),c.length>1&&c.index<r.length&&o.apply(f,c.slice(1)),u=c[0].length,p=l,f.length>=g));)m.lastIndex===c.index&&m.lastIndex++;return p===r.length?!u&&m.test("")||f.push(""):f.push(r.slice(p)),f.length>g?f.slice(0,g):f}}else"0".split(void 0,0).length&&(r=function(e,t){return void 0===e&&0===t?[]:i.call(this,e,t)});return[function(n,i){var o=e(this),a=null==n?void 0:n[t];return void 0!==a?a.call(n,o,i):r.call(String(o),n,i)},r]}),_fixReWks("search",1,function(e,t,r){return[function(r){var n=e(this),i=null==r?void 0:r[t];return void 0!==i?i.call(r,n):new RegExp(r)[t](String(n))},r]});var TO_STRING="toString",$toString=/./[TO_STRING],define=function(e){_redefine(RegExp.prototype,TO_STRING,e,!0)};_fails(function(){return"/a/b"!=$toString.call({source:"a",flags:"b"})})?define(function(){var e=_anObject(this);return"/".concat(e.source,"/","flags"in e?e.flags:!_descriptors&&e instanceof RegExp?_flags.call(e):void 0)}):$toString.name!=TO_STRING&&define(function(){return $toString.call(this)});var _meta=createCommonjsModule(function(e){var t=_uid("meta"),r=_objectDp.f,n=0,i=Object.isExtensible||function(){return!0},o=!_fails(function(){return i(Object.preventExtensions({}))}),a=function(e){r(e,t,{value:{i:"O"+ ++n,w:{}}})},s=e.exports={KEY:t,NEED:!1,fastKey:function(e,r){if(!_isObject(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!_has(e,t)){if(!i(e))return"F";if(!r)return"E";a(e)}return e[t].i},getWeak:function(e,r){if(!_has(e,t)){if(!i(e))return!0;if(!r)return!1;a(e)}return e[t].w},onFreeze:function(e){return o&&s.NEED&&i(e)&&!_has(e,t)&&a(e),e}}}),_meta_1=_meta.KEY,_meta_2=_meta.NEED,_meta_3=_meta.fastKey,_meta_4=_meta.getWeak,_meta_5=_meta.onFreeze,def=_objectDp.f,TAG=_wks("toStringTag"),_setToStringTag=function(e,t,r){e&&!_has(e=r?e:e.prototype,TAG)&&def(e,TAG,{configurable:!0,value:t})},f$5=_wks,_wksExt={f:f$5},defineProperty=_objectDp.f,_wksDefine=function(e){var t=_core.Symbol||(_core.Symbol=_global.Symbol||{});"_"==e.charAt(0)||e in t||defineProperty(t,e,{value:_wksExt.f(e)})},_objectKeys=Object.keys||function(e){return _objectKeysInternal(e,_enumBugKeys)},f$6=Object.getOwnPropertySymbols,_objectGops={f:f$6},_enumKeys=function(e){var t=_objectKeys(e),r=_objectGops.f;if(r)for(var n,i=r(e),o=_objectPie.f,a=0;i.length>a;)o.call(e,n=i[a++])&&t.push(n);return t},_isArray=Array.isArray||function(e){return"Array"==_cof(e)},_objectDps=_descriptors?Object.defineProperties:function(e,t){_anObject(e);for(var r,n=_objectKeys(t),i=n.length,o=0;i>o;)_objectDp.f(e,r=n[o++],t[r]);return e},document$2=_global.document,_html=document$2&&document$2.documentElement,IE_PROTO$2=_sharedKey("IE_PROTO"),Empty=function(){},PROTOTYPE$1="prototype",createDict=function(){var e,t=_domCreate("iframe"),r=_enumBugKeys.length;for(t.style.display="none",_html.appendChild(t),t.src="javascript:",(e=t.contentWindow.document).open(),e.write("<script>document.F=Object<\/script>"),e.close(),createDict=e.F;r--;)delete createDict[PROTOTYPE$1][_enumBugKeys[r]];return createDict()},_objectCreate=Object.create||function(e,t){var r;return null!==e?(Empty[PROTOTYPE$1]=_anObject(e),r=new Empty,Empty[PROTOTYPE$1]=null,r[IE_PROTO$2]=e):r=createDict(),void 0===t?r:_objectDps(r,t)},gOPN$1=_objectGopn.f,toString$1={}.toString,windowNames="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],getWindowNames=function(e){try{return gOPN$1(e)}catch(e){return windowNames.slice()}},f$7=function(e){return windowNames&&"[object Window]"==toString$1.call(e)?getWindowNames(e):gOPN$1(_toIobject(e))},_objectGopnExt={f:f$7},META=_meta.KEY,gOPD$1=_objectGopd.f,dP$2=_objectDp.f,gOPN$2=_objectGopnExt.f,$Symbol=_global.Symbol,$JSON=_global.JSON,_stringify=$JSON&&$JSON.stringify,PROTOTYPE$2="prototype",HIDDEN=_wks("_hidden"),TO_PRIMITIVE=_wks("toPrimitive"),isEnum={}.propertyIsEnumerable,SymbolRegistry=_shared("symbol-registry"),AllSymbols=_shared("symbols"),OPSymbols=_shared("op-symbols"),ObjectProto$1=Object[PROTOTYPE$2],USE_NATIVE="function"==typeof $Symbol,QObject=_global.QObject,setter=!QObject||!QObject[PROTOTYPE$2]||!QObject[PROTOTYPE$2].findChild,setSymbolDesc=_descriptors&&_fails(function(){return 7!=_objectCreate(dP$2({},"a",{get:function(){return dP$2(this,"a",{value:7}).a}})).a})?function(e,t,r){var n=gOPD$1(ObjectProto$1,t);n&&delete ObjectProto$1[t],dP$2(e,t,r),n&&e!==ObjectProto$1&&dP$2(ObjectProto$1,t,n)}:dP$2,wrap=function(e){var t=AllSymbols[e]=_objectCreate($Symbol[PROTOTYPE$2]);return t._k=e,t},isSymbol=USE_NATIVE&&"symbol"==typeof $Symbol.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof $Symbol},$defineProperty=function(e,t,r){return e===ObjectProto$1&&$defineProperty(OPSymbols,t,r),_anObject(e),t=_toPrimitive(t,!0),_anObject(r),_has(AllSymbols,t)?(r.enumerable?(_has(e,HIDDEN)&&e[HIDDEN][t]&&(e[HIDDEN][t]=!1),r=_objectCreate(r,{enumerable:_propertyDesc(0,!1)})):(_has(e,HIDDEN)||dP$2(e,HIDDEN,_propertyDesc(1,{})),e[HIDDEN][t]=!0),setSymbolDesc(e,t,r)):dP$2(e,t,r)},$defineProperties=function(e,t){_anObject(e);for(var r,n=_enumKeys(t=_toIobject(t)),i=0,o=n.length;o>i;)$defineProperty(e,r=n[i++],t[r]);return e},$create=function(e,t){return void 0===t?_objectCreate(e):$defineProperties(_objectCreate(e),t)},$propertyIsEnumerable=function(e){var t=isEnum.call(this,e=_toPrimitive(e,!0));return!(this===ObjectProto$1&&_has(AllSymbols,e)&&!_has(OPSymbols,e))&&(!(t||!_has(this,e)||!_has(AllSymbols,e)||_has(this,HIDDEN)&&this[HIDDEN][e])||t)},$getOwnPropertyDescriptor=function(e,t){if(e=_toIobject(e),t=_toPrimitive(t,!0),e!==ObjectProto$1||!_has(AllSymbols,t)||_has(OPSymbols,t)){var r=gOPD$1(e,t);return!r||!_has(AllSymbols,t)||_has(e,HIDDEN)&&e[HIDDEN][t]||(r.enumerable=!0),r}},$getOwnPropertyNames=function(e){for(var t,r=gOPN$2(_toIobject(e)),n=[],i=0;r.length>i;)_has(AllSymbols,t=r[i++])||t==HIDDEN||t==META||n.push(t);return n},$getOwnPropertySymbols=function(e){for(var t,r=e===ObjectProto$1,n=gOPN$2(r?OPSymbols:_toIobject(e)),i=[],o=0;n.length>o;)!_has(AllSymbols,t=n[o++])||r&&!_has(ObjectProto$1,t)||i.push(AllSymbols[t]);return i};USE_NATIVE||(_redefine(($Symbol=function(){if(this instanceof $Symbol)throw TypeError("Symbol is not a constructor!");var e=_uid(arguments.length>0?arguments[0]:void 0),t=function(r){this===ObjectProto$1&&t.call(OPSymbols,r),_has(this,HIDDEN)&&_has(this[HIDDEN],e)&&(this[HIDDEN][e]=!1),setSymbolDesc(this,e,_propertyDesc(1,r))};return _descriptors&&setter&&setSymbolDesc(ObjectProto$1,e,{configurable:!0,set:t}),wrap(e)})[PROTOTYPE$2],"toString",function(){return this._k}),_objectGopd.f=$getOwnPropertyDescriptor,_objectDp.f=$defineProperty,_objectGopn.f=_objectGopnExt.f=$getOwnPropertyNames,_objectPie.f=$propertyIsEnumerable,_objectGops.f=$getOwnPropertySymbols,_descriptors&&!_library&&_redefine(ObjectProto$1,"propertyIsEnumerable",$propertyIsEnumerable,!0),_wksExt.f=function(e){return wrap(_wks(e))}),_export(_export.G+_export.W+_export.F*!USE_NATIVE,{Symbol:$Symbol});for(var es6Symbols="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),j=0;es6Symbols.length>j;)_wks(es6Symbols[j++]);for(var wellKnownSymbols=_objectKeys(_wks.store),k=0;wellKnownSymbols.length>k;)_wksDefine(wellKnownSymbols[k++]);_export(_export.S+_export.F*!USE_NATIVE,"Symbol",{for:function(e){return _has(SymbolRegistry,e+="")?SymbolRegistry[e]:SymbolRegistry[e]=$Symbol(e)},keyFor:function(e){if(!isSymbol(e))throw TypeError(e+" is not a symbol!");for(var t in SymbolRegistry)if(SymbolRegistry[t]===e)return t},useSetter:function(){setter=!0},useSimple:function(){setter=!1}}),_export(_export.S+_export.F*!USE_NATIVE,"Object",{create:$create,defineProperty:$defineProperty,defineProperties:$defineProperties,getOwnPropertyDescriptor:$getOwnPropertyDescriptor,getOwnPropertyNames:$getOwnPropertyNames,getOwnPropertySymbols:$getOwnPropertySymbols}),$JSON&&_export(_export.S+_export.F*(!USE_NATIVE||_fails(function(){var e=$Symbol();return"[null]"!=_stringify([e])||"{}"!=_stringify({a:e})||"{}"!=_stringify(Object(e))})),"JSON",{stringify:function(e){for(var t,r,n=[e],i=1;arguments.length>i;)n.push(arguments[i++]);if(r=t=n[1],(_isObject(t)||void 0!==e)&&!isSymbol(e))return _isArray(t)||(t=function(e,t){if("function"==typeof r&&(t=r.call(this,e,t)),!isSymbol(t))return t}),n[1]=t,_stringify.apply($JSON,n)}}),$Symbol[PROTOTYPE$2][TO_PRIMITIVE]||_hide($Symbol[PROTOTYPE$2],TO_PRIMITIVE,$Symbol[PROTOTYPE$2].valueOf),_setToStringTag($Symbol,"Symbol"),_setToStringTag(Math,"Math",!0),_setToStringTag(_global.JSON,"JSON",!0),_wksDefine("asyncIterator");var quot=/"/g,createHTML=function(e,t,r,n){var i=String(_defined(e)),o="<"+t;return""!==r&&(o+=" "+r+'="'+String(n).replace(quot,"&quot;")+'"'),o+">"+i+"</"+t+">"},_stringHtml=function(e,t){var r={};r[e]=t(createHTML),_export(_export.P+_export.F*_fails(function(){var t=""[e]('"');return t!==t.toLowerCase()||t.split('"').length>3}),"String",r)};_stringHtml("anchor",function(e){return function(t){return e(this,"a","name",t)}}),_stringHtml("big",function(e){return function(){return e(this,"big","","")}}),_stringHtml("blink",function(e){return function(){return e(this,"blink","","")}}),_stringHtml("bold",function(e){return function(){return e(this,"b","","")}}),_stringHtml("fixed",function(e){return function(){return e(this,"tt","","")}}),_stringHtml("fontcolor",function(e){return function(t){return e(this,"font","color",t)}}),_stringHtml("fontsize",function(e){return function(t){return e(this,"font","size",t)}}),_stringHtml("italics",function(e){return function(){return e(this,"i","","")}}),_stringHtml("link",function(e){return function(t){return e(this,"a","href",t)}}),_stringHtml("small",function(e){return function(){return e(this,"small","","")}}),_stringHtml("strike",function(e){return function(){return e(this,"strike","","")}}),_stringHtml("sub",function(e){return function(){return e(this,"sub","","")}}),_stringHtml("sup",function(e){return function(){return e(this,"sup","","")}});var navigator=_global.navigator,_userAgent=navigator&&navigator.userAgent||"",slice=[].slice,MSIE=/MSIE .\./.test(_userAgent),wrap$1=function(e){return function(t,r){var n=arguments.length>2,i=!!n&&slice.call(arguments,2);return e(n?function(){("function"==typeof t?t:Function(t)).apply(this,i)}:t,r)}};_export(_export.G+_export.B+_export.F*MSIE,{setTimeout:wrap$1(_global.setTimeout),setInterval:wrap$1(_global.setInterval)});var defer,channel,port,_invoke=function(e,t,r){var n=void 0===r;switch(t.length){case 0:return n?e():e.call(r);case 1:return n?e(t[0]):e.call(r,t[0]);case 2:return n?e(t[0],t[1]):e.call(r,t[0],t[1]);case 3:return n?e(t[0],t[1],t[2]):e.call(r,t[0],t[1],t[2]);case 4:return n?e(t[0],t[1],t[2],t[3]):e.call(r,t[0],t[1],t[2],t[3])}return e.apply(r,t)},process=_global.process,setTask=_global.setImmediate,clearTask=_global.clearImmediate,MessageChannel=_global.MessageChannel,Dispatch=_global.Dispatch,counter=0,queue={},ONREADYSTATECHANGE="onreadystatechange",run=function(){var e=+this;if(queue.hasOwnProperty(e)){var t=queue[e];delete queue[e],t()}},listener=function(e){run.call(e.data)};setTask&&clearTask||(setTask=function(e){for(var t=[],r=1;arguments.length>r;)t.push(arguments[r++]);return queue[++counter]=function(){_invoke("function"==typeof e?e:Function(e),t)},defer(counter),counter},clearTask=function(e){delete queue[e]},"process"==_cof(process)?defer=function(e){process.nextTick(_ctx(run,e,1))}:Dispatch&&Dispatch.now?defer=function(e){Dispatch.now(_ctx(run,e,1))}:MessageChannel?(port=(channel=new MessageChannel).port2,channel.port1.onmessage=listener,defer=_ctx(port.postMessage,port,1)):_global.addEventListener&&"function"==typeof postMessage&&!_global.importScripts?(defer=function(e){_global.postMessage(e+"","*")},_global.addEventListener("message",listener,!1)):defer=ONREADYSTATECHANGE in _domCreate("script")?function(e){_html.appendChild(_domCreate("script"))[ONREADYSTATECHANGE]=function(){_html.removeChild(this),run.call(e)}}:function(e){setTimeout(_ctx(run,e,1),0)});var _task={set:setTask,clear:clearTask};_export(_export.G+_export.B,{setImmediate:_task.set,clearImmediate:_task.clear});var UNSCOPABLES=_wks("unscopables"),ArrayProto=Array.prototype;null==ArrayProto[UNSCOPABLES]&&_hide(ArrayProto,UNSCOPABLES,{});var _addToUnscopables=function(e){ArrayProto[UNSCOPABLES][e]=!0},_iterStep=function(e,t){return{value:t,done:!!e}},_iterators={},IteratorPrototype={};_hide(IteratorPrototype,_wks("iterator"),function(){return this});var _iterCreate=function(e,t,r){e.prototype=_objectCreate(IteratorPrototype,{next:_propertyDesc(1,r)}),_setToStringTag(e,t+" Iterator")},ITERATOR=_wks("iterator"),BUGGY=!([].keys&&"next"in[].keys()),FF_ITERATOR="@@iterator",KEYS="keys",VALUES="values",returnThis=function(){return this},_iterDefine=function(e,t,r,n,i,o,a){_iterCreate(r,t,n);var s,c,l,u=function(e){if(!BUGGY&&e in p)return p[e];switch(e){case KEYS:case VALUES:return function(){return new r(this,e)}}return function(){return new r(this,e)}},h=t+" Iterator",f=i==VALUES,d=!1,p=e.prototype,g=p[ITERATOR]||p[FF_ITERATOR]||i&&p[i],m=g||u(i),y=i?f?u("entries"):m:void 0,_="Array"==t&&p.entries||g;if(_&&(l=_objectGpo(_.call(new e)))!==Object.prototype&&l.next&&(_setToStringTag(l,h,!0),"function"!=typeof l[ITERATOR]&&_hide(l,ITERATOR,returnThis)),f&&g&&g.name!==VALUES&&(d=!0,m=function(){return g.call(this)}),(BUGGY||d||!p[ITERATOR])&&_hide(p,ITERATOR,m),_iterators[t]=m,_iterators[h]=returnThis,i)if(s={values:f?m:u(VALUES),keys:o?m:u(KEYS),entries:y},a)for(c in s)c in p||_redefine(p,c,s[c]);else _export(_export.P+_export.F*(BUGGY||d),t,s);return s},es6_array_iterator=_iterDefine(Array,"Array",function(e,t){this._t=_toIobject(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,r=this._i++;return!e||r>=e.length?(this._t=void 0,_iterStep(1)):_iterStep(0,"keys"==t?r:"values"==t?e[r]:[r,e[r]])},"values");_iterators.Arguments=_iterators.Array,_addToUnscopables("keys"),_addToUnscopables("values"),_addToUnscopables("entries");for(var ITERATOR$1=_wks("iterator"),TO_STRING_TAG=_wks("toStringTag"),ArrayValues=_iterators.Array,DOMIterables={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},collections=_objectKeys(DOMIterables),i$1=0;i$1<collections.length;i$1++){var key,NAME=collections[i$1],explicit=DOMIterables[NAME],Collection=_global[NAME],proto$1=Collection&&Collection.prototype;if(proto$1&&(proto$1[ITERATOR$1]||_hide(proto$1,ITERATOR$1,ArrayValues),proto$1[TO_STRING_TAG]||_hide(proto$1,TO_STRING_TAG,NAME),_iterators[NAME]=ArrayValues,explicit))for(key in es6_array_iterator)proto$1[key]||_redefine(proto$1,key,es6_array_iterator[key],!0)}function findNextPowerOf2(e){let t=1;for(;e>t;)t<<=1;return t}const arrayAccessor=new RegExp(/(.+)\[(\d+)\]$/),getProp=(e,t)=>{const r=arrayAccessor.exec(t);if(r){const t=e[r[1]];return null!=t?t[parseInt(r[2],10)]:void 0}return e[t]},get=(e,t)=>{if(null!=e){if(t in e)return e[t];const r=t.split(/[.]/),n=getProp(e,r.shift());return null!=n&&r.length?get(n,r.join(".")):n}};var hexCol2rgb=e=>{const t=e.startsWith("#")?1:0;return[parseInt(e.substring(t,t+2),16),parseInt(e.substring(t+2,t+4),16),parseInt(e.substring(t+4,t+6),16)]},hexCol2rgba=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:255;const r=e.startsWith("#")?1:0;return[parseInt(e.substring(r,r+2),16),parseInt(e.substring(r+2,r+4),16),parseInt(e.substring(r+4,r+6),16),t]};const isPowerOf2=e=>0!==e&&0==(e&e-1),DEG2RAD=Math.PI/180;var makeCircleCoords=function(e){const t=.5*(arguments.length>1&&void 0!==arguments[1]?arguments[1]:1),r=360/e,n=[];for(let i=0,o=0;i<e;i++)n.push([t*Math.sin(o*DEG2RAD),t*Math.cos(o*DEG2RAD)]),o+=r;return n};const maxOf=(e,t)=>e>t?e:t;var pick=e=>t=>{const r={};return t&&e.forEach(e=>{const n=t[e];void 0!==n&&(r[e]=n)}),r},readOption=(e,t,r,n)=>{if(e){const r=e[t];if(void 0!==r)return r}return"function"==typeof r?r.call(null,n):r},sample=e=>e[Math.random()*e.length|0],toFloatColors=e=>e.map(e=>e/255),index=Object.freeze({findNextPowerOf2:findNextPowerOf2,get:get,hexCol2rgb:hexCol2rgb,hexCol2rgba:hexCol2rgba,isPowerOf2:isPowerOf2,makeCircleCoords:makeCircleCoords,maxOf:maxOf,pick:pick,readOption:readOption,sample:sample,toFloatColors:toFloatColors});const isNumber=e=>"number"==typeof e,add=(e,t)=>{if(isNumber(e)&&isNumber(t))return e+t;if(isNumber(e))switch(e){case 0:return t;default:return`${e} + ${t}`}else{if(!isNumber(t))return`${e} + ${t}`;switch(t){case 0:return e;default:return`${e} + ${t}`}}},sub=(e,t)=>{if(isNumber(e)&&isNumber(t))return e-t;if(isNumber(e))switch(e){case 0:return`-${t}`;default:return`${e} - ${t}`}else{if(!isNumber(t))return`${e} - ${t}`;switch(t){case 0:return e;default:return`${e} - ${t}`}}},mul=(e,t)=>{if(isNumber(t)&&isNumber(e))return e*t;if(isNumber(e))switch(e){case 0:return 0;case 1:return t;default:return`${e} * ${t}`}else{if(!isNumber(t))return`${e} * ${t}`;switch(t){case 0:return 0;case 1:return e;default:return`${e} * ${t}`}}},asFloat=e=>{const t=`${e}`.trim();return t.match(/^[0-9]+$/)?`${t}.0`:t},ret=e=>`return ${e};`,mat4=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,l=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,u=arguments.length>10&&void 0!==arguments[10]?arguments[10]:0,h=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,f=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,p=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,g=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;const m=(arguments.length>16&&void 0!==arguments[16]?arguments[16]:asFloat)||(e=>`${e}`);return`mat4(${m(e)}, ${m(t)}, ${m(r)}, ${m(n)}, ${m(i)}, ${m(o)}, ${m(a)}, ${m(s)}, ${m(c)}, ${m(l)}, ${m(u)}, ${m(h)}, ${m(f)}, ${m(d)}, ${m(p)}, ${m(g)})`},rotate=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"rotate",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return`\nmat4 ${e}(float angle) {\n  float s = sin(angle);\n  float c = cos(angle);\n  float oc = 1.0 - c;\n  ${ret(mat4(add(mul("oc",t*t),"c"),sub(mul("oc",t*r),mul(n,"s")),add(mul("oc",n*t),mul(r,"s")),0,add(mul("oc",t*r),mul(n,"s")),add(mul("oc",r*r),"c"),sub(mul("oc",r*n),mul(t,"s")),0,sub(mul("oc",n*t),mul(r,"s")),add(mul("oc",r*n),mul(t,"s")),add(mul("oc",n*n),"c")))}\n}`},rotateZ=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"rotateZ";return rotate(e,0,0,1)};var ShaderTool=Object.freeze({add:add,sub:sub,mul:mul,asFloat:asFloat,ret:ret,mat4:mat4,rotate:rotate,rotateZ:rotateZ});class AABB2{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;e<t?(this.minX=e,this.maxX=t):(this.minX=t,this.maxX=e),r<n?(this.minY=r,this.maxY=n):(this.minY=n,this.maxY=r)}get width(){return this.maxX-this.minX}get height(){return this.maxY-this.minY}set width(e){this.maxX=this.minX+e}set height(e){this.maxY=this.minY+e}get centerX(){return this.minX+(this.maxX-this.minX)/2}get centerY(){return this.minY+(this.maxY-this.minY)/2}addPoint(e,t){e<this.minX?this.minX=e:e>this.maxX&&(this.maxX=e),t<this.minY?this.minY=t:t>this.maxY&&(this.maxY=t)}isInside(e,t){return e>=this.minX&&e<this.maxX&&t>=this.minY&&t<this.maxY}isIntersection(e){return!(e.maxX<=this.minX||e.minX>=this.maxX||e.maxY<=this.minY||e.minY>=this.maxY)}}const uuid=()=>([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^16*Math.random()>>e/4).toString(16));class DataRef{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.type=e,this.data_=t,this.id=r&&r.id?String(r.id):uuid(),this.serial=r&&"number"==typeof r.serial?r.serial:1,this.hints=r}get data(){return this.data_}set data(e){e!==this.data_&&(this.data_=e,this.touch())}touch(){this.serial++}isSynced(e){const t=this.serial;return t>0&&t===e.serial}needSync(e){return!this.isSynced(e)}sync(e,t){this.needSync(e)&&(t(this.data),this.serial=e.serial)}hasHint(e,t){return 1===arguments.length?Boolean(this.hints&&e in this.hints):Boolean(this.hints&&e in this.hints&&this.hints[e]===t)}hint(e){return this.hints&&this.hints[e]}}class ElementIndexArray{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"static";this.objectCount=e,this.itemCount=t,this.length=e*t,this.array=new Uint16Array(this.length),this.ref=new DataRef("ElementIndexArray",this,{usage:r,target:"ELEMENT_ARRAY_BUFFER",typedArray:this.array})}static Generate(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"static";const o=new ElementIndexArray(e,t.length,i);for(let i=0;i<e;++i)for(let e=0;e<t.length;++e)o.array[i*o.itemCount+e]=t[e]+(i+n)*r;return o}}class IndexedPrimitive{constructor(e,t){this.primitiveType=e,this.elementIndexArray=t}static createQuads(e){return new IndexedPrimitive("TRIANGLES",ElementIndexArray.Generate(e,[0,1,2,0,2,3],4))}}var EPSILON=1e-6,ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array,degree=Math.PI/180;function create$2(){var e=new ARRAY_TYPE(9);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function create$3(){var e=new ARRAY_TYPE(16);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function copy$3(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function identity$3(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function multiply$3(e,t,r){var n=t[0],i=t[1],o=t[2],a=t[3],s=t[4],c=t[5],l=t[6],u=t[7],h=t[8],f=t[9],d=t[10],p=t[11],g=t[12],m=t[13],y=t[14],_=t[15],b=r[0],v=r[1],A=r[2],E=r[3];return e[0]=b*n+v*s+A*h+E*g,e[1]=b*i+v*c+A*f+E*m,e[2]=b*o+v*l+A*d+E*y,e[3]=b*a+v*u+A*p+E*_,b=r[4],v=r[5],A=r[6],E=r[7],e[4]=b*n+v*s+A*h+E*g,e[5]=b*i+v*c+A*f+E*m,e[6]=b*o+v*l+A*d+E*y,e[7]=b*a+v*u+A*p+E*_,b=r[8],v=r[9],A=r[10],E=r[11],e[8]=b*n+v*s+A*h+E*g,e[9]=b*i+v*c+A*f+E*m,e[10]=b*o+v*l+A*d+E*y,e[11]=b*a+v*u+A*p+E*_,b=r[12],v=r[13],A=r[14],E=r[15],e[12]=b*n+v*s+A*h+E*g,e[13]=b*i+v*c+A*f+E*m,e[14]=b*o+v*l+A*d+E*y,e[15]=b*a+v*u+A*p+E*_,e}function translate$2(e,t,r){var n=r[0],i=r[1],o=r[2],a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,f=void 0,d=void 0,p=void 0,g=void 0,m=void 0,y=void 0;return t===e?(e[12]=t[0]*n+t[4]*i+t[8]*o+t[12],e[13]=t[1]*n+t[5]*i+t[9]*o+t[13],e[14]=t[2]*n+t[6]*i+t[10]*o+t[14],e[15]=t[3]*n+t[7]*i+t[11]*o+t[15]):(a=t[0],s=t[1],c=t[2],l=t[3],u=t[4],h=t[5],f=t[6],d=t[7],p=t[8],g=t[9],m=t[10],y=t[11],e[0]=a,e[1]=s,e[2]=c,e[3]=l,e[4]=u,e[5]=h,e[6]=f,e[7]=d,e[8]=p,e[9]=g,e[10]=m,e[11]=y,e[12]=a*n+u*i+p*o+t[12],e[13]=s*n+h*i+g*o+t[13],e[14]=c*n+f*i+m*o+t[14],e[15]=l*n+d*i+y*o+t[15]),e}function scale$3(e,t,r){var n=r[0],i=r[1],o=r[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function rotateX(e,t,r){var n=Math.sin(r),i=Math.cos(r),o=t[4],a=t[5],s=t[6],c=t[7],l=t[8],u=t[9],h=t[10],f=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*i+l*n,e[5]=a*i+u*n,e[6]=s*i+h*n,e[7]=c*i+f*n,e[8]=l*i-o*n,e[9]=u*i-a*n,e[10]=h*i-s*n,e[11]=f*i-c*n,e}function rotateY(e,t,r){var n=Math.sin(r),i=Math.cos(r),o=t[0],a=t[1],s=t[2],c=t[3],l=t[8],u=t[9],h=t[10],f=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*i-l*n,e[1]=a*i-u*n,e[2]=s*i-h*n,e[3]=c*i-f*n,e[8]=o*n+l*i,e[9]=a*n+u*i,e[10]=s*n+h*i,e[11]=c*n+f*i,e}function rotateZ$1(e,t,r){var n=Math.sin(r),i=Math.cos(r),o=t[0],a=t[1],s=t[2],c=t[3],l=t[4],u=t[5],h=t[6],f=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*i+l*n,e[1]=a*i+u*n,e[2]=s*i+h*n,e[3]=c*i+f*n,e[4]=l*i-o*n,e[5]=u*i-a*n,e[6]=h*i-s*n,e[7]=f*i-c*n,e}function perspective(e,t,r,n,i){var o=1/Math.tan(t/2),a=void 0;return e[0]=o/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(a=1/(n-i),e[10]=(i+n)*a,e[14]=2*i*n*a):(e[10]=-1,e[14]=-2*n),e}function ortho(e,t,r,n,i,o,a){var s=1/(t-r),c=1/(n-i),l=1/(o-a);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*c,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*l,e[11]=0,e[12]=(t+r)*s,e[13]=(i+n)*c,e[14]=(a+o)*l,e[15]=1,e}function create$4(){var e=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function length(e){var t=e[0],r=e[1],n=e[2];return Math.sqrt(t*t+r*r+n*n)}function fromValues$4(e,t,r){var n=new ARRAY_TYPE(3);return n[0]=e,n[1]=t,n[2]=r,n}function normalize(e,t){var r=t[0],n=t[1],i=t[2],o=r*r+n*n+i*i;return o>0&&(o=1/Math.sqrt(o),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o),e}function dot(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function cross(e,t,r){var n=t[0],i=t[1],o=t[2],a=r[0],s=r[1],c=r[2];return e[0]=i*c-o*s,e[1]=o*a-n*c,e[2]=n*s-i*a,e}var len=length,forEach=function(){var e=create$4();return function(t,r,n,i,o,a){var s=void 0,c=void 0;for(r||(r=3),n||(n=0),c=i?Math.min(i*r+n,t.length):t.length,s=n;s<c;s+=r)e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],o(e,e,a),t[s]=e[0],t[s+1]=e[1],t[s+2]=e[2];return t}}();function create$5(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function normalize$1(e,t){var r=t[0],n=t[1],i=t[2],o=t[3],a=r*r+n*n+i*i+o*o;return a>0&&(a=1/Math.sqrt(a),e[0]=r*a,e[1]=n*a,e[2]=i*a,e[3]=o*a),e}var forEach$1=function(){var e=create$5();return function(t,r,n,i,o,a){var s=void 0,c=void 0;for(r||(r=4),n||(n=0),c=i?Math.min(i*r+n,t.length):t.length,s=n;s<c;s+=r)e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],e[3]=t[s+3],o(e,e,a),t[s]=e[0],t[s+1]=e[1],t[s+2]=e[2],t[s+3]=e[3];return t}}();function create$6(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function setAxisAngle(e,t,r){r*=.5;var n=Math.sin(r);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(r),e}function slerp(e,t,r,n){var i=t[0],o=t[1],a=t[2],s=t[3],c=r[0],l=r[1],u=r[2],h=r[3],f=void 0,d=void 0,p=void 0,g=void 0,m=void 0;return(d=i*c+o*l+a*u+s*h)<0&&(d=-d,c=-c,l=-l,u=-u,h=-h),1-d>EPSILON?(f=Math.acos(d),p=Math.sin(f),g=Math.sin((1-n)*f)/p,m=Math.sin(n*f)/p):(g=1-n,m=n),e[0]=g*i+m*c,e[1]=g*o+m*l,e[2]=g*a+m*u,e[3]=g*s+m*h,e}function fromMat3(e,t){var r=t[0]+t[4]+t[8],n=void 0;if(r>0)n=Math.sqrt(r+1),e[3]=.5*n,n=.5/n,e[0]=(t[5]-t[7])*n,e[1]=(t[6]-t[2])*n,e[2]=(t[1]-t[3])*n;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);var o=(i+1)%3,a=(i+2)%3;n=Math.sqrt(t[3*i+i]-t[3*o+o]-t[3*a+a]+1),e[i]=.5*n,n=.5/n,e[3]=(t[3*o+a]-t[3*a+o])*n,e[o]=(t[3*o+i]+t[3*i+o])*n,e[a]=(t[3*a+i]+t[3*i+a])*n}return e}var normalize$2=normalize$1,rotationTo=function(){var e=create$4(),t=fromValues$4(1,0,0),r=fromValues$4(0,1,0);return function(n,i,o){var a=dot(i,o);return a<-.999999?(cross(e,t,i),len(e)<1e-6&&cross(e,r,i),normalize(e,e),setAxisAngle(n,e,Math.PI),n):a>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(cross(e,i,o),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=1+a,normalize$2(n,n))}}(),sqlerp=function(){var e=create$6(),t=create$6();return function(r,n,i,o,a,s){return slerp(e,n,a,s),slerp(t,i,o,s),slerp(r,e,t,2*s*(1-s)),r}}(),setAxes=function(){var e=create$2();return function(t,r,n,i){return e[0]=n[0],e[3]=n[1],e[6]=n[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=-r[0],e[5]=-r[1],e[8]=-r[2],normalize$2(t,fromMat3(t,e))}}();function create$8(){var e=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0),e}var forEach$2=function(){var e=create$8();return function(t,r,n,i,o,a){var s=void 0,c=void 0;for(r||(r=2),n||(n=0),c=i?Math.min(i*r+n,t.length):t.length,s=n;s<c;s+=r)e[0]=t[s],e[1]=t[s+1],o(e,e,a),t[s]=e[0],t[s+1]=e[1];return t}}();const DEG2RAD$1=Math.PI/180;class Mat4{constructor(){this.mat4=create$3()}identity(){identity$3(this.mat4)}ortho(e,t){const r=e>>1,n=t>>1,i=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:65536)>>1;ortho(this.mat4,-r,r,-n,n,-i,i)}perspective(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100;const n=e/t,i=t/2,o=2*Math.atan(i/r);perspective(this.mat4,o,n,0,2e3),translate$2(this.mat4,this.mat4,[0,0,-r])}translate(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;translate$2(this.mat4,this.mat4,[e,t,r])}scale(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;scale$3(this.mat4,this.mat4,[e,t,r])}rotateX(e){rotateX(this.mat4,this.mat4,e*DEG2RAD$1)}rotateY(e){rotateY(this.mat4,this.mat4,e*DEG2RAD$1)}rotateZ(e){rotateZ$1(this.mat4,this.mat4,e*DEG2RAD$1)}multiply(e,t){multiply$3(this.mat4,e.mat4,t.mat4)}copy(e){copy$3(this.mat4,e.mat4)}clone(){const e=new Mat4;return e.copy(this),e}get x(){return this.mat4[12]}set x(e){this.mat4[12]=e}get y(){return this.mat4[13]}set y(e){this.mat4[13]=e}get z(){return this.mat4[14]}set z(e){this.mat4[14]=e}get sx(){return this.mat4[0]}set sx(e){this.mat4[0]=e}get sy(){return this.mat4[5]}set sy(e){this.mat4[5]=e}get sz(){return this.mat4[10]}set sz(e){this.mat4[10]=e}}function convertToPowerOf2(e){const t=findNextPowerOf2(e.width),r=findNextPowerOf2(e.height),n=document.createElement("canvas");return n.width=t,n.height=r,n.getContext("2d").drawImage(e,0,0),n}function setPowerOf2ImgEl(e,t){e.imgEl=isPowerOf2(t.width)&&isPowerOf2(t.height)?t:convertToPowerOf2(t),e.origWidth=t.width,e.origHeight=t.height}class PowerOf2Image{constructor(e){let t;"string"==typeof e?(t=new window.Image).src=e:t=e,!1===t.onLoaded||0===t.width&&0===t.height?(this.imgEl=null,this.onLoaded=new Promise(e=>{const r=t.onload;t.onload=(()=>{r&&r.call(t),setPowerOf2ImgEl(this,t),e(this)})})):(setPowerOf2ImgEl(this,t),this.onLoaded=Promise.resolve(this))}get isComplete(){return null!=this.imgEl}get width(){return this.imgEl&&this.imgEl.width||0}get height(){return this.imgEl&&this.imgEl.height||0}}const COVER="cover",CONTAIN="contain",FILL="fill";class Projection{constructor(e){let t=e.devicePixelRatio,r=e.fit,n=e.height,i=e.perspective,o=e.pixelRatio,a=e.width;this.desiredWidth=a||0,this.desiredHeight=n||0,this.desiredPixelRatio=o,this.customDevicePixelRatio=t,this.fit=r,this.perspective=i,this.lastPerspective=void 0,this.width=0,this.height=0,this.pixelRatio=0,this.rawWidth=0,this.rawHeight=0,this.mat4=new Mat4}get devicePixelRatio(){return this.customDevicePixelRatio||window.devicePixelRatio||1}set perspective(e){this._perspective="number"==typeof e?Math.abs(e):0}get perspective(){return this._perspective}updateOrtho(e,t){const r=this.perspective;return(e!==this.width||t!==this.height||r!==this.lastPerspective)&&(this.width=e,this.height=t,this.lastPerspective=r,r>0?this.mat4.perspective(e,t,r):this.mat4.ortho(e,t),this.pixelRatio=this.rawHeight/t,!0)}update(e,t){this.rawWidth=e,this.rawHeight=t;const r=this.desiredPixelRatio;if("number"==typeof r&&r>0){const n=this.devicePixelRatio*r,i=e/n,o=t/n;return this.updateOrtho(i,o)}if(this.fit===FILL&&this.desiredWidth>0&&this.desiredHeight>0)return this.updateOrtho(this.desiredWidth,this.desiredHeight);if((this.fit===COVER||this.fit===CONTAIN)&&this.desiredWidth>=0&&this.desiredHeight>=0){const r=t/e,n=this.desiredHeight/this.desiredWidth,i=this.fit===COVER;let o=this.desiredWidth,a=this.desiredHeight;if(0===this.desiredWidth&&this.desiredHeight||r<n||1===r&&n>1){if(o=this.desiredHeight/t*e,i){const e=this.desiredWidth/o;o*=e,a*=e}}else if((this.desiredWidth&&0===this.desiredHeight||r>n||1===r&&n<1)&&(a=this.desiredWidth/e*t,i)){const e=this.desiredHeight/a;o*=e,a*=e}return this.updateOrtho(o,a)}return!1}}class ShaderVariable extends DataRef{constructor(e,t,r,n){super(t,r,Object.assign({serial:0},n)),this.name=e}}ShaderVariable.UNIFORM="uniform",ShaderVariable.ATTRIB="attrib",ShaderVariable.TEXTURE_2D="tex2d";class ShaderUniformVariable extends ShaderVariable{constructor(e,t,r){super(e,ShaderVariable.UNIFORM,t,r)}}const PROJECTION_UNIFORM_NAME="projection";class ProjectionUniform extends ShaderUniformVariable{constructor(e){super(arguments.length>1&&void 0!==arguments[1]?arguments[1]:PROJECTION_UNIFORM_NAME,e.mat4,{projection:e})}get projection(){return this.hint("projection")}update(e,t){this.projection.update(e,t)&&this.touch()}}const TYPED_ARRAY={float32:Float32Array,int16:Int16Array,int32:Int32Array,int8:Int8Array,uint16:Uint16Array,uint32:Uint32Array,uint8:Uint8Array},createBufferView=(e,t,r)=>{const n=e*t;if(r instanceof ArrayBuffer){if(n>r.byteLength)throw new TypeError(`VOArray: [data] buffer is too small! needs ${n} bytes (capacity=${e} bytesPerVO=${t}) but has ${r.byteLength} bytes!`);return new DataView(r,0,n)}if(ArrayBuffer.isView(r)){const i=r.byteOffset,o=r.byteLength;if(n>o)throw new TypeError(`VOArray: [data] buffer is too small! needs ${n} bytes (capacity=${e} bytesPerVO=${t}) but has ${o} (byteOffset=${i}) bytes!`);return new DataView(r.buffer,i,n)}throw new TypeError("VOArray: [data] must be instanceof ArrayBuffer, DataView or TypedArray!")},typedArrayProp=e=>`${e}Array`,createLinkedTypedArrays=(e,t,r,n)=>{const i={};return n.forEach(n=>{const o=TYPED_ARRAY[n],a=new o(e,t,r/o.BYTES_PER_ELEMENT);i[typedArrayProp(n)]=a}),i};class VOArray{constructor(e,t,r,n,i){if(t%4!=0)throw new TypeError(`new VOArray: bytesPerVO must be divisible by 4 (but is not!) bytesPerVO=${t}`);if(this.capacity=e,this.bytesPerVO=t,this.arrayTypes=r.slice(0),n){const r=createBufferView(e,t,n);this.buffer=r.buffer,this.bufferByteOffset=r.byteOffset,this.bufferByteLength=r.byteLength}else this.buffer=new ArrayBuffer(e*t),this.bufferByteOffset=0,this.bufferByteLength=this.buffer.byteLength;Object.assign(this,createLinkedTypedArrays(this.buffer,this.bufferByteOffset,this.bufferByteLength,r)),this.ref=new DataRef("VOArray",this,Object.assign({typedArray:this.toUint32Array(),serial:1},i))}copy(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const r=this.bytesPerVO/Uint32Array.BYTES_PER_ELEMENT;let n=0;t>0&&(n=t*r),this.toUint32Array().set(e.toUint32Array(),n)}toUint32Array(){const e=this.uint32Array;if(!e){const e=this.bytesPerVO/Uint32Array.BYTES_PER_ELEMENT;return this.uint32Array=new Uint32Array(this.buffer,this.bufferByteOffset,this.capacity*e),this.uint32Array}return e}subarray(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const r=this.bytesPerVO,n=this.bufferByteOffset+e*r,i=t*r;return new VOArray(t,r,this.arrayTypes,new DataView(this.buffer,n,i))}}const BYTES_PER_ELEMENT={float32:4,int16:2,int32:4,int8:1,uint16:2,uint32:4,uint8:1},TYPED_ARRAY_GETTER={float32:e=>e.float32Array,int32:e=>e.int32Array,int16:e=>e.int16Array,int8:e=>e.int8Array,uint32:e=>e.uint32Array,uint16:e=>e.uint16Array,uint8:e=>e.uint8Array},camelize=e=>e[0].toUpperCase()+e.substr(1),attrPostfix=(e,t,r)=>{if(e.scalars){const t=e.scalars[r];if(void 0!==t)return t}return`${t}_${r}`},getVNu=(e,t)=>(function(r){return e(this.voArray)[t+r]}),setVNu=(e,t,r,n,i)=>(function(){const o=e(this.voArray);for(let e=0;e<r;++e)for(let r=0;r<t;++r)o[e*n+i+r]=arguments[r]}),getV1u=(e,t)=>(function(){return e(this.voArray)[t]}),setVNv=(e,t,r,n,i)=>(function(){const o=e(this.voArray);for(let e=0;e<r;++e)for(let r=0;r<t;++r)o[e*n+i+r]=arguments[e*t+r]}),setV1u=(e,t,r,n)=>(function(i){const o=e(this.voArray);for(let e=0;e<t;++e)o[e*r+n]=i});class VOAttrDescriptor{constructor(e,t,r,n,i,o,a){this.name=e,this.type=t,this.size=r,this.uniform=o,this.scalars=a,this.bytesPerElement=BYTES_PER_ELEMENT[this.type],this.bytesPerVertex=this.bytesPerElement*r,this.byteOffset="number"!=typeof i?n*this.bytesPerElement:i,this.offset="number"!=typeof n?i/this.bytesPerElement:n}vertexAttrCount(e){return e.bytesPerVertex/this.bytesPerElement}static defineProperties(e,t,r){const n=e.name,i=TYPED_ARRAY_GETTER[e.type],o=r.vertexCount,a=e.vertexAttrCount(r),s=e.byteOffset/e.bytesPerElement;if(1===e.size)if(e.uniform){const r=getV1u(i,s),c=setV1u(i,o,a,s);e.getValue=(e=>r.call(e)),e.setValue=((e,t)=>c.call(e,t)),t[n]={get:r,set:c,enumerable:!0}}else{const c=setVNv(i,1,o,a,s);e.setValue=((e,t)=>c.apply(e,t)),t[`set${camelize(n)}`]={value:c,enumerable:!0};const l=[];for(let e=0;e<r.vertexCount;++e){const r=getV1u(i,s+e*a);l.push(r),t[n+e]={get:r,set:setVNv(i,1,1,0,s+e*a),enumerable:!0}}e.getValue=((e,t)=>l[t].call(e))}else if(e.size>=2)if(e.uniform){const r=getVNu(i,s),c=setVNu(i,e.size,o,a,s);e.getValue=((e,t,n)=>r.call(e,n)),e.setValue=((e,t)=>c.apply(e,t)),t[`get${camelize(n)}`]={value:r,enumerable:!0},t[`set${camelize(n)}`]={value:c,enumerable:!0};for(let r=0;r<e.size;++r){t[attrPostfix(e,n,r)]={get:getV1u(i,s+r),set:setV1u(i,o,a,s+r),enumerable:!0}}}else{const c=setVNv(i,e.size,o,a,s);e.setValue=((e,t)=>c.apply(e,t)),t[`set${camelize(n)}`]={value:c,enumerable:!0};const l=[];for(let o=0;o<r.vertexCount;++o){const r=[];for(let c=0;c<e.size;++c){const l=attrPostfix(e,n,c)+o,u=getV1u(i,s+o*a+c);r.push(u),t[l]={get:u,set:setVNv(i,1,1,0,s+o*a+c),enumerable:!0}}l.push(r)}e.getValue=((e,t,r)=>l[t][r].call(e))}}}const DEFAULT_ATTR_TYPE="float32";var createAttributes=(e,t)=>{let r;if(Array.isArray(t)?r=t:"object"==typeof t&&(r=Object.keys(t).map(e=>{const r=t[e];return Object.assign({name:e},Array.isArray(r)?{scalars:r}:r)})),!r)throw new Error("VODescriptor:createAttributes: attributes should be an array or an object!");e.attr={},e.scalars=[];let n=0,i=0;for(let t=0;t<r.length;++t){const o=r[t];let a=o.size;void 0===a&&(a=Array.isArray(o.scalars)?o.scalars.length:1);const s=o.type||"float32";void 0!==o.name&&(e.scalars.push(o.name),e.attr[o.name]=new VOAttrDescriptor(o.name,s,a,n,i,!!o.uniform,o.scalars)),n+=a,i+=BYTES_PER_ELEMENT[s]*a}e.rightPadBytesPerVertex=i%4>0?4-i%4:0,e.bytesPerVertex=i+e.rightPadBytesPerVertex,e.bytesPerVO=e.bytesPerVertex*e.vertexCount,e.vertexAttrCount=n,e.attrList=e.scalars.map(t=>e.attr[t])},createAliases=(e,t)=>{"object"==typeof t&&Object.keys(t).forEach(r=>{let n=t[r];"string"==typeof n?void 0!==(n=e.attr[n])&&(e.attr[r]=n):e.attr[r]=new VOAttrDescriptor(r,n.type,n.size,n.offset,n.byteOffset,!!n.uniform,n.scalars)})};const toArray=e=>(function(t){const r=[],n=Array.isArray(t)?t.map(t=>e.attr[t]):e.attrList,i=n.length;for(let t=0;t<e.vertexCount;++t)for(let e=0;e<i;++e){const i=n[e];for(let e=0;e<i.size;++e)r.push(i.getValue(this,t,e))}return r});var createVOPrototype=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r={toArray:{value:toArray(e)}};Object.keys(e.attr).forEach(t=>{const n=e.attr[t];VOAttrDescriptor.defineProperties(n,r,e)}),e.voPrototype=Object.create(t,r)},createTypedArrays=e=>{e.typedArrays={float32:!1,int16:!1,int32:!1,int8:!1,uint16:!1,uint32:!1,uint8:!1},Object.keys(e.attr).forEach(t=>{e.typedArrays[e.attr[t].type]=!0}),e.typeList=Object.keys(e.typedArrays).filter(t=>e.typedArrays[t]).sort()},createVO=(e,t,r)=>{if(e.descriptor=t,!e.descriptor)throw new Error("VODescriptor:createVO: could not read descriptor!");if(e.voArray=r||e.descriptor.createVOArray(),e.descriptor.bytesPerVO!==e.voArray.bytesPerVO&&e.descriptor.typeList.join()!==e.voArray.arrayTypes.join())throw new TypeError("VODescriptor:createVO: descriptor and voArray are not compatible with each other!");return e};class VODescriptor{constructor(e){let t=e.vertexCount,r=e.instanceOf,n=e.attributes,i=e.aliases,o=e.proto;this.vertexCount=parseInt(t,10)||1,this.isInstanced=null!=r,this.base=r,createAttributes(this,n),createAliases(this,i),createVOPrototype(this,o),createTypedArrays(this)}createVOArray(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return new VOArray(e,this.bytesPerVO,this.typeList,null,Object.assign({descriptor:this,usage:"dynamic",doubleBuffer:!0},t))}createVO(e,t){const r=createVO(Object.create(this.voPrototype),this,e);switch(typeof t){case"function":t(r);break;case"object":Object.keys(t).forEach(e=>{const n=this.attr[e];n?n.setValue(r,t[e]):"function"==typeof r[e]?r[e](t[e]):r[e]=t[e]})}return r}hasAttribute(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const r=this.attr[e];return r&&r.size===t}get maxIndexedVOPoolSize(){return Math.floor(65536/this.vertexCount)}}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){_defineProperty(e,t,r[t])})}return e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw o}}return r}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}class ShaderSource{constructor(e,t,r,n){if(this.id=r||uuid(),this.type=e,this.ctx=Object.assign({},n),t instanceof HTMLElement)this.strings=[t.textContent],this.values=[];else if(Array.isArray(t)){var i=_slicedToArray(t,2);this.strings=i[0],this.values=i[1]}else this.strings=[String(t)],this.values=[]}compile(e){const t=[this.strings[0]],r=Object.assign({},this.ctx,e);return this.values.forEach((e,n)=>{let i=e;if("function"==typeof e)i=e(r);else if(e instanceof ShaderSource){if(e.type!==ShaderSource.PARTIAL)throw new Error(`ShaderSource.compile() panic! Only PARTIAL's are allowed to embed into shader sources! (but type=${e.type})`);i=e.compile(r)}t.push(i,this.strings[n+1])}),t.join("")}}ShaderSource.VERTEX_SHADER="VERTEX_SHADER",ShaderSource.FRAGMENT_SHADER="FRAGMENT_SHADER",ShaderSource.PARTIAL="PARTIAL",ShaderSource.vertexShader=(e=>(function(t){for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return new ShaderSource(ShaderSource.VERTEX_SHADER,[t,n],e&&e.id,e)})),ShaderSource.fragmentShader=(e=>(function(t){for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return new ShaderSource(ShaderSource.FRAGMENT_SHADER,[t,n],e&&e.id,e)})),ShaderSource.partial=(e=>(function(t){for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return new ShaderSource(ShaderSource.PARTIAL,[t,n],e&&e.id,e)})),ShaderSource.fromElement=(e=>{let t=e.getAttribute("type");if("x-shader/vertex"===t)t=ShaderSource.VERTEX_SHADER;else{if("x-shader/fragment"!==t)throw new Error(`ShaderSource.fromElement() panic! Invalid type="${t}" attribute value (should be "x-shader/vertex" or "x-shader/fragment")`);t=ShaderSource.FRAGMENT_SHADER}return new ShaderSource(t,e,e.getAttribute("id"))});class ResourceLibrary{constructor(){this.descriptors=new Map,this.vertexShaders=new Map,this.fragmentShaders=new Map}createDescriptor(e,t){const r=t instanceof VODescriptor?t:new VODescriptor(t);return this.descriptors.set(e,r),e}addVertexShader(e,t){if(t.type!==ShaderSource.VERTEX_SHADER)throw new Error(`addVertexShader: shaderSource has wrong type=${t.type} (expected type=${ShaderSource.VERTEX_SHADER})`);return this.vertexShaders.set(e,t),e}addFragmentShader(e,t){if(t.type!==ShaderSource.FRAGMENT_SHADER)throw new Error(`addFragmentShader: shaderSource has wrong type=${t.type} (expected type=${ShaderSource.FRAGMENT_SHADER})`);return this.fragmentShaders.set(e,t),e}createVertexShader(e){const t=new ShaderSource(ShaderSource.VERTEX_SHADER,e);return this.vertexShaders.set(t.id,t),t.id}createFragmentShader(e){const t=new ShaderSource(ShaderSource.FRAGMENT_SHADER,e);return this.fragmentShaders.set(t.id,t),t.id}getDescriptor(e){return this.descriptors.get(e)}getVertexShader(e){return this.vertexShaders.get(e)}getFragmentShader(e){return this.fragmentShaders.get(e)}}class ShaderAttribVariable extends ShaderVariable{constructor(e,t){super(e,ShaderVariable.ATTRIB,t)}}class ShaderVariableGroup{constructor(e){this.shaderVars=e}pushVar(e){this.shaderVars.forEach(e.pushVar.bind(e))}popVar(e){this.shaderVars.forEach(e.popVar.bind(e))}}function shaderVarMap(e,t){switch(t){case ShaderVariable.UNIFORM:return e.uniform;case ShaderVariable.ATTRIB:return e.attrib;case ShaderVariable.TEXTURE_2D:return e.tex2d;default:return null}}function shaderVarLane(e,t,r){const n=shaderVarMap(e,t);let i=n.get(r);return i||(i=[],n.set(r,i)),i}class ShaderContext{constructor(){this.uniform=new Map,this.attrib=new Map,this.tex2d=new Map}clear(){this.uniform.clear(),this.attrib.clear(),this.tex2d.clear()}pushVar(e){if(e instanceof ShaderVariableGroup)e.pushVar(this);else{shaderVarLane(this,e.type,e.name).push(e)}}popVar(e){if(e instanceof ShaderVariableGroup)e.popVar(this);else{const t=shaderVarLane(this,e.type,e.name),r=t.length;for(let n=0;n<r;++n)if(t[n]===e)return void(t.length=n)}}curVar(e){const t=shaderVarMap(this,e.type).get(e.name);return t&&t.length?t[t.length-1]:null}curUniform(e){const t=this.uniform.get(e);return t&&t.length?t[t.length-1]:null}curAttrib(e){const t=this.attrib.get(e);return t&&t.length?t[t.length-1]:null}curTex2d(e){const t=this.tex2d.get(e);return t&&t.length?t[t.length-1]:null}}class ShaderProgram{constructor(e,t,r){this.id=r||uuid(),this.vertexShader=e,this.fragmentShader=t}}class ShaderUniformGroup extends ShaderVariableGroup{constructor(e){super([]),Object.keys(e).forEach(t=>{this.addUniform(t,e[t])})}addUniform(e,t,r){const n=t instanceof Projection,i=n?new ProjectionUniform(t,e):new ShaderUniformVariable(e,t,r);this.shaderVars.push(i),Object.defineProperty(this,`${e}Uniform`,{value:i,enumerable:!0}),n?Object.defineProperty(this,e,{enumerable:!0,get:()=>i.projection}):Object.defineProperty(this,e,{enumerable:!0,get:()=>i.data,set:e=>{i.data=e}})}}class ShaderAttribValue{constructor(e,t,r){this.name=e,this.descriptor=t,this.bufferSource=r}set bufferSource(e){this.bufferSource_=e,this.ref=e instanceof VOArray?e.ref:e.voArray.ref}get bufferSource(){return this.bufferSource_}get attrDescriptor(){return this.descriptor.attr[this.name]}}class ShaderVariableAlias{constructor(e,t){this.name=e,this.shaderVar=t}get type(){return this.shaderVar.type}get data(){return this.shaderVar.data}get serial(){return this.shaderVar.serial}}class ShaderVariableBufferGroup extends ShaderVariableGroup{constructor(e,t){super([]);const r=t||e.descriptor;let n;Object.keys(r.attr).forEach(t=>{n?this.shaderVars.push(new ShaderVariableAlias(t,n)):(n=new ShaderAttribVariable(t,new ShaderAttribValue(t,r,e)),this.shaderVars.push(n))})}get bufferSource(){return this.shaderVars[0].data.bufferSource}get serial(){return this.shaderVars[0].serial}touch(){return this.shaderVars[0].touch()}}var createVOs=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const r=e.capacity-e.usedCount-e.allocatedCount,n=t>0&&t<r?t:r,i=e.allocatedCount+n;for(let t=e.allocatedCount;t<i;t++){const r=e.voArray.subarray(t),n=e.descriptor.createVO(r);n.free=e.free.bind(e,n),e.availableVOs.push(n)}return n};class VOPool{constructor(e,t){this.id=uuid(),this.descriptor=e,this.capacity=readOption(t,"capacity",this.descriptor.maxIndexedVOPoolSize),this.maxAllocVOSize=readOption(t,"maxAllocVOSize",0),this.voZero=readOption(t,"voZero",()=>e.createVO()),this.voNew=readOption(t,"voNew",()=>e.createVO()),this.usage=readOption(t,"usage","dynamic"),this.voArray=readOption(t,"voArray",()=>e.createVOArray(this.capacity,{usage:this.usage,autotouch:readOption(t,"autotouch","dynamic"===this.usage),doubleBuffer:readOption(t,"doubleBuffer","dynamic"===this.usage)})),this.availableVOs=[],this.usedVOs=[],createVOs(this,this.maxAllocVOSize)}get usedCount(){return this.usedVOs.length}get availableCount(){return this.capacity-this.usedVOs.length}get allocatedCount(){return this.availableVOs.length+this.usedVOs.length}alloc(){let e=this.availableVOs.shift();if(void 0===e){if(!(this.capacity-this.allocatedCount>0))return;createVOs(this,this.maxAllocVOSize),e=this.availableVOs.shift()}return this.usedVOs.push(e),e.voArray.copy(this.voNew.voArray),e}multiAlloc(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.allocatedCount-this.usedCount<e&&createVOs(this,maxOf(this.maxAllocVOSize,e-this.allocatedCount-this.usedCount));for(let r=0;r<e;++r){const e=this.availableVOs.shift();if(void 0===e)break;this.usedVOs.push(e),e.voArray.copy(this.voNew.voArray),t.push(e)}return t}free(e){if(Array.isArray(e))return void e.forEach(this.free.bind(this));const t=this.usedVOs.indexOf(e);if(-1===t)return;const r=this.usedVOs.length-1;if(t!==r){const n=this.usedVOs[r];e.voArray.copy(n.voArray);const i=n.voArray;n.voArray=e.voArray,e.voArray=i,this.usedVOs.splice(t,1,n)}this.usedVOs.pop(),this.availableVOs.unshift(e),e.voArray.copy(this.voZero.voArray)}}const pickVOPoolOpts=pick(["autotouch","capacity","doubleBuffer","maxAllocVOSize","usage","voArray"]),createSpriteSizeHook=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"size";switch(typeof e){case"string":return(t,r,n,i)=>i.attr[e].setValue(t,[r,n]);case"function":return e;case"object":case"boolean":if(!e)return null;default:throw new Error(`SpriteGroup: invalid sprite size setter! (is ${typeof e} but should be a function, string, null or false)`)}};class SpriteGroup{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.descriptor=e,t.base instanceof SpriteGroup?this.base=t.base:"object"==typeof t.base&&(this.base=new SpriteGroup(e.base,t.base));let r=t.voNew,n=t.voZero;r&&(r=e.createVO(null,r)),n&&(n=e.createVO(null,n)),this.spriteHook={setSize:createSpriteSizeHook(t.setSize)},this.voPool=new VOPool(e,Object.assign({maxAllocVOSize:1e3},pickVOPoolOpts(t),{voNew:r,voZero:n})),this.voPoolShaderAttribs=new ShaderVariableBufferGroup(this.voPool);const i=t.primitive;this.primitive="function"==typeof i?i(this.capacity):i,this.shaderProgram=t.shaderProgram,!this.shaderProgram&&t.vertexShader&&t.fragmentShader&&(this.shaderProgram=new ShaderProgram(t.vertexShader,t.fragmentShader))}get capacity(){return this.voPool.capacity}get usedCount(){return this.voPool.usedCount}get availableCount(){return this.voPool.availableCount}createSprite(e,t){const r=this.voPool.alloc(),n=this.spriteHook.setSize;return!n||void 0===e&&void 0===t||n(r,e,void 0!==t?t:e,this.descriptor),r}createSprites(e,t,r){const n=this.voPool.multiAlloc(e),i=this.spriteHook.setSize;if(i&&(void 0!==t||void 0!==r)){const e=void 0!==r?r:t;n.forEach(r=>i(r,t,e,this.descriptor))}return n}touchVertexBuffers(){this.voPool.voArray.ref.touch()}}class StackedContext{constructor(){this.context=new Map}push(e,t){const r=this.context.get(e);return r?(r.push(t),r.length-1):(this.context.set(e,[t]),0)}pop(e,t){const r=this.context.get(e);if(r)return void 0===t?r.pop():r.splice(t,r.length-t)}get(e){const t=this.context.get(e);if(t){const e=t.length;if(e>0)return t[e-1]}}clear(){this.context.forEach(e=>{e.length=0})}}class Texture{constructor(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:void 0,a=t,s=r;if(e instanceof Texture)this.parent=e,this.image=null;else{if(!("object"==typeof e&&"width"in e&&"height"in e))throw new Error("new Texture() panic: unexpected source argument!");this.image=e,this.parent=null,this._ref=new DataRef("Texture",this,{flipY:readOption(o,"flipY",!1),repeatable:readOption(o,"repeatable",!1),premultiplyAlpha:readOption(o,"premultiplyAlpha",!0),nearest:readOption(o,"nearest",!0)}),"origWidth"in e&&"origHeight"in e&&(a=e.origWidth,s=e.origHeight)}this._width=a,this._height=s,this.x=n,this.y=i}get root(){return this.parent&&this.parent.root||this}get imgEl(){const e=this.root;return e.image.imgEl||e.image}get ref(){return this._ref||this.root.ref}get width(){return"number"==typeof this._width?this._width:this.image?this.image.width:this.parent?this.root.width:0}set width(e){this._width=e}get height(){return"number"==typeof this._height?this._height:this.image?this.image.height:this.parent?this.root.height:0}set height(e){this._height=e}get minS(){let e=this.x,t=this;for(;null!=(t=t.parent);)e+=t.x;return e/this.root.image.width}get minT(){let e=this.y,t=this;for(;null!=(t=t.parent);)e+=t.y;return e/this.root.image.height}get maxS(){let e=this.x+this.width,t=this;for(;null!=(t=t.parent);)e+=t.x;return e/this.root.image.width}get maxT(){let e=this.y+this.height,t=this;for(;null!=(t=t.parent);)e+=t.y;return e/this.root.image.height}static async load(e,t){const r=new URL(e,window.location.href).href,n=await new PowerOf2Image(r).onLoaded;return new Texture(n,void 0,void 0,0,0,t)}}class TextureAtlasJsonDef{constructor(e){this.frameNames=Object.keys(e.frames),this.frames=e.frames,this.meta=e.meta,this.imageUrl=e.meta.image}static async load(e,t){const r=await window.fetch(e,t),n=await r.json();return new TextureAtlasJsonDef(n)}}class TextureAtlas{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.rootTexture=e,this.jsonDef=t,this.frames=new Map}addFrame(e,t,r,n,i){this.frames.set(e,new Texture(this.rootTexture,t,r,n,i))}addFrameAlias(e,t){this.frames.has(t)&&this.frames.set(e,this.frames.get(t))}frame(e){return this.frames.get(e)}randomFrame(){return sample(Array.from(this.frames.values()))}randomFrameName(){return sample(this.frameNames())}frameNames(e){const t=Array.from(this.frames.keys());if(e){const r=new RegExp(e);return t.filter(e=>r.test(e))}return t}static async load(e,t){const r=new URL(e,window.location.href).href,n=await TextureAtlasJsonDef.load(r,readOption(t,"fetchOptions")),i=await new PowerOf2Image(readOption(t,"image",()=>new URL(n.imageUrl,r).href,n)).onLoaded,o=new Texture(i,void 0,void 0,0,0,readOption(t,"textureHints")),a=new TextureAtlas(o,n),s=n.frameNames,c=s.length;for(let e=0;e<c;e++){const t=s[e],r=n.frames[t].frame;a.addFrame(t,r.w,r.h,r.x,r.y)}return a}}class TextureHandle{constructor(e){this.texture=null,this.atlas=null,this.onReady=Promise.resolve(e).then(async e=>(e instanceof TextureAtlas?(this.atlas=e,this.texture=e.rootTexture):this.texture=e,e))}}class ShaderTexture2dVariable extends ShaderVariable{constructor(e,t){super(e,ShaderVariable.TEXTURE_2D,t),this.texture=null}}class TextureLibrary{constructor(){this.handles=new Map,this.shaderVars=new Map}loadTexture(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;const n=new TextureHandle(Texture.load(t,r));return this.handles.set(e,n),n.onReady}loadTextureAtlas(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;const n=new TextureHandle(TextureAtlas.load(t,r));return this.handles.set(e,n),n.onReady}getTexture(e){const t=this.handles.get(e);return t&&t.texture}getTextureAtlas(e){const t=this.handles.get(e);return t&&t.atlas}whenLoaded(e,t,r){const n=this.getTexture(e);if(!n)return;let i=this.shaderVars.get(t);i||(i=new ShaderTexture2dVariable(t),this.shaderVars.set(t,i)),i.texture=n,r(i)}}class ShaderTextureGroup{constructor(e,t){this.textureLibrary=e,this.waitFor=Object.keys(t).map(e=>({shaderVarKey:e,textureId:t[e],isLoaded:!1})),this.shaderVarGroup=new ShaderVariableGroup([]),this.shaderVarStore=new Map}get isLoaded(){return 0===this.waitFor.length&&this.shaderVarGroup.shaderVars.length>0}whenLoaded(e){this.isLoaded?e(this.shaderVarGroup):(this.waitFor.forEach(e=>{if(!e.isLoaded){const t=this.textureLibrary.getTexture(e.textureId);if(!t)return;const r=new ShaderTexture2dVariable(e.shaderVarKey);r.texture=t,this.shaderVarGroup.shaderVars.push(r),e.isLoaded=!0}}),this.waitFor=this.waitFor.filter(e=>!1===e.isLoaded),this.isLoaded&&e(this.shaderVarGroup))}}class TexturedSpriteGroup extends SpriteGroup{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(e,t),this.textureLibrary=readOption(t,"textureLibrary",()=>new TextureLibrary);const r=t.setTexCoordsByTexture;this.spriteHook.setTexCoordsByTexture=null===r||!1===r?null:r||((e,t)=>e.setTexCoordsByTexture(t)),this.textures=Object.assign({},t.textures),this.shaderTextureGroup=null}setTexture(e,t){this.textures[e]!==t&&(this.textures[e]=t,this.shaderTextureGroup=null)}loadTextureAtlas(e,t,r){return this.setTexture(e,t),this.textureLibrary.loadTextureAtlas(t,t,r)}getTexture(e){return this.textureLibrary.getTexture(this.textures[e])}getTextureAtlas(e){return this.textureLibrary.getTextureAtlas(this.textures[e])}whenTexturesLoaded(e){this.shaderTextureGroup||(this.shaderTextureGroup=new ShaderTextureGroup(this.textureLibrary,this.textures)),this.shaderTextureGroup.whenLoaded(e)}createSprite(e,t,r){let n,i;e&&void 0===t?(n=e.width,i=e.height):(n=t,i=r);const o=super.createSprite(n,i),a=this.spriteHook.setTexCoordsByTexture;return a&&e&&a(o,e),o}}class Viewport extends AABB2{constructor(e,t,r,n){super(e,e+r,t,t+n)}get x(){return this.minX}set x(e){const t=this.width;this.minX=e,this.maxX=e+t}get y(){return this.minY}set y(e){const t=this.height;this.minY=e,this.maxY=e+t}}var index$1=Object.freeze({ShaderTool:ShaderTool,AABB2:AABB2,DataRef:DataRef,ElementIndexArray:ElementIndexArray,IndexedPrimitive:IndexedPrimitive,Mat4:Mat4,PowerOf2Image:PowerOf2Image,Projection:Projection,ProjectionUniform:ProjectionUniform,ResourceLibrary:ResourceLibrary,ShaderAttribVariable:ShaderAttribVariable,ShaderContext:ShaderContext,ShaderProgram:ShaderProgram,ShaderSource:ShaderSource,ShaderUniformGroup:ShaderUniformGroup,ShaderUniformVariable:ShaderUniformVariable,ShaderVariableBufferGroup:ShaderVariableBufferGroup,SpriteGroup:SpriteGroup,StackedContext:StackedContext,Texture:Texture,TextureAtlas:TextureAtlas,TextureLibrary:TextureLibrary,TexturedSpriteGroup:TexturedSpriteGroup,VOArray:VOArray,VODescriptor:VODescriptor,VOPool:VOPool,Viewport:Viewport,generateUuid:uuid});const toString$2=e=>{let t=e.enable,r=e.sfactor,n=void 0===r?"":r,i=e.dfactor,o=void 0===i?"":i;return JSON.stringify([t,n,o])};let blendModeCache=null;class BlendMode{static make(e,t){null===blendModeCache&&(blendModeCache=new Map,BlendMode.make("off",{enable:!1}),BlendMode.make("additive",{enable:!0,sfactor:"SRC_ALPHA",dfactor:"ONE"}),BlendMode.make("orderDependent",{enable:!0,sfactor:"SRC_ALPHA",dfactor:"ONE_MINUS_SRC_ALPHA"}));let r=blendModeCache.get(e);if(r)return r;if(!t)return;const n=toString$2(t);return(r=blendModeCache.get(n))?(blendModeCache.set(e,r),r):(r=new BlendMode(t),blendModeCache.set(n,r),blendModeCache.set(e,r),r)}constructor(e){let t=e.enable,r=e.sfactor,n=void 0===r?null:r,i=e.dfactor,o=void 0===i?null:i;this.enable=t,this.sfactor=n,this.dfactor=o}set sfactor(e){this._sfactor="string"==typeof e?e:void 0}get sfactor(){return this._sfactor}set dfactor(e){this._dfactor="string"==typeof e?e:void 0}get dfactor(){return this._dfactor}isEqual(e){return e&&this.enable===e.enable&&this._sfactor===e.sfactor&&this._dfactor===e.dfactor}}class TextureUnitManager{constructor(e){this.glx=e,this.boundTextures=new Array(e.MAX_TEXTURE_IMAGE_UNITS);for(let e=0;e<this.boundTextures.length;++e)this.boundTextures[e]=null;this.lastBoundTexUnit=0}bindWebGlTexture(e){let t=this.boundTextures.indexOf(e);if(t<0){for(let r=0;r<this.boundTextures.length;++r)if(!this.boundTextures[r]){t=r,this.boundTextures[r]=e;break}if(t<0){t=this.lastBoundTexUnit;const e=this.boundTextures[t];e&&(e.texUnit=-1),this.lastBoundTexUnit=(this.lastBoundTexUnit+1)%this.glx.MAX_TEXTURE_IMAGE_UNITS}this.glx.activeTexture(t),this.glx.bindTexture2d(e.glTexObj),e.texUnit=t}return t}}const readGlState=e=>{const t=e.gl;e.DEPTH_BITS=t.getParameter(t.DEPTH_BITS),e.STENCIL_BITS=t.getParameter(t.STENCIL_BITS),e.MAX_TEXTURE_IMAGE_UNITS=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),e.boundBuffers.set(t.ARRAY_BUFFER,t.getParameter(t.ARRAY_BUFFER_BINDING)),e.boundBuffers.set(t.ELEMENT_ARRAY_BUFFER,t.getParameter(t.ELEMENT_ARRAY_BUFFER_BINDING)),e.currentProgram=t.getParameter(t.CURRENT_PROGRAM),e.blendEnabled=t.getParameter(t.BLEND)};class WebGlContext{constructor(e){this.gl=e,this.contextAttributes=e.getContextAttributes(),this.currentBlendMode=null,this.boundBuffers=new Map,readGlState(this,e),this.boundTextures=new Array(this.MAX_TEXTURE_IMAGE_UNITS);for(let e=0;e<this.boundTextures.length;e++)this.boundTextures[e]={TEXTURE_2D:null};this.textureUnitManager=new TextureUnitManager(this),this.enabledVertexAttribLocations=[],this.activeTexture(0)}bindBuffer(e,t){this.boundBuffers.get(e)!==t&&(this.gl.bindBuffer(e,t),this.boundBuffers.set(e,t))}activeTexture(e){const t=this.gl,r=t.TEXTURE0+e;this.activeTexUnit!==r&&(this.activeTexUnit=r,t.activeTexture(this.activeTexUnit))}bindTexture2d(e){const t=this.gl,r=this.boundTextures[this.activeTexUnit-t.TEXTURE0];r.TEXTURE_2D!==e&&(r.TEXTURE_2D=e,t.bindTexture(t.TEXTURE_2D,e))}useProgram(e){return this.currentProgram!==e&&(this.gl.useProgram(e),this.currentProgram=e,!0)}enableVertexAttribArrays(e){const t=this.gl;this.enabledVertexAttribLocations.filter(t=>-1===e.indexOf(t)).forEach(r=>{t.disableVertexAttribArray(r),this.enabledVertexAttribLocations.splice(e.indexOf(r),1)}),e.forEach(e=>{-1===this.enabledVertexAttribLocations.indexOf(e)&&(t.enableVertexAttribArray(e),this.enabledVertexAttribLocations.push(e))})}blend(e){if(e===this.currentBlendMode)return;this.currentBlendMode=e;const t=this.gl;e.enable?(this.blendEnabled||(t.enable(t.BLEND),this.blendEnabled=!0),t.blendFunc(t[e.sfactor],t[e.dfactor])):this.blendEnabled&&(t.disable(t.BLEND),this.blendEnabled=!1)}}class WebGl1Context extends WebGlContext{constructor(e){super(e),this.isWebGL1=!0,this.ANGLE_instanced_arrays=e.getExtension("ANGLE_instanced_arrays")}vertexAttribDivisor(e,t){this.ANGLE_instanced_arrays.vertexAttribDivisorANGLE(e,t)}drawElementsInstanced(e,t,r,n,i){this.ANGLE_instanced_arrays.drawElementsInstancedANGLE(e,t,r,n,i)}}class WebGl2Context extends WebGlContext{constructor(e){super(e),this.isWebGL2=!0}vertexAttribDivisor(e,t){this.gl.vertexAttribDivisor(e,t)}drawElementsInstanced(e,t,r,n,i){this.gl.drawElementsInstanced(e,t,r,n,i)}}const readContextAttributes=e=>({alpha:readOption(e,"alpha",!1),depth:readOption(e,"depth",!0),stencil:readOption(e,"stencil",!0),antialias:readOption(e,"antialias",!1),premultipliedAlpha:readOption(e,"premultipliedAlpha",!0),preserveDrawingBuffer:readOption(e,"preserveDrawingBuffer",!1),preferLowPowerToHighPerformance:readOption(e,"preferLowPowerToHighPerformance",!1),failIfMajorPerformanceCaveat:readOption(e,"failIfMajorPerformanceCaveat",!1)});var createWebGlContext=(e,t)=>{const r=readContextAttributes(t);let n;if(!readOption(t,"disableWebGL2",!1)&&(n=e.getContext("webgl2",r)))return new WebGl2Context(n);if(null==(n=e.getContext("webgl",r)||e.getContext("experimental-webgl",r)))throw Error(`createWebGlContext: could not create webgl context with attributes: ${JSON.stringify(r)}`);return new WebGl1Context(n)},loglevel=createCommonjsModule(function(e){var t,r;t=commonjsGlobal,r=function(){var e=function(){},t="undefined",r=["trace","debug","info","warn","error"];function n(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function i(t,n){for(var i=0;i<r.length;i++){var o=r[i];this[o]=i<t?e:this.methodFactory(o,t,n)}this.log=this.debug}function o(r,o,a){return function(r){return"debug"===r&&(r="log"),typeof console!==t&&(void 0!==console[r]?n(console,r):void 0!==console.log?n(console,"log"):e)}(r)||function(e,r,n){return function(){typeof console!==t&&(i.call(this,r,n),this[e].apply(this,arguments))}}.apply(this,arguments)}function a(e,n,a){var s,c=this,l="loglevel";function u(){var e;if(typeof window!==t){try{e=window.localStorage[l]}catch(e){}if(typeof e===t)try{var r=window.document.cookie,n=r.indexOf(encodeURIComponent(l)+"=");-1!==n&&(e=/^([^;]+)/.exec(r.slice(n))[1])}catch(e){}return void 0===c.levels[e]&&(e=void 0),e}}e&&(l+=":"+e),c.name=e,c.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},c.methodFactory=a||o,c.getLevel=function(){return s},c.setLevel=function(n,o){if("string"==typeof n&&void 0!==c.levels[n.toUpperCase()]&&(n=c.levels[n.toUpperCase()]),!("number"==typeof n&&n>=0&&n<=c.levels.SILENT))throw"log.setLevel() called with invalid level: "+n;if(s=n,!1!==o&&function(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t){try{return void(window.localStorage[l]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(l)+"="+n+";"}catch(e){}}}(n),i.call(c,n,e),typeof console===t&&n<c.levels.SILENT)return"No console available for logging"},c.setDefaultLevel=function(e){u()||c.setLevel(e,!1)},c.enableAll=function(e){c.setLevel(c.levels.TRACE,e)},c.disableAll=function(e){c.setLevel(c.levels.SILENT,e)};var h=u();null==h&&(h=null==n?"WARN":n),c.setLevel(h,!1)}var s=new a,c={};s.getLogger=function(e){if("string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=c[e];return t||(t=c[e]=new a(e,s.getLevel(),s.methodFactory)),t};var l=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=l),s},s.getLoggers=function(){return c},s},e.exports?e.exports=r():t.log=r()});class WebGlBuffer{constructor(e,t,r,n){this.glx=e;const i=e.gl;this.target=i[t],this.usage=i[r],this.typedArray=n,this.clonedTypedArray=void 0,this.lastTypedArray=void 0,this.glBuffer=i.createBuffer()}bindBuffer(){this.glx.bindBuffer(this.target,this.glBuffer)}bufferData(e){this.bindBuffer(),this.glx.gl.bufferData(this.target,e||this.typedArray,this.usage)}doubleBufferData(e){const t=e||this.typedArray;void 0===this.clonedTypedArray||t!==this.lastTypedArray?(this.clonedTypedArray=new t.constructor(t.length),this.clonedTypedArray.set(t),this.lastTypedArray=t):this.clonedTypedArray.set(t),this.bufferData(this.clonedTypedArray)}deleteBuffer(){this.glx.gl.deleteBuffer(this.glBuffer)}}WebGlBuffer.ARRAY_BUFFER="ARRAY_BUFFER",WebGlBuffer.ELEMENT_ARRAY_BUFFER="ELEMENT_ARRAY_BUFFER",WebGlBuffer.STATIC_DRAW="STATIC_DRAW",WebGlBuffer.DYNAMIC_DRAW="DYNAMIC_DRAW";const log=loglevel.getLogger("picimo.renderer.WebGlShader"),compileShader=e=>{const t=e.glx.gl,r=e.glShader,n=e.source.compile({glx:e.glx});if(t.shaderSource(r,n),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){const e=t.getShaderInfoLog(r);throw log.debug(`WebGlShader: vertex shader source =>\n${n}`),new Error(`WebGlShader: gl.compileShader(..) panic!\n${e}`)}};class WebGlShader{constructor(e,t){if(this.glx=e,!(t instanceof ShaderSource))throw new Error("WebGlShader panic! source must be an instance of ShaderSource!");this.source=t;const r=e.gl;this.shaderType=r[t.type],this.glShader=r.createShader(this.shaderType),compileShader(this)}}function createUniformSetter(e){const t=e.type,r=e.location,n=e.glx.gl;switch(t){case n.FLOAT:return e=>n.uniform1f(r,e);case n.FLOAT_VEC2:return e=>n.uniform2f(r,e[0],e[1]);case n.FLOAT_VEC3:return e=>n.uniform3f(r,e[0],e[1],e[2]);case n.FLOAT_VEC4:return e=>n.uniform4f(r,e[0],e[1],e[2],e[3]);case n.FLOAT_MAT4:return e=>n.uniformMatrix4fv(r,n.FALSE,e.mat4);case n.SAMPLER_2D:return e=>n.uniform1i(r,e);default:throw new Error(`WebGlUniform: unknown uniform type:${t}`)}}class WebGlUniform{constructor(e,t){this.program=e,this.glx=e.glx;const r=e.glx.gl,n=e.glProgram,i=r.getActiveUniform(n,t),o=i.name,a=i.size,s=i.type;this.name=o,this.size=a,this.type=s,this.location=r.getUniformLocation(n,o),this.setValue=createUniformSetter(this)}}const GL_ITEM_TYPES$1={float32:"FLOAT",int16:"SHORT",int32:"INT",int8:"BYTE",uint16:"UNSIGNED_SHORT",uint32:"UNSIGNED_INT",uint8:"UNSIGNED_BYTE"},glType=(e,t)=>e[GL_ITEM_TYPES$1[t]];class WebGlAttribute{constructor(e,t){this.program=e,this.glx=e.glx;const r=e.glx.gl,n=e.glProgram,i=r.getActiveAttrib(n,t),o=i.name,a=i.size,s=i.type;this.name=o,this.size=a,this.type=s,this.location=r.getAttribLocation(n,o)}vertexAttribPointer(e){const t=this.glx.gl,r=e.attr[this.name],n=glType(t,r.type);t.vertexAttribPointer(this.location,r.size,n,!1,e.bytesPerVertex,r.byteOffset),e.isInstanced&&this.glx.vertexAttribDivisor(this.location,1)}}const log$1=loglevel.getLogger("picimo.renderer.WebGlProgram");function createAttributes$1(e){const t=e.glx.gl,r=t.getProgramParameter(e.glProgram,t.ACTIVE_ATTRIBUTES);e.attributes={},e.attributeNames=[],e.attributeLocations=[];for(let t=0;t<r;++t){const r=new WebGlAttribute(e,t);e.attributes[r.name]=r,e.attributeNames.push(r.name),e.attributeLocations.push(r.location)}}function createUniforms(e){const t=e.glx.gl,r=t.getProgramParameter(e.glProgram,t.ACTIVE_UNIFORMS);e.uniforms={},e.uniformNames=[];for(let t=0;t<r;++t){const r=new WebGlUniform(e,t);e.uniforms[r.name]=r,e.uniformNames.push(r.name)}}function linkProgram(e,t,r){const n=e.glx.gl,i=e.glProgram;if(n.attachShader(i,t),n.attachShader(i,r),n.linkProgram(i),!n.getProgramParameter(i,n.LINK_STATUS))throw new Error("WebGlProgram: link panic!")}class WebGlProgram{constructor(e,t,r){this.glx=e,this.vertexShader=t,this.fragmentShader=r;const n=e.gl;this.glProgram=n.createProgram(),linkProgram(this,this.vertexShader.glShader,this.fragmentShader.glShader),createUniforms(this),createAttributes$1(this)}use(){const e=this.glx;return!!e.useProgram(this.glProgram)&&(e.enableVertexAttribArrays(this.attributeLocations),!0)}loadUniforms(e,t){let r=!0;return this.uniformNames.forEach(n=>{let i=e.curUniform(n);if(null==i){if(!(i=e.curTex2d(n)))return log$1.error("WebGlProgram: could not load uniform:",n),void(r=!1);{const e=i.texture;e&&(i.data=t.syncTexture(e).bind())}}this.uniforms[n].setValue(i.data)}),r}loadAttributes(e,t){let r=!0;return this.attributeNames.forEach(n=>{const i=e.curAttrib(n);if(i){const e=i.data;t.syncBuffer(e).bindBuffer(),this.attributes[n].vertexAttribPointer(e.descriptor)}else log$1.error("WebGlProgram: could not load attribute:",n),r=!1}),r}}var initTexGl=e=>{const t=e.glx.gl;e.bind(),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha);const r=e.repeatable?t.REPEAT:t.CLAMP_TO_EDGE;t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,r);const n=e.nearest?t.NEAREST:t.LINEAR;t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,n),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e.imgEl.width,e.imgEl.height,0,t.RGBA,t.UNSIGNED_BYTE,null)};class WebGlTexture{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5];this.glx=e,this.imgEl=t,this.flipY=r,this.repeatable=n,this.premultiplyAlpha=i,this.nearest=o,this.isInitialized=!1,this.glTexObj=e.gl.createTexture(),this.texUnit=-1}bind(){return this.glx.textureUnitManager.bindWebGlTexture(this)}uploadImageData(){if(null==this.imgEl)return;this.isInitialized||(initTexGl(this),this.isInitialized=!0),this.bind();const e=this.glx.gl;e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.imgEl)}}const WEB_GL_BUFFER_USAGE={static:WebGlBuffer.STATIC_DRAW,dynamic:WebGlBuffer.DYNAMIC_DRAW},loadResource=(e,t,r)=>{let n=e.get(t.id);return n||(n=r(t),e.set(t.id,n)),n},log$2=loglevel.getLogger("picimo.renderer.WebGlResourceLibrary");class WebGlResourceLibrary{constructor(e){this.glx=e,this.vertexShader=new Map,this.fragmentShader=new Map,this.shaderProgram=new Map,this.buffer=new Map,this.texture=new Map}loadBuffer(e){return loadResource(this.buffer,e,()=>{if("VOArray"!==e.type&&"ElementIndexArray"!==e.type)return void log$2.warn(`WebGlResourceLibrary.loadBuffer() ref.type="${e.type}" mismatch! (should be "VOArray" or "ElementIndexArray")`);const t=readOption(e.hints,"target",WebGlBuffer.ARRAY_BUFFER),r=readOption(e.hints,"usage","dynamic"),n=readOption(e.hints,"typedArray"),i=new WebGlBuffer(this.glx,t,WEB_GL_BUFFER_USAGE[r],n);return new DataRef("WebGlBuffer",i,{id:e.id,serial:0})})}findBuffer(e){return this.buffer.get(e.id)}freeBuffer(e){const t=this.findBuffer(e);t&&(this.buffer.delete(t.id),t.data.deleteBuffer())}loadVertexShader(e){return loadResource(this.vertexShader,e,()=>new WebGlShader(this.glx,e))}loadFragementShader(e){return loadResource(this.fragmentShader,e,()=>new WebGlShader(this.glx,e))}loadProgram(e){return loadResource(this.shaderProgram,e,()=>{const t=this.loadVertexShader(e.vertexShader),r=this.loadFragementShader(e.fragmentShader);return new WebGlProgram(this.glx,t,r)})}loadTexture(e){let t=this.texture.get(e.id);if(!t){const r=new WebGlTexture(this.glx,e.data.imgEl,e.hints.flipY,e.hints.repeatable,e.hints.premultiplyAlpha,e.hints.nearest);t=new DataRef("WebGlTexture",r,{id:e.id,serial:0}),this.texture.set(e.id,t)}return t}}const CTX_BLEND_MODE="blend",createCanvas=e=>{if("CANVAS"===e.tagName)return e;const t=document.createElement("canvas");return e.appendChild(t),t},autotouchResource=(e,t)=>{t.has(e.id)||(t.add(e.id),e.touch())},applyBlendMode=e=>{const t=e.universalContext.get(CTX_BLEND_MODE);t&&e.glx.blend(t)};class WebGlRenderer{constructor(e,t){this.domElement=e,this.canvas=createCanvas(e),this.glx=createWebGlContext(this.canvas,t),this.resources=new WebGlResourceLibrary(this.glx),this.shaderContext=new ShaderContext,this.universalContext=new StackedContext,this.now=0,this.lastFrameTime=0,this.frameNo=0,this.timeFrameOffset=0,this._pixelRatio=readOption(t,"pixelRatio"),this._touchedWithinFrame=new Set,this.shaderGlobals=new ShaderUniformGroup({time:0,resolution:[0,0],projection:new Projection({pixelRatio:1})}),this.resize()}get pixelRatio(){return this._pixelRatio||window.devicePixelRatio||1}pushBlendMode(e){const t=e instanceof BlendMode?e:BlendMode.make(e);return this.universalContext.push(CTX_BLEND_MODE,t)}popBlendMode(e){return this.universalContext.pop(CTX_BLEND_MODE,e)}resize(){const e=this.canvas,t=this.domElement,r=window.getComputedStyle(e,null),n=(("inline"===r.display||""===r.display)&&t===e?t.parentNode:t)||{clientWidth:e.width,clientHeight:e.height},i=n.clientWidth,o=n.clientHeight;e.style.width=`${i}px`,e.style.height=`${o}px`;const a=this.pixelRatio,s=Math.round(i*a),c=Math.round(o*a);s===e.width&&c===e.height||(e.width=s,e.height=c),s===this.width&&c===this.height||(this.width=s,this.height=c,this.shaderGlobals.resolution=[s,c],this.shaderGlobals.projectionUniform.update(s,c))}readPixels(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.gl,r=t.drawingBufferWidth,n=t.drawingBufferHeight,i=new Uint8Array(r*n*4);return t.readPixels(0,0,r,n,t.RGBA,t.UNSIGNED_BYTE,i),e&&Array.from({length:n},(e,t)=>i.slice(t*r*4,(t+1)*r*4)).forEach((e,t)=>i.set(e,(n-t-1)*r*4)),new ImageData(Uint8ClampedArray.from(i),r,n)}initFrame(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window.performance.now();++this.frameNo,this.now=e/1e3,1!==this.frameNo&&(this.timeFrameOffset=this.now-this.lastFrameTime),this.lastFrameTime=this.now,this.shaderGlobals.time=this.now,this._touchedWithinFrame.clear(),this.universalContext.clear(),this.pushBlendMode("orderDependent"),this.shaderContext.clear(),this.shaderGlobals.pushVar(this.shaderContext),this.glx.gl.viewport(0,0,this.width,this.height)}syncBuffer(e){let t=e.ref;t.hasHint("autotouch",!0)&&autotouchResource(t,this._touchedWithinFrame);const r=this.resources.loadBuffer(t);return r.sync(t,e=>{t.hasHint("doubleBuffer",!0)?e.doubleBufferData():e.bufferData()}),r.data}syncTexture(e){const t=e.ref,r=this.resources.loadTexture(t);return r.sync(t,e=>e.uploadImageData()),r.data}useShaderProgram(e){const t=this.resources.loadProgram(e),r=this.shaderContext,n=t.use(),i=t.loadUniforms(r,this),o=t.loadAttributes(r,this);return n&&i&&o}drawArrays(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;applyBlendMode(this);const n=this.glx.gl;n.drawArrays(n[e],r,t)}drawIndexed(e,t,r){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;applyBlendMode(this),this.syncBuffer(t).bindBuffer();const i=this.glx.gl;i.drawElements(i[e],r||t.length,i.UNSIGNED_SHORT,n*t.array.BYTES_PER_ELEMENT)}drawIndexedInstanced(e,t,r,n,i){applyBlendMode(this),this.syncBuffer(t).bindBuffer();const o=this.glx,a=o.gl;o.drawElementsInstanced(a[e],r||t.length,a.UNSIGNED_SHORT,n*t.array.BYTES_PER_ELEMENT,i)}drawPrimitive(e,t,r){let n=e.primitiveType,i=e.elementIndexArray;const o=i.itemCount;this.drawIndexed(n,i,t*o,r*o)}drawPrimitiveIndexed(e,t,r,n){let i=e.primitiveType,o=e.elementIndexArray;const a=o.itemCount;this.drawIndexedInstanced(i,o,t*a,r*a,n)}drawSpriteGroup(e){const t=()=>{const t=e.base;t&&(this.syncBuffer(t.voPool.voArray),this.shaderContext.pushVar(t.voPoolShaderAttribs)),this.syncBuffer(e.voPool.voArray),this.shaderContext.pushVar(e.voPoolShaderAttribs),this.useShaderProgram(e.shaderProgram),t?this.drawPrimitiveIndexed(t.primitive,t.usedCount,0,e.usedCount):this.drawPrimitive(e.primitive,e.usedCount,0)};e instanceof TexturedSpriteGroup?e.whenTexturesLoaded(e=>{this.shaderContext.pushVar(e),t()}):t()}}var index$2=Object.freeze({BlendMode:BlendMode,WebGlRenderer:WebGlRenderer,WebGlTexture:WebGlTexture,WebGlBuffer:WebGlBuffer,WebGlResourceLibrary:WebGlResourceLibrary}),objectProto=Object.prototype,hasOwnProperty$1=objectProto.hasOwnProperty;function baseHas(e,t){return null!=e&&hasOwnProperty$1.call(e,t)}var _baseHas=baseHas,isArray=Array.isArray,isArray_1=isArray,freeGlobal="object"==typeof commonjsGlobal&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,_freeGlobal=freeGlobal,freeSelf="object"==typeof self&&self&&self.Object===Object&&self,root=_freeGlobal||freeSelf||Function("return this")(),_root=root,Symbol$1=_root.Symbol,_Symbol=Symbol$1,objectProto$1=Object.prototype,hasOwnProperty$2=objectProto$1.hasOwnProperty,nativeObjectToString=objectProto$1.toString,symToStringTag=_Symbol?_Symbol.toStringTag:void 0;function getRawTag(e){var t=hasOwnProperty$2.call(e,symToStringTag),r=e[symToStringTag];try{e[symToStringTag]=void 0}catch(e){}var n=nativeObjectToString.call(e);return t?e[symToStringTag]=r:delete e[symToStringTag],n}var _getRawTag=getRawTag,objectProto$2=Object.prototype,nativeObjectToString$1=objectProto$2.toString;function objectToString(e){return nativeObjectToString$1.call(e)}var _objectToString=objectToString,nullTag="[object Null]",undefinedTag="[object Undefined]",symToStringTag$1=_Symbol?_Symbol.toStringTag:void 0;function baseGetTag(e){return null==e?void 0===e?undefinedTag:nullTag:symToStringTag$1&&symToStringTag$1 in Object(e)?_getRawTag(e):_objectToString(e)}var _baseGetTag=baseGetTag;function isObjectLike(e){return null!=e&&"object"==typeof e}var isObjectLike_1=isObjectLike,symbolTag="[object Symbol]";function isSymbol$1(e){return"symbol"==typeof e||isObjectLike_1(e)&&_baseGetTag(e)==symbolTag}var isSymbol_1=isSymbol$1,reIsDeepProp=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,reIsPlainProp=/^\w*$/;function isKey(e,t){if(isArray_1(e))return!1;var r=typeof e;return!("number"!=r&&"symbol"!=r&&"boolean"!=r&&null!=e&&!isSymbol_1(e))||(reIsPlainProp.test(e)||!reIsDeepProp.test(e)||null!=t&&e in Object(t))}var _isKey=isKey;function isObject(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var isObject_1=isObject,asyncTag="[object AsyncFunction]",funcTag="[object Function]",genTag="[object GeneratorFunction]",proxyTag="[object Proxy]";function isFunction(e){if(!isObject_1(e))return!1;var t=_baseGetTag(e);return t==funcTag||t==genTag||t==asyncTag||t==proxyTag}var isFunction_1=isFunction,coreJsData=_root["__core-js_shared__"],_coreJsData=coreJsData,maskSrcKey=function(){var e=/[^.]+$/.exec(_coreJsData&&_coreJsData.keys&&_coreJsData.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();function isMasked(e){return!!maskSrcKey&&maskSrcKey in e}var _isMasked=isMasked,funcProto=Function.prototype,funcToString=funcProto.toString;function toSource(e){if(null!=e){try{return funcToString.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var _toSource=toSource,reRegExpChar=/[\\^$.*+?()[\]{}|]/g,reIsHostCtor=/^\[object .+?Constructor\]$/,funcProto$1=Function.prototype,objectProto$3=Object.prototype,funcToString$1=funcProto$1.toString,hasOwnProperty$3=objectProto$3.hasOwnProperty,reIsNative=RegExp("^"+funcToString$1.call(hasOwnProperty$3).replace(reRegExpChar,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function baseIsNative(e){return!(!isObject_1(e)||_isMasked(e))&&(isFunction_1(e)?reIsNative:reIsHostCtor).test(_toSource(e))}var _baseIsNative=baseIsNative;function getValue(e,t){return null==e?void 0:e[t]}var _getValue=getValue;function getNative(e,t){var r=_getValue(e,t);return _baseIsNative(r)?r:void 0}var _getNative=getNative,nativeCreate=_getNative(Object,"create"),_nativeCreate=nativeCreate;function hashClear(){this.__data__=_nativeCreate?_nativeCreate(null):{},this.size=0}var _hashClear=hashClear;function hashDelete(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}var _hashDelete=hashDelete,HASH_UNDEFINED="__lodash_hash_undefined__",objectProto$4=Object.prototype,hasOwnProperty$4=objectProto$4.hasOwnProperty;function hashGet(e){var t=this.__data__;if(_nativeCreate){var r=t[e];return r===HASH_UNDEFINED?void 0:r}return hasOwnProperty$4.call(t,e)?t[e]:void 0}var _hashGet=hashGet,objectProto$5=Object.prototype,hasOwnProperty$5=objectProto$5.hasOwnProperty;function hashHas(e){var t=this.__data__;return _nativeCreate?void 0!==t[e]:hasOwnProperty$5.call(t,e)}var _hashHas=hashHas,HASH_UNDEFINED$1="__lodash_hash_undefined__";function hashSet(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=_nativeCreate&&void 0===t?HASH_UNDEFINED$1:t,this}var _hashSet=hashSet;function Hash(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}Hash.prototype.clear=_hashClear,Hash.prototype.delete=_hashDelete,Hash.prototype.get=_hashGet,Hash.prototype.has=_hashHas,Hash.prototype.set=_hashSet;var _Hash=Hash;function listCacheClear(){this.__data__=[],this.size=0}var _listCacheClear=listCacheClear;function eq(e,t){return e===t||e!=e&&t!=t}var eq_1=eq;function assocIndexOf(e,t){for(var r=e.length;r--;)if(eq_1(e[r][0],t))return r;return-1}var _assocIndexOf=assocIndexOf,arrayProto=Array.prototype,splice=arrayProto.splice;function listCacheDelete(e){var t=this.__data__,r=_assocIndexOf(t,e);return!(r<0)&&(r==t.length-1?t.pop():splice.call(t,r,1),--this.size,!0)}var _listCacheDelete=listCacheDelete;function listCacheGet(e){var t=this.__data__,r=_assocIndexOf(t,e);return r<0?void 0:t[r][1]}var _listCacheGet=listCacheGet;function listCacheHas(e){return _assocIndexOf(this.__data__,e)>-1}var _listCacheHas=listCacheHas;function listCacheSet(e,t){var r=this.__data__,n=_assocIndexOf(r,e);return n<0?(++this.size,r.push([e,t])):r[n][1]=t,this}var _listCacheSet=listCacheSet;function ListCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}ListCache.prototype.clear=_listCacheClear,ListCache.prototype.delete=_listCacheDelete,ListCache.prototype.get=_listCacheGet,ListCache.prototype.has=_listCacheHas,ListCache.prototype.set=_listCacheSet;var _ListCache=ListCache,Map$1=_getNative(_root,"Map"),_Map=Map$1;function mapCacheClear(){this.size=0,this.__data__={hash:new _Hash,map:new(_Map||_ListCache),string:new _Hash}}var _mapCacheClear=mapCacheClear;function isKeyable(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}var _isKeyable=isKeyable;function getMapData(e,t){var r=e.__data__;return _isKeyable(t)?r["string"==typeof t?"string":"hash"]:r.map}var _getMapData=getMapData;function mapCacheDelete(e){var t=_getMapData(this,e).delete(e);return this.size-=t?1:0,t}var _mapCacheDelete=mapCacheDelete;function mapCacheGet(e){return _getMapData(this,e).get(e)}var _mapCacheGet=mapCacheGet;function mapCacheHas(e){return _getMapData(this,e).has(e)}var _mapCacheHas=mapCacheHas;function mapCacheSet(e,t){var r=_getMapData(this,e),n=r.size;return r.set(e,t),this.size+=r.size==n?0:1,this}var _mapCacheSet=mapCacheSet;function MapCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}MapCache.prototype.clear=_mapCacheClear,MapCache.prototype.delete=_mapCacheDelete,MapCache.prototype.get=_mapCacheGet,MapCache.prototype.has=_mapCacheHas,MapCache.prototype.set=_mapCacheSet;var _MapCache=MapCache,FUNC_ERROR_TEXT="Expected a function";function memoize(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError(FUNC_ERROR_TEXT);var r=function(){var n=arguments,i=t?t.apply(this,n):n[0],o=r.cache;if(o.has(i))return o.get(i);var a=e.apply(this,n);return r.cache=o.set(i,a)||o,a};return r.cache=new(memoize.Cache||_MapCache),r}memoize.Cache=_MapCache;var memoize_1=memoize,MAX_MEMOIZE_SIZE=500;function memoizeCapped(e){var t=memoize_1(e,function(e){return r.size===MAX_MEMOIZE_SIZE&&r.clear(),e}),r=t.cache;return t}var _memoizeCapped=memoizeCapped,rePropName=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,reEscapeChar=/\\(\\)?/g,stringToPath=_memoizeCapped(function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(rePropName,function(e,r,n,i){t.push(n?i.replace(reEscapeChar,"$1"):r||e)}),t}),_stringToPath=stringToPath;function arrayMap(e,t){for(var r=-1,n=null==e?0:e.length,i=Array(n);++r<n;)i[r]=t(e[r],r,e);return i}var _arrayMap=arrayMap,INFINITY=1/0,symbolProto=_Symbol?_Symbol.prototype:void 0,symbolToString=symbolProto?symbolProto.toString:void 0;function baseToString(e){if("string"==typeof e)return e;if(isArray_1(e))return _arrayMap(e,baseToString)+"";if(isSymbol_1(e))return symbolToString?symbolToString.call(e):"";var t=e+"";return"0"==t&&1/e==-INFINITY?"-0":t}var _baseToString=baseToString;function toString$3(e){return null==e?"":_baseToString(e)}var toString_1=toString$3;function castPath(e,t){return isArray_1(e)?e:_isKey(e,t)?[e]:_stringToPath(toString_1(e))}var _castPath=castPath,argsTag="[object Arguments]";function baseIsArguments(e){return isObjectLike_1(e)&&_baseGetTag(e)==argsTag}var _baseIsArguments=baseIsArguments,objectProto$6=Object.prototype,hasOwnProperty$6=objectProto$6.hasOwnProperty,propertyIsEnumerable=objectProto$6.propertyIsEnumerable,isArguments=_baseIsArguments(function(){return arguments}())?_baseIsArguments:function(e){return isObjectLike_1(e)&&hasOwnProperty$6.call(e,"callee")&&!propertyIsEnumerable.call(e,"callee")},isArguments_1=isArguments,MAX_SAFE_INTEGER=9007199254740991,reIsUint=/^(?:0|[1-9]\d*)$/;function isIndex(e,t){var r=typeof e;return!!(t=null==t?MAX_SAFE_INTEGER:t)&&("number"==r||"symbol"!=r&&reIsUint.test(e))&&e>-1&&e%1==0&&e<t}var _isIndex=isIndex,MAX_SAFE_INTEGER$1=9007199254740991;function isLength(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=MAX_SAFE_INTEGER$1}var isLength_1=isLength,INFINITY$1=1/0;function toKey(e){if("string"==typeof e||isSymbol_1(e))return e;var t=e+"";return"0"==t&&1/e==-INFINITY$1?"-0":t}var _toKey=toKey;function hasPath(e,t,r){for(var n=-1,i=(t=_castPath(t,e)).length,o=!1;++n<i;){var a=_toKey(t[n]);if(!(o=null!=e&&r(e,a)))break;e=e[a]}return o||++n!=i?o:!!(i=null==e?0:e.length)&&isLength_1(i)&&_isIndex(a,i)&&(isArray_1(e)||isArguments_1(e))}var _hasPath=hasPath;function has(e,t){return null!=e&&_hasPath(e,t,_baseHas)}var has_1=has,defineProperty$1=function(){try{var e=_getNative(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),_defineProperty$1=defineProperty$1;function baseAssignValue(e,t,r){"__proto__"==t&&_defineProperty$1?_defineProperty$1(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}var _baseAssignValue=baseAssignValue,objectProto$7=Object.prototype,hasOwnProperty$7=objectProto$7.hasOwnProperty;function assignValue(e,t,r){var n=e[t];hasOwnProperty$7.call(e,t)&&eq_1(n,r)&&(void 0!==r||t in e)||_baseAssignValue(e,t,r)}var _assignValue=assignValue;function baseSet(e,t,r,n){if(!isObject_1(e))return e;for(var i=-1,o=(t=_castPath(t,e)).length,a=o-1,s=e;null!=s&&++i<o;){var c=_toKey(t[i]),l=r;if(i!=a){var u=s[c];void 0===(l=n?n(u,c,s):void 0)&&(l=isObject_1(u)?u:_isIndex(t[i+1])?[]:{})}_assignValue(s,c,l),s=s[c]}return e}var _baseSet=baseSet;function set$a(e,t,r){return null==e?e:_baseSet(e,t,r)}var set_1=set$a;function peg$subclass(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}function peg$SyntaxError(e,t,r,n){this.message=e,this.expected=t,this.found=r,this.location=n,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,peg$SyntaxError)}function peg$parse(e,t){t=void 0!==t?t:{};var r,n={},i={start:Or},o=Or,a=Er("picimo-lang"),s=function(e){return en(e)},c=Er("top-level statement"),l=function(e){return e},u=Er("statement"),h=function(e,t,r,n){return{verb:r,subject:n}},f=function(e,t,r,n){return n.type="declaration",n.name=t,n.declarationType=e,r&&(n.verb=r.verb,n.subject=r.subject),n},d="vertexobject",p=vr("VertexObject",!0),g="primitive",m=vr("Primitive",!0),y="spritegroup",_=vr("SpriteGroup",!0),b=function(e){return e.toLowerCase()},v="instantiates",A=vr("instantiates",!0),E=function(e){return e.toLowerCase()},x=function(e,t,r){return r.name=e,t&&(r.args=t),r},S=function(e,t){return t},T=function(e,t,r){var n={type:"dataBlock",data:en(r)};return e&&(n.dataType=e),t.length&&t.forEach(tn.bind(null,n)),n},O="{",P=vr("{",!1),w="}",C=vr("}",!1),R=Er("constant statement"),$="=",I=vr("=",!1),j=function(e,t){!function(e,t){Qr.hasOption(e)||Qr.writeOption(e,t)}(e,t)},N=Er("property-call statement"),V="@",D=vr("@",!1),L=function(e,t){var r={type:"propertyCall",name:e};return t&&(r.args=t),r},M=Er("property call arguments list"),G="(",B=vr("(",!1),F=",",U=vr(",",!1),k=function(e,t){return t},H=")",Y=vr(")",!1),z=function(e,t){return[e].concat(t)},W=Er("property call argument"),X=function(e){return e},K=Er("named arguments list"),q=Er("named argument"),J=":",Z=vr(":",!1),Q=function(e,t){return{name:e,value:t}},ee=Er("data statement"),te=function(e,t,r,n){return n},re=function(e,t,r,n,i,o){return o},ne=function(e,t,r,n,i,o){var a={type:"data",name:e};return t&&(a.args=t),null!=i&&(a.value=i),r&&(a.valueType=r),n.length&&n.forEach(tn.bind(null,a)),o.length&&o.forEach(tn.bind(null,a)),a},ie=Er("data value type"),oe="float32",ae=vr("float32",!1),se="int32",ce=vr("int32",!1),le="int16",ue=vr("int16",!1),he="int8",fe=vr("int8",!1),de="uint32",pe=vr("uint32",!1),ge="uint16",me=vr("uint16",!1),ye="uint8",_e=vr("uint8",!1),be=function(e){return e},ve=function(e){return e},Ae="false",Ee=vr("false",!1),xe=function(){return!1},Se="no",Te=vr("no",!1),Oe="off",Pe=vr("off",!1),we="true",Ce=vr("true",!1),Re=function(){return!0},$e="on",Ie=vr("on",!1),je="yes",Ne=vr("yes",!1),Ve="null",De=vr("null",!1),Le=function(){return null},Me=function(e){return e},Ge=Er("value array"),Be=function(e,t){return t},Fe=function(e,t){return[e].concat(t)},Ue=function(e){return e||[]},ke="[",He=vr("[",!1),Ye="]",ze=vr("]",!1),We="+",Xe=vr("+",!1),Ke="-",qe=vr("-",!1),Je=function(e,t){return t.reduce(function(e,t){return"+"===t[1]?e+t[3]:"-"===t[1]?e-t[3]:void 0},e)},Ze="*",Qe=vr("*",!1),et="/",tt=vr("/",!1),rt=function(e,t){return t.reduce(function(e,t){return"*"===t[1]?e*t[3]:"/"===t[1]?e/t[3]:void 0},e)},nt=function(e){return e},it=function(e,t){var r=function(e){return Qr.hasOption(e)?Qr.readOption(e):e}(t);return e?-r:r},ot=Er("number"),at=function(){return parseFloat(br())},st=".",ct=vr(".",!1),lt=/^[1-9]/,ut=Ar([["1","9"]],!1,!1),ht=/^[eE]/,ft=Ar(["e","E"],!1,!1),dt="0",pt=vr("0",!1),gt=Er("string"),mt=function(e){return e.join("")},yt='"',_t=vr('"',!1),bt="\\",vt=vr("\\",!1),At="b",Et=vr("b",!1),xt=function(){return"\b"},St="f",Tt=vr("f",!1),Ot=function(){return"\f"},Pt="n",wt=vr("n",!1),Ct=function(){return"\n"},Rt="r",$t=vr("r",!1),It=function(){return"\r"},jt="t",Nt=vr("t",!1),Vt=function(){return"\t"},Dt="u",Lt=vr("u",!1),Mt=function(e){return String.fromCharCode(parseInt(e,16))},Gt=function(e){return e},Bt=/^[^\0-\x1F"\\]/,Ft=Ar([["\0",""],'"',"\\"],!0,!1),Ut=/^[a-z]/i,kt=Ar([["a","z"]],!1,!0),Ht=function(e){return br()},Yt=function(e,t){return e+(t&&function e(t){return en(t).reduce(function(t,r){return t+(Array.isArray(r)?e(r):r)},"")}(t)||"")},zt=/^[_a-z0-9\-]/i,Wt=Ar(["_",["a","z"],["0","9"],"-"],!1,!0),Xt=Er("whitespaces with optional line breaks"),Kt=/^[ \t\n\r]/,qt=Ar([" ","\t","\n","\r"],!1,!1),Jt=Er("whitespaces"),Zt=/^[ \t]/,Qt=Ar([" ","\t"],!1,!1),er=Er("new line"),tr="\n",rr=vr("\n",!1),nr="\r\n",ir=vr("\r\n",!1),or="\r",ar=vr("\r",!1),sr="\f",cr=vr("\f",!1),lr=/^[0-9]/,ur=Ar([["0","9"]],!1,!1),hr=/^[0-9a-f]/i,fr=Ar([["0","9"],["a","f"]],!1,!0),dr=0,pr=0,gr=[{line:1,column:1}],mr=0,yr=[],_r=0;if("startRule"in t){if(!(t.startRule in i))throw new Error("Can't start parsing from rule \""+t.startRule+'".');o=i[t.startRule]}function br(){return e.substring(pr,dr)}function vr(e,t){return{type:"literal",text:e,ignoreCase:t}}function Ar(e,t,r){return{type:"class",parts:e,inverted:t,ignoreCase:r}}function Er(e){return{type:"other",description:e}}function xr(t){var r,n=gr[t];if(n)return n;for(r=t-1;!gr[r];)r--;for(n={line:(n=gr[r]).line,column:n.column};r<t;)10===e.charCodeAt(r)?(n.line++,n.column=1):n.column++,r++;return gr[t]=n,n}function Sr(e,t){var r=xr(e),n=xr(t);return{start:{offset:e,line:r.line,column:r.column},end:{offset:t,line:n.line,column:n.column}}}function Tr(e){dr<mr||(dr>mr&&(mr=dr,yr=[]),yr.push(e))}function Or(){var e,t,r;if(_r++,e=dr,Yr()!==n){for(t=[],r=Pr();r!==n;)t.push(r),r=Pr();t!==n&&(r=Yr())!==n?(pr=e,e=s(t)):(dr=e,e=n)}else dr=e,e=n;return _r--,e===n&&(n,0===_r&&Tr(a)),e}function Pr(){var t,r;return _r++,t=dr,(r=function(){var t,r,i,o;_r++,t=dr,(r=kr())!==n&&zr()!==n?(61===e.charCodeAt(dr)?(i=$,dr++):(i=n,0===_r&&Tr(I)),i!==n&&zr()!==n&&(o=Vr())!==n?(pr=t,r=j(r,o),t=r):(dr=t,t=n)):(dr=t,t=n);_r--,t===n&&(r=n,0===_r&&Tr(R));return t}())===n&&(r=function(){var t,r,i,o,a,s,c;t=dr,(r=function(){var t,r;return t=dr,e.substr(dr,12).toLowerCase()===d?(r=e.substr(dr,12),dr+=12):(r=n,0===_r&&Tr(p)),r===n&&(e.substr(dr,9).toLowerCase()===g?(r=e.substr(dr,9),dr+=9):(r=n,0===_r&&Tr(m)),r===n&&(e.substr(dr,11).toLowerCase()===y?(r=e.substr(dr,11),dr+=11):(r=n,0===_r&&Tr(_)))),r!==n&&(pr=t,r=b(r)),t=r}())!==n&&zr()!==n&&(i=kr())!==n&&zr()!==n?(o=dr,(a=function(){var t,r;t=dr,e.substr(dr,12).toLowerCase()===v?(r=e.substr(dr,12),dr+=12):(r=n,0===_r&&Tr(A));r!==n&&(pr=t,r=E(r));return t=r}())!==n&&(s=zr())!==n&&(c=kr())!==n?(pr=o,a=h(r,i,a,c),o=a):(dr=o,o=n),o===n&&(o=null),o!==n&&(a=zr())!==n&&(s=Cr())!==n?(pr=t,r=f(r,i,o,s),t=r):(dr=t,t=n)):(dr=t,t=n);return t}()),r!==n&&Wr()!==n&&Yr()!==n?(pr=t,t=r=l(r)):(dr=t,t=n),_r--,t===n&&(r=n,0===_r&&Tr(c)),t}function wr(){var e,t;return _r++,e=dr,(t=function(){var e,t,r,i;e=dr,(t=kr())!==n&&zr()!==n?((r=Ir())===n&&(r=null),r!==n&&zr()!==n&&(i=Cr())!==n?(pr=e,t=x(t,r,i),e=t):(dr=e,e=n)):(dr=e,e=n);return e}())===n&&(t=function(){var e,t,r,i,o,a,s,c,l,u,h;if(_r++,e=dr,(t=kr())!==n)if(zr()!==n)if((r=Ir())===n&&(r=null),r!==n)if(zr()!==n)if((i=Nr())===n&&(i=null),i!==n){for(o=[],a=dr,(s=zr())!==n&&(c=Rr())!==n?(pr=a,s=te(t,r,i,c),a=s):(dr=a,a=n);a!==n;)o.push(a),a=dr,(s=zr())!==n&&(c=Rr())!==n?(pr=a,s=te(t,r,i,c),a=s):(dr=a,a=n);if(o!==n)if((a=zr())!==n)if((s=Vr())===n&&(s=null),s!==n){for(c=[],l=dr,(u=zr())!==n&&(h=Rr())!==n?(pr=l,u=re(t,r,i,o,s,h),l=u):(dr=l,l=n);l!==n;)c.push(l),l=dr,(u=zr())!==n&&(h=Rr())!==n?(pr=l,u=re(t,r,i,o,s,h),l=u):(dr=l,l=n);c!==n?(pr=e,t=ne(t,r,i,o,s,c),e=t):(dr=e,e=n)}else dr=e,e=n;else dr=e,e=n;else dr=e,e=n}else dr=e,e=n;else dr=e,e=n;else dr=e,e=n;else dr=e,e=n;else dr=e,e=n;_r--,e===n&&(t=n,0===_r&&Tr(ee));return e}())===n&&(t=Rr()),t!==n&&Wr()!==n&&Yr()!==n?(pr=e,e=t=l(t)):(dr=e,e=n),_r--,e===n&&(t=n,0===_r&&Tr(u)),e}function Cr(){var t,r,i,o,a,s;if(t=dr,(r=Nr())===n&&(r=null),r!==n){for(i=[],o=dr,(a=zr())!==n&&(s=Rr())!==n?(pr=o,o=a=S(r,s)):(dr=o,o=n);o!==n;)i.push(o),o=dr,(a=zr())!==n&&(s=Rr())!==n?(pr=o,o=a=S(r,s)):(dr=o,o=n);if(i!==n)if((o=function(){var t,r,i,o;t=dr,(r=zr())!==n?(123===e.charCodeAt(dr)?(i=O,dr++):(i=n,0===_r&&Tr(P)),i!==n&&(o=Yr())!==n?t=r=[r,i,o]:(dr=t,t=n)):(dr=t,t=n);return t}())!==n){for(a=[],s=wr();s!==n;)a.push(s),s=wr();a!==n&&(s=function(){var t,r,i,o;t=dr,(r=Yr())!==n?(125===e.charCodeAt(dr)?(i=w,dr++):(i=n,0===_r&&Tr(C)),i!==n&&(o=zr())!==n?t=r=[r,i,o]:(dr=t,t=n)):(dr=t,t=n);return t}())!==n?(pr=t,t=r=T(r,i,a)):(dr=t,t=n)}else dr=t,t=n;else dr=t,t=n}else dr=t,t=n;return t}function Rr(){var t,r,i,o;return _r++,t=dr,64===e.charCodeAt(dr)?(r=V,dr++):(r=n,0===_r&&Tr(D)),r!==n&&(i=kr())!==n&&zr()!==n?((o=function(){var t,r,i,o,a,s,c;_r++,t=dr,40===e.charCodeAt(dr)?(r=G,dr++):(r=n,0===_r&&Tr(B));if(r!==n)if((i=$r())!==n){for(o=[],a=dr,44===e.charCodeAt(dr)?(s=F,dr++):(s=n,0===_r&&Tr(U)),s!==n&&zr()!==n&&(c=$r())!==n?(pr=a,s=k(i,c),a=s):(dr=a,a=n);a!==n;)o.push(a),a=dr,44===e.charCodeAt(dr)?(s=F,dr++):(s=n,0===_r&&Tr(U)),s!==n&&zr()!==n&&(c=$r())!==n?(pr=a,s=k(i,c),a=s):(dr=a,a=n);o!==n?(41===e.charCodeAt(dr)?(a=H,dr++):(a=n,0===_r&&Tr(Y)),a!==n?(pr=t,r=z(i,o),t=r):(dr=t,t=n)):(dr=t,t=n)}else dr=t,t=n;else dr=t,t=n;_r--,t===n&&(r=n,0===_r&&Tr(M));return t}())===n&&(o=null),o!==n?(pr=t,t=r=L(i,o)):(dr=t,t=n)):(dr=t,t=n),_r--,t===n&&(r=n,0===_r&&Tr(N)),t}function $r(){var e,t;return _r++,e=dr,zr()!==n?((t=Vr())===n&&(t=kr()),t!==n&&zr()!==n?(pr=e,e=X(t)):(dr=e,e=n)):(dr=e,e=n),_r--,e===n&&(n,0===_r&&Tr(W)),e}function Ir(){var t,r,i,o,a,s,c;if(_r++,t=dr,40===e.charCodeAt(dr)?(r=G,dr++):(r=n,0===_r&&Tr(B)),r!==n)if((i=jr())!==n){for(o=[],a=dr,44===e.charCodeAt(dr)?(s=F,dr++):(s=n,0===_r&&Tr(U)),s!==n&&zr()!==n&&(c=jr())!==n?(pr=a,a=s=k(i,c)):(dr=a,a=n);a!==n;)o.push(a),a=dr,44===e.charCodeAt(dr)?(s=F,dr++):(s=n,0===_r&&Tr(U)),s!==n&&zr()!==n&&(c=jr())!==n?(pr=a,a=s=k(i,c)):(dr=a,a=n);o!==n?(41===e.charCodeAt(dr)?(a=H,dr++):(a=n,0===_r&&Tr(Y)),a!==n?(pr=t,t=r=z(i,o)):(dr=t,t=n)):(dr=t,t=n)}else dr=t,t=n;else dr=t,t=n;return _r--,t===n&&(r=n,0===_r&&Tr(K)),t}function jr(){var t,r,i,o;return _r++,t=dr,zr()!==n&&(r=kr())!==n&&zr()!==n?(58===e.charCodeAt(dr)?(i=J,dr++):(i=n,0===_r&&Tr(Z)),i!==n&&zr()!==n&&(o=Vr())!==n&&zr()!==n?(pr=t,t=Q(r,o)):(dr=t,t=n)):(dr=t,t=n),_r--,t===n&&(n,0===_r&&Tr(q)),t}function Nr(){var t,r,i;return _r++,t=dr,58===e.charCodeAt(dr)?(r=J,dr++):(r=n,0===_r&&Tr(Z)),r!==n&&zr()!==n?(e.substr(dr,7)===oe?(i=oe,dr+=7):(i=n,0===_r&&Tr(ae)),i===n&&(e.substr(dr,5)===se?(i=se,dr+=5):(i=n,0===_r&&Tr(ce)),i===n&&(e.substr(dr,5)===le?(i=le,dr+=5):(i=n,0===_r&&Tr(ue)),i===n&&(e.substr(dr,4)===he?(i=he,dr+=4):(i=n,0===_r&&Tr(fe)),i===n&&(e.substr(dr,6)===de?(i=de,dr+=6):(i=n,0===_r&&Tr(pe)),i===n&&(e.substr(dr,6)===ge?(i=ge,dr+=6):(i=n,0===_r&&Tr(me)),i===n&&(e.substr(dr,5)===ye?(i=ye,dr+=5):(i=n,0===_r&&Tr(_e)))))))),i!==n?(pr=t,t=r=be(i)):(dr=t,t=n)):(dr=t,t=n),_r--,t===n&&(r=n,0===_r&&Tr(ie)),t}function Vr(){var t,r;return t=dr,zr()!==n?((r=function(){var t,r;t=dr,e.substr(dr,4)===Ve?(r=Ve,dr+=4):(r=n,0===_r&&Tr(De));r!==n&&(pr=t,r=Le());return t=r}())===n&&(r=function(){var t,r;t=dr,e.substr(dr,5)===Ae?(r=Ae,dr+=5):(r=n,0===_r&&Tr(Ee));r!==n&&(pr=t,r=xe());(t=r)===n&&(t=dr,e.substr(dr,2)===Se?(r=Se,dr+=2):(r=n,0===_r&&Tr(Te)),r!==n&&(pr=t,r=xe()),(t=r)===n&&(t=dr,e.substr(dr,3)===Oe?(r=Oe,dr+=3):(r=n,0===_r&&Tr(Pe)),r!==n&&(pr=t,r=xe()),t=r));return t}())===n&&(r=function(){var t,r;t=dr,e.substr(dr,4)===we?(r=we,dr+=4):(r=n,0===_r&&Tr(Ce));r!==n&&(pr=t,r=Re());(t=r)===n&&(t=dr,e.substr(dr,2)===$e?(r=$e,dr+=2):(r=n,0===_r&&Tr(Ie)),r!==n&&(pr=t,r=Re()),(t=r)===n&&(t=dr,e.substr(dr,3)===je?(r=je,dr+=3):(r=n,0===_r&&Tr(Ne)),r!==n&&(pr=t,r=Re()),t=r));return t}())===n&&(r=function(){var t,r,i,o,a,s,c,l;if(_r++,t=dr,(r=function(){var t,r,i,o;return t=dr,(r=zr())!==n?(91===e.charCodeAt(dr)?(i=ke,dr++):(i=n,0===_r&&Tr(He)),i!==n&&(o=Yr())!==n?t=r=[r,i,o]:(dr=t,t=n)):(dr=t,t=n),t}())!==n){if(i=dr,(o=Vr())!==n){for(a=[],s=dr,(c=Lr())!==n&&(l=Vr())!==n?(pr=s,c=Be(o,l),s=c):(dr=s,s=n);s!==n;)a.push(s),s=dr,(c=Lr())!==n&&(l=Vr())!==n?(pr=s,c=Be(o,l),s=c):(dr=s,s=n);a!==n?(pr=i,o=Fe(o,a),i=o):(dr=i,i=n)}else dr=i,i=n;i===n&&(i=null),i!==n&&(o=function(){var t,r,i,o,a,s;t=dr,(r=Yr())!==n?(44===e.charCodeAt(dr)?(i=F,dr++):(i=n,0===_r&&Tr(U)),i===n&&(i=null),i!==n&&(o=Yr())!==n?(93===e.charCodeAt(dr)?(a=Ye,dr++):(a=n,0===_r&&Tr(ze)),a!==n&&(s=zr())!==n?t=r=[r,i,o,a,s]:(dr=t,t=n)):(dr=t,t=n)):(dr=t,t=n);return t}())!==n?(pr=t,r=Ue(i),t=r):(dr=t,t=n)}else dr=t,t=n;_r--,t===n&&(r=n,0===_r&&Tr(Ge));return t}())===n&&(r=Dr())===n&&(r=function(){var e,t,r,i;if(_r++,e=dr,(t=Ur())!==n){for(r=[],i=Fr();i!==n;)r.push(i),i=Fr();r!==n&&(i=Ur())!==n?(pr=e,t=mt(r),e=t):(dr=e,e=n)}else dr=e,e=n;_r--,e===n&&(t=n,0===_r&&Tr(gt));return e}()),r!==n&&zr()!==n?(pr=t,t=ve(r)):(dr=t,t=n)):(dr=t,t=n),t}function Dr(){var t,r;return t=dr,(r=function(){var t,r,i,o,a,s,c,l;if(t=dr,(r=Mr())!==n){for(i=[],o=dr,(a=zr())!==n?(43===e.charCodeAt(dr)?(s=We,dr++):(s=n,0===_r&&Tr(Xe)),s===n&&(45===e.charCodeAt(dr)?(s=Ke,dr++):(s=n,0===_r&&Tr(qe))),s!==n&&(c=zr())!==n&&(l=Mr())!==n?o=a=[a,s,c,l]:(dr=o,o=n)):(dr=o,o=n);o!==n;)i.push(o),o=dr,(a=zr())!==n?(43===e.charCodeAt(dr)?(s=We,dr++):(s=n,0===_r&&Tr(Xe)),s===n&&(45===e.charCodeAt(dr)?(s=Ke,dr++):(s=n,0===_r&&Tr(qe))),s!==n&&(c=zr())!==n&&(l=Mr())!==n?o=a=[a,s,c,l]:(dr=o,o=n)):(dr=o,o=n);i!==n?(pr=t,r=Je(r,i),t=r):(dr=t,t=n)}else dr=t,t=n;return t}())!==n&&(pr=t,r=Me(r)),t=r}function Lr(){var t,r,i,o;return t=dr,(r=Yr())!==n?(44===e.charCodeAt(dr)?(i=F,dr++):(i=n,0===_r&&Tr(U)),i!==n&&(o=Yr())!==n?t=r=[r,i,o]:(dr=t,t=n)):(dr=t,t=n),t}function Mr(){var t,r,i,o,a,s,c,l;if(t=dr,(r=Gr())!==n){for(i=[],o=dr,(a=zr())!==n?(42===e.charCodeAt(dr)?(s=Ze,dr++):(s=n,0===_r&&Tr(Qe)),s===n&&(47===e.charCodeAt(dr)?(s=et,dr++):(s=n,0===_r&&Tr(tt))),s!==n&&(c=zr())!==n&&(l=Gr())!==n?o=a=[a,s,c,l]:(dr=o,o=n)):(dr=o,o=n);o!==n;)i.push(o),o=dr,(a=zr())!==n?(42===e.charCodeAt(dr)?(s=Ze,dr++):(s=n,0===_r&&Tr(Qe)),s===n&&(47===e.charCodeAt(dr)?(s=et,dr++):(s=n,0===_r&&Tr(tt))),s!==n&&(c=zr())!==n&&(l=Gr())!==n?o=a=[a,s,c,l]:(dr=o,o=n)):(dr=o,o=n);i!==n?(pr=t,t=r=rt(r,i)):(dr=t,t=n)}else dr=t,t=n;return t}function Gr(){var t,r,i,o,a;return t=dr,40===e.charCodeAt(dr)?(r=G,dr++):(r=n,0===_r&&Tr(B)),r!==n&&(i=zr())!==n&&(o=Dr())!==n&&zr()!==n?(41===e.charCodeAt(dr)?(a=H,dr++):(a=n,0===_r&&Tr(Y)),a!==n?(pr=t,t=r=nt(o)):(dr=t,t=n)):(dr=t,t=n),t===n&&(t=function(){var t,r,i,o;_r++,t=dr,(r=Br())===n&&(r=null);r!==n&&function(){var t,r,i,o;if((t=function(){var t;return 48===e.charCodeAt(dr)?(t=dt,dr++):(t=n,0===_r&&Tr(pt)),t}())===n)if(t=dr,(r=function(){var t;lt.test(e.charAt(dr))?(t=e.charAt(dr),dr++):(t=n,0===_r&&Tr(ut));return t}())!==n){for(i=[],o=Xr();o!==n;)i.push(o),o=Xr();i!==n?t=r=[r,i]:(dr=t,t=n)}else dr=t,t=n;return t}()!==n?((i=function(){var t,r,i,o;if(t=dr,(r=function(){var t;return 46===e.charCodeAt(dr)?(t=st,dr++):(t=n,0===_r&&Tr(ct)),t}())!==n){if(i=[],(o=Xr())!==n)for(;o!==n;)i.push(o),o=Xr();else i=n;i!==n?t=r=[r,i]:(dr=t,t=n)}else dr=t,t=n;return t}())===n&&(i=null),i!==n?((o=function(){var t,r,i,o,a;if(t=dr,(r=function(){var t;return ht.test(e.charAt(dr))?(t=e.charAt(dr),dr++):(t=n,0===_r&&Tr(ft)),t}())!==n)if((i=Br())===n&&(i=function(){var t;43===e.charCodeAt(dr)?(t=We,dr++):(t=n,0===_r&&Tr(Xe));return t}()),i===n&&(i=null),i!==n){if(o=[],(a=Xr())!==n)for(;a!==n;)o.push(a),a=Xr();else o=n;o!==n?t=r=[r,i,o]:(dr=t,t=n)}else dr=t,t=n;else dr=t,t=n;return t}())===n&&(o=null),o!==n?(pr=t,r=at(),t=r):(dr=t,t=n)):(dr=t,t=n)):(dr=t,t=n);_r--,t===n&&(r=n,0===_r&&Tr(ot));return t}())===n&&(t=dr,(r=Br())===n&&(r=null),r!==n&&(i=kr())!==n?(pr=t,t=r=it(r,i)):(dr=t,t=n)),t}function Br(){var t;return 45===e.charCodeAt(dr)?(t=Ke,dr++):(t=n,0===_r&&Tr(qe)),t}function Fr(){var t,r,i,o,a,s,c,l,u;return(t=function(){var t;Bt.test(e.charAt(dr))?(t=e.charAt(dr),dr++):(t=n,0===_r&&Tr(Ft));return t}())===n&&(t=dr,function(){var t;92===e.charCodeAt(dr)?(t=bt,dr++):(t=n,0===_r&&Tr(vt));return t}()!==n?(34===e.charCodeAt(dr)?(r=yt,dr++):(r=n,0===_r&&Tr(_t)),r===n&&(92===e.charCodeAt(dr)?(r=bt,dr++):(r=n,0===_r&&Tr(vt)),r===n&&(47===e.charCodeAt(dr)?(r=et,dr++):(r=n,0===_r&&Tr(tt)),r===n&&(r=dr,98===e.charCodeAt(dr)?(i=At,dr++):(i=n,0===_r&&Tr(Et)),i!==n&&(pr=r,i=xt()),(r=i)===n&&(r=dr,102===e.charCodeAt(dr)?(i=St,dr++):(i=n,0===_r&&Tr(Tt)),i!==n&&(pr=r,i=Ot()),(r=i)===n&&(r=dr,110===e.charCodeAt(dr)?(i=Pt,dr++):(i=n,0===_r&&Tr(wt)),i!==n&&(pr=r,i=Ct()),(r=i)===n&&(r=dr,114===e.charCodeAt(dr)?(i=Rt,dr++):(i=n,0===_r&&Tr($t)),i!==n&&(pr=r,i=It()),(r=i)===n&&(r=dr,116===e.charCodeAt(dr)?(i=jt,dr++):(i=n,0===_r&&Tr(Nt)),i!==n&&(pr=r,i=Vt()),(r=i)===n&&(r=dr,117===e.charCodeAt(dr)?(i=Dt,dr++):(i=n,0===_r&&Tr(Lt)),i!==n?(o=dr,a=dr,(s=Kr())!==n&&(c=Kr())!==n&&(l=Kr())!==n&&(u=Kr())!==n?a=s=[s,c,l,u]:(dr=a,a=n),(o=a!==n?e.substring(o,dr):a)!==n?(pr=r,r=i=Mt(o)):(dr=r,r=n)):(dr=r,r=n))))))))),r!==n?(pr=t,t=Gt(r)):(dr=t,t=n)):(dr=t,t=n)),t}function Ur(){var t;return 34===e.charCodeAt(dr)?(t=yt,dr++):(t=n,0===_r&&Tr(_t)),t}function kr(){var t,r,i,o,a,s,c,l,u,h;if(t=dr,Ut.test(e.charAt(dr))?(r=e.charAt(dr),dr++):(r=n,0===_r&&Tr(kt)),r!==n){if(i=[],o=dr,46===e.charCodeAt(dr)?(a=st,dr++):(a=n,0===_r&&Tr(ct)),a===n&&(a=null),a!==n)if((s=Hr())!==n){if(c=dr,46===e.charCodeAt(dr)?(l=st,dr++):(l=n,0===_r&&Tr(ct)),l!==n){if(u=[],(h=Hr())!==n)for(;h!==n;)u.push(h),h=Hr();else u=n;u!==n?(pr=c,c=l=Ht(r)):(dr=c,c=n)}else dr=c,c=n;c===n&&(c=null),c!==n?o=a=[a,s,c]:(dr=o,o=n)}else dr=o,o=n;else dr=o,o=n;for(;o!==n;)if(i.push(o),o=dr,46===e.charCodeAt(dr)?(a=st,dr++):(a=n,0===_r&&Tr(ct)),a===n&&(a=null),a!==n)if((s=Hr())!==n){if(c=dr,46===e.charCodeAt(dr)?(l=st,dr++):(l=n,0===_r&&Tr(ct)),l!==n){if(u=[],(h=Hr())!==n)for(;h!==n;)u.push(h),h=Hr();else u=n;u!==n?(pr=c,c=l=Ht(r)):(dr=c,c=n)}else dr=c,c=n;c===n&&(c=null),c!==n?o=a=[a,s,c]:(dr=o,o=n)}else dr=o,o=n;else dr=o,o=n;i!==n?(pr=t,t=r=Yt(r,i)):(dr=t,t=n)}else dr=t,t=n;return t}function Hr(){var t;return zt.test(e.charAt(dr))?(t=e.charAt(dr),dr++):(t=n,0===_r&&Tr(Wt)),t}function Yr(){var t,r;for(_r++,t=[],Kt.test(e.charAt(dr))?(r=e.charAt(dr),dr++):(r=n,0===_r&&Tr(qt));r!==n;)t.push(r),Kt.test(e.charAt(dr))?(r=e.charAt(dr),dr++):(r=n,0===_r&&Tr(qt));return _r--,t===n&&(r=n,0===_r&&Tr(Xt)),t}function zr(){var t,r;for(_r++,t=[],Zt.test(e.charAt(dr))?(r=e.charAt(dr),dr++):(r=n,0===_r&&Tr(Qt));r!==n;)t.push(r),Zt.test(e.charAt(dr))?(r=e.charAt(dr),dr++):(r=n,0===_r&&Tr(Qt));return _r--,t===n&&(r=n,0===_r&&Tr(Jt)),t}function Wr(){var t,r,i;return _r++,t=dr,(r=zr())!==n?(10===e.charCodeAt(dr)?(i=tr,dr++):(i=n,0===_r&&Tr(rr)),i!==n?t=r=[r,i]:(dr=t,t=n)):(dr=t,t=n),t===n&&(t=dr,(r=zr())!==n?(e.substr(dr,2)===nr?(i=nr,dr+=2):(i=n,0===_r&&Tr(ir)),i!==n?t=r=[r,i]:(dr=t,t=n)):(dr=t,t=n),t===n&&(t=dr,(r=zr())!==n?(13===e.charCodeAt(dr)?(i=or,dr++):(i=n,0===_r&&Tr(ar)),i!==n?t=r=[r,i]:(dr=t,t=n)):(dr=t,t=n),t===n&&(t=dr,(r=zr())!==n?(12===e.charCodeAt(dr)?(i=sr,dr++):(i=n,0===_r&&Tr(cr)),i!==n?t=r=[r,i]:(dr=t,t=n)):(dr=t,t=n)))),_r--,t===n&&(r=n,0===_r&&Tr(er)),t}function Xr(){var t;return lr.test(e.charAt(dr))?(t=e.charAt(dr),dr++):(t=n,0===_r&&Tr(ur)),t}function Kr(){var t;return hr.test(e.charAt(dr))?(t=e.charAt(dr),dr++):(t=n,0===_r&&Tr(fr)),t}var qr,Jr,Zr,Qr=t.ctx;function en(e){return e.filter(function(e){return Boolean(e)})}function tn(e,t){e.annotations||(e.annotations=[]),e.annotations.push(t)}if((r=o())!==n&&dr===e.length)return r;throw r!==n&&dr<e.length&&Tr({type:"end"}),qr=yr,Jr=mr<e.length?e.charAt(mr):null,Zr=mr<e.length?Sr(mr,mr+1):Sr(mr,mr),new peg$SyntaxError(peg$SyntaxError.buildMessage(qr,Jr),qr,Jr,Zr)}peg$subclass(peg$SyntaxError,Error),peg$SyntaxError.buildMessage=function(e,t){var r={literal:function(e){return'"'+i(e.text)+'"'},class:function(e){var t,r="";for(t=0;t<e.parts.length;t++)r+=e.parts[t]instanceof Array?o(e.parts[t][0])+"-"+o(e.parts[t][1]):o(e.parts[t]);return"["+(e.inverted?"^":"")+r+"]"},any:function(e){return"any character"},end:function(e){return"end of input"},other:function(e){return e.description}};function n(e){return e.charCodeAt(0).toString(16).toUpperCase()}function i(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+n(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+n(e)})}function o(e){return e.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(e){return"\\x0"+n(e)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(e){return"\\x"+n(e)})}return"Expected "+function(e){var t,n,i,o=new Array(e.length);for(t=0;t<e.length;t++)o[t]=(i=e[t],r[i.type](i));if(o.sort(),o.length>0){for(t=1,n=1;t<o.length;t++)o[t-1]!==o[t]&&(o[n]=o[t],n++);o.length=n}switch(o.length){case 1:return o[0];case 2:return o[0]+" or "+o[1];default:return o.slice(0,-1).join(", ")+", or "+o[o.length-1]}}(e)+" but "+function(e){return e?'"'+i(e)+'"':"end of input"}(t)+" found."};const parse=peg$parse;function compact(e){for(var t=-1,r=null==e?0:e.length,n=0,i=[];++t<r;){var o=e[t];o&&(i[n++]=o)}return i}var compact_1=compact;const DATA="data",DATA_BLOCK="dataBlock",DECLARATION="declaration",PROPERTY_CALL="propertyCall",findPropertyCall=(e,t,r)=>{if(e){const n=e.find(e=>{let r=e.type,n=e.name;return r===PROPERTY_CALL&&n===t});return void 0!==n&&r&&r(n),n}},hasPropertyCall=(e,t)=>Boolean(findPropertyCall(e,t)),firstPropertyCallArg=(e,t)=>get(findPropertyCall(e,t),"args[0]"),setByFirstPropertyCallArg=(e,t,r,n)=>findPropertyCall(r,n||t,r=>{e[t]=get(r,"args[0]")}),readFlag=(e,t)=>null==e?t:!e.args||1!==e.args.length||Boolean(e.args[0]),setFlagByPropertyCall=(e,t,r)=>{const n=findPropertyCall(t,r);void 0!==n&&(e[r]=readFlag(n))},findNamedArgument=(e,t,r)=>e&&e.find(e=>{let n=e.name,i=e.value;const o=n===t;return o&&r&&r(i),o}),setByNamedArgument=(e,t,r)=>findNamedArgument(e,r,e=>{t[r]=e}),findData=(e,t,r)=>e&&e.find(e=>{const n=e.name===t;return n&&r&&r(e),n}),attachDataValue=(e,t,r)=>findData(t,r,t=>{let n=t.value;return Object.assign(e,{[r]:n})}),attachDataValues=(e,t,r)=>r.forEach(attachDataValue.bind(null,e,t)),parseVoDefaultValues=e=>(t,r)=>{void 0!==r&&(Array.isArray(r)?r.forEach((r,n)=>{e[`${t}${n}`]=r}):e[t]=r)},readOption$1=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return t.reduce((t,r)=>{if("function"==typeof r){const n=r(e);return void 0!==n?n:t}return r&&e in r?r[e]:t},r)}},assignOptions=(e,t,r,n)=>(t.forEach(t=>{let i=r(t);n&&"string"==typeof i&&(i=n(i)),void 0!==i&&(e[t]=i)}),e),DEFAULT_ATTR_TYPE$1="float32",create$9=e=>{let t=e.declaration,r=e.ctx,n=e.options;const i="instantiates"===t.verb?r.create(t.subject):void 0,o=t.voDescriptor,a=n||o.proto;return new VODescriptor(_objectSpread({},o,{instanceOf:i,proto:"string"==typeof a?r.readOption(a):a}))},transform=e=>{const t={},r={},n=parseVoDefaultValues(t),i={voDescriptor:{vertexCount:firstPropertyCallArg(e.data,"vertexCount"),attributes:compact_1(e.data.filter(e=>{let t=e.type;return t===DATA||t===DATA_BLOCK}).map(e=>{const t=findPropertyCall(e.annotations,"alias");if(t&&t.args&&"string"==typeof t.args[0])return r[e.name]=t.args[0],null;const i={name:e.name};return e.type===DATA?(i.type=e.valueType||"float32",findNamedArgument(e.args,"size",e=>{i.size=e})):e.type===DATA_BLOCK&&(i.type=e.dataType||"float32",i.scalars=e.data.filter(e=>{return e.type===DATA}).map(e=>{let t=e.name,r=e.value;return n(t,r),t}),i.size=i.scalars.length),hasPropertyCall(e.annotations,"uniform")&&(i.uniform=!0),n(e.name,e.value),t?(findNamedArgument(e.args,"offset",e=>{i.offset=e}),r[e.name]=i,null):i}))}};return Object.keys(r).length&&(i.voDescriptor.aliases=r),Object.keys(t).length&&(i.voNew=t),findPropertyCall(e.data,"prototype",e=>{let t=e.args;i.voDescriptor.proto=t[0]}),i};var VertexObject=Object.freeze({create:create$9,transform:transform});const create$a=e=>{let t=e.declaration,r=e.options;if(t.generate)return new IndexedPrimitive(t.primitiveType,ElementIndexArray.Generate(r.capacity,t.indices,t.stride,t.offset));console.warn("TODO implementation: Primitive with(out) @generate(no)")},transform$1=e=>{const t=e.data,r={primitiveType:firstPropertyCallArg(t,"type")};return hasPropertyCall(t,"generate")&&(r.generate=!0),attachDataValues(r,t,["stride","offset","indices"]),r};var Primitive=Object.freeze({create:create$a,transform:transform$1});const createPrimitive=(e,t,r)=>{switch(typeof t){case"string":return e.create(t,{capacity:r});default:return t}},create$b=e=>{let t=e.ctx,r=e.declaration,n=e.options,i=void 0===n?{}:n;const o=r.voDescriptor,a=i[o],s=r[o],c=t.readOption.bind(t),l=assignOptions({},["autotouch","capacity","doubleBuffer","maxAllocVOSize","usage"],readOption$1(r,s,i,a));assignOptions(l,["setSize","setTexCoordsByTexture"],readOption$1(r,s,i,a),readOption$1(c,i,a)),l.primitive=createPrimitive(t,r.primitive,l.capacity),assignOptions(l,["vertexShader","fragmentShader","shaderProgram"],readOption$1(r,i),readOption$1(c));const u=assignOptions({},["prototype"],readOption$1(s,a),readOption$1(c,i)).prototype,h=t.create(o,u);return new SpriteGroup(h,l)},readVoPoolOptions=e=>{const t={};return findPropertyCall(e,"dynamic",e=>{t.usage=readFlag(e,!0)?"dynamic":"static"}),setFlagByPropertyCall(t,e,"doubleBuffer"),setFlagByPropertyCall(t,e,"autotouch"),setFlagByPropertyCall(t,e,"textured"),setByFirstPropertyCallArg(t,"setSize",e),setByFirstPropertyCallArg(t,"setTexCoordsByTexture",e),setByFirstPropertyCallArg(t,"prototype",e),attachDataValue(t,e,"capacity"),attachDataValue(t,e,"maxAllocVOSize"),findData(e,"textures",e=>{if(e&&e.type===DATA_BLOCK){const r={};t.textureMap=r,e.data.forEach(e=>{let t=e.name,n=e.value,i=e.annotations,o=e.args;const a={};r[t]={hints:a,src:n,type:hasPropertyCall(i,"atlas")?"atlas":"texture"},setByNamedArgument(o,a,"flipY"),setByNamedArgument(o,a,"repeatable"),setByNamedArgument(o,a,"premultiplyAlpha"),setByNamedArgument(o,a,"nearest")})}}),t},transform$2=e=>{const t=e.data,r=firstPropertyCallArg(t,"vertexObject"),n={voDescriptor:r,primitive:firstPropertyCallArg(t,"primitive")};return setByFirstPropertyCallArg(n,"vertexShader",t),setByFirstPropertyCallArg(n,"fragmentShader",t),setByFirstPropertyCallArg(n,"shaderProgram",t),Object.assign(n,readVoPoolOptions(t)),r&&findData(t,r,e=>{Object.assign(n,{[r]:readVoPoolOptions(e.data)})}),n};var SpriteGroup$1=Object.freeze({create:create$b,transform:transform$2});const VERTEX_OBJECT="vertexobject",PRIMITIVE="primitive",SPRITE_GROUP="spritegroup",FACTORIES={[VERTEX_OBJECT]:VertexObject,[PRIMITIVE]:Primitive,[SPRITE_GROUP]:SpriteGroup$1},log$3=loglevel.getLogger("picimo.toolkit.Context"),getFactory=e=>{const t=FACTORIES[e];return e||log$3.error("Context: unknown declaration type:",e),t},transformDeclaration=e=>{const t=getFactory(e.declarationType);return t?t.transform(e):e},createInstanceFromDeclaration=(e,t,r)=>{const n=get(e.declaration,t);if(!n)return;const i=getFactory(n.declarationType);return i?i.create({ctx:e,name:t,declaration:n,options:r}):null},pickDeclaration=pick(["declarationType","verb","subject"]);class Context{constructor(e){this.config=Object.assign({},e),this.declaration={}}hasOption(e){return has_1(this.config,e)}readOption(e){return get(this.config,e)}writeOption(e,t){set_1(this.config,e,t)}configure(e){return Object.assign(this.config,e),this}compile(e,t){return t&&this.configure(t),parse(e,{ctx:this}).forEach(e=>{e.type===DECLARATION&&set_1(this.declaration,e.name,Object.assign(transformDeclaration(e),pickDeclaration(e)))}),this}create(e,t){return createInstanceFromDeclaration(this,e,t)}}const configure=e=>new Context(e),compile=(e,t)=>{return new Context(t).compile(e)};var index$3=Object.freeze({compile:compile,configure:configure,Context:Context});const EVENT_CATCH_EM_ALL="*",LISTENER_IS_FUNC=1,LISTENER_IS_NAMED_FUNC=2,LISTENER_IS_OBJ=4,PRIO_MAX=Number.POSITIVE_INFINITY,PRIO_A=1e9,PRIO_B=1e6,PRIO_C=1e3,PRIO_DEFAULT=0,PRIO_LOW=-1e4,PRIO_MIN=Number.NEGATIVE_INFINITY,NAMESPACE=(()=>(Symbol.eventize||(Symbol.eventize=Symbol("eventize")),Symbol.eventize))(),LOG_NAMESPACE="[@spearwolf/eventize]",apply=(e,t,r)=>{"function"==typeof t&&t.apply(e,r)},emit=(e,t,r)=>apply(t,t.emit,[e].concat(r)),detectListenerType=e=>{switch(typeof e){case"function":return LISTENER_IS_FUNC;case"string":return LISTENER_IS_NAMED_FUNC;case"object":return LISTENER_IS_OBJ}};let lastId=0;const createUniqId=()=>++lastId;class EventListener{constructor(e,t,r,n=null){this.id=createUniqId(),this.eventName=e,this.isCatchEmAll=e===EVENT_CATCH_EM_ALL,this.listener=r,this.listenerObject=n,this.priority=t,this.listenerType=detectListenerType(r),this.callAfterApply=void 0,this.isRemoved=!1}isEqual(e,t=null){return e===this||("number"==typeof e&&e===this.id||(null===t&&"string"==typeof e?e===EVENT_CATCH_EM_ALL||e===this.eventName:this.listener===e&&this.listenerObject===t))}apply(e,t){if(this.isRemoved)return;const{listener:r,listenerObject:n}=this;switch(this.listenerType){case LISTENER_IS_FUNC:apply(n,r,t),this.callAfterApply&&this.callAfterApply();break;case LISTENER_IS_NAMED_FUNC:apply(n,n[r],t),this.callAfterApply&&this.callAfterApply();break;case LISTENER_IS_OBJ:{const n=r[e];(this.isCatchEmAll||this.eventName===e)&&("function"==typeof n?n.apply(r,t):emit(e,r,t),this.callAfterApply&&this.callAfterApply());break}}}}const sortByPrioAndId=(e,t)=>e.priority!==t.priority?t.priority-e.priority:e.id-t.id,cloneArray=e=>{if(e)return e.slice(0)},removeListenerItem=(e,t)=>{const r=e.indexOf(t);r>-1&&e.splice(r,1)},removeListener=(e,t,r)=>{const n=e.findIndex(e=>e.isEqual(t,r));n>-1&&(e[n].isRemoved=!0,e.splice(n,1))},removeAllListeners=e=>{e&&(e.forEach(e=>{e.isRemoved=!0}),e.length=0)};class EventStore{constructor(){this.namedListeners=new Map,this.catchEmAllListeners=[]}add(e){if(e.isCatchEmAll)this.catchEmAllListeners.push(e),this.catchEmAllListeners.sort(sortByPrioAndId);else{const{eventName:t}=e;let r=this.namedListeners.get(t);r||(r=[],this.namedListeners.set(t,r)),r.push(e),r.sort(sortByPrioAndId)}}remove(e,t){if(null==t&&Array.isArray(e))e.forEach(this.remove.bind(this));else if(null==e||null==t&&e===EVENT_CATCH_EM_ALL)this.removeAllListeners();else if(null==t&&"string"==typeof e){const t=this.namedListeners.get(e);removeAllListeners(t)}else e instanceof EventListener?(e.isRemoved=!0,this.namedListeners.forEach(t=>removeListenerItem(t,e)),removeListenerItem(this.catchEmAllListeners,e)):(this.namedListeners.forEach(r=>removeListener(r,e,t)),removeListener(this.catchEmAllListeners,e,t))}removeAllListeners(){this.namedListeners.forEach(e=>removeAllListeners(e)),this.namedListeners.clear(),removeAllListeners(this.catchEmAllListeners)}forEach(e,t){const r=cloneArray(this.catchEmAllListeners),n=cloneArray(this.namedListeners.get(e));if(e!==EVENT_CATCH_EM_ALL&&n&&0!==n.length)if(0===r.length)n.forEach(t);else{const e=n.length,i=r.length;let o=0,a=0;for(;o<e||a<i;){if(o<e){const e=n[o];if(a>=i||e.priority>=r[a].priority){t(e),++o;continue}}a<i&&(t(r[a]),++a)}}else r.forEach(t)}}class EventKeeper{constructor(){this.events=new Map,this.eventNames=new Set}add(e){Array.isArray(e)?e.forEach(e=>this.eventNames.add(e)):this.eventNames.add(e)}remove(e){Array.isArray(e)?e.forEach(e=>this.remove(e)):this.eventNames.delete(e)}retain(e,t){this.eventNames.has(e)&&this.events.set(e,t)}isKnown(e){return this.eventNames.has(e)}emit(e,t){if(e===EVENT_CATCH_EM_ALL)this.eventNames.forEach(e=>this.emit(e,t));else{const r=this.events.get(e);r&&t.apply(e,r)}}}const defineHiddenPropertyRO=(e,t,r)=>(Object.defineProperty(e,t,{value:r,configurable:!0}),e),hasConsole="undefined"!=typeof console,warn=hasConsole?console[console.warn?"warn":"log"].bind(console,LOG_NAMESPACE):()=>void 0,registerEventListener=(e,t,r,n,i,o)=>{const a=new EventListener(r,n,i,o);return e.add(a),t.emit(r,a),a},subscribeTo=(e,t,r)=>{const n=r.length,i=typeof r[0];let o,a,s,c;if(n>=2&&n<=3&&"number"===i?(o=EVENT_CATCH_EM_ALL,[a,s,c]=r):n>=3&&n<=4&&"number"==typeof r[1]?[o,a,s,c]=r:(a=0,"string"===i||Array.isArray(r[0])?[o,s,c]=r:(o=EVENT_CATCH_EM_ALL,[s,c]=r)),!s&&hasConsole)return void warn("called with insufficient arguments!",r);const l=r=>n=>registerEventListener(e,t,n,r,s,c);return Array.isArray(o)?o.map(e=>Array.isArray(e)?l(e[1])(e[0]):l(a)(e)):l(a)(o)},removeListener$1=e=>t=>{t.callAfterApply=(()=>e.off(t))};function injectEventizeApi(e){if(e[NAMESPACE])return e;const t=new EventStore,r=new EventKeeper;return defineHiddenPropertyRO(e,NAMESPACE,{keeper:r,store:t}),Object.assign(e,{on:(...e)=>subscribeTo(t,r,e),once(...n){const i=subscribeTo(t,r,n);return Array.isArray(i)?i.forEach(removeListener$1(e)):removeListener$1(e)(i),i},off(e,n){t.remove(e,n),Array.isArray(e)?r.remove(e.filter(e=>"string"==typeof e)):"string"==typeof e&&r.remove(e)},emit(e,...n){Array.isArray(e)?e.forEach(e=>{t.forEach(e,t=>t.apply(e,n)),r.retain(e,n)}):e!==EVENT_CATCH_EM_ALL&&(t.forEach(e,t=>t.apply(e,n)),r.retain(e,n))},retain(e){r.add(e)}}),e}function eventize(e){return injectEventizeApi(e)}eventize.inject=injectEventizeApi,eventize.extend=(e=>injectEventizeApi(Object.create(e))),eventize.create=(e=>{const t=injectEventizeApi({});return t.on(EVENT_CATCH_EM_ALL,0,e),t}),eventize.is=(e=>!(!e||!e[NAMESPACE])),Object.assign(eventize,{PRIO_MAX:PRIO_MAX,PRIO_A:1e9,PRIO_B:1e6,PRIO_C:1e3,PRIO_DEFAULT:0,PRIO_LOW:-1e4,PRIO_MIN:PRIO_MIN});var getComponentName=e=>{switch(typeof e){case"string":return e;case"function":switch(typeof e.componentName){case"function":return e.componentName();case"string":return e.componentName;default:return}default:return}};const hasComponent=e=>t=>e.components.has(getComponentName(t));class Entity{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:uuid();this.id=t,Object.defineProperties(this,{ecs:{value:e},components:{value:new Set}}),eventize(this)}destroy(){this.destroyed||(this.destroyed=!0,this.components.forEach(this.deleteComponent.bind(this)),this.ecs.destroyEntity(this.id))}setComponent(e,t){if(this.components.has(e)){if(this[e]!==t)throw new Error(`Entity.setComponent(): component already exists; name='${e}'`)}else this.components.add(e),this[e]=t,t.connectedEntity&&t.connectedEntity(this),this.emit(`componentConnected:${e}`,t,this)}hasComponent(e){return Array.isArray(e)?e.every(hasComponent(this)):hasComponent(this)(e)}deleteComponent(e){if(this.components.has(e)){const t=this[e];this.ecs.destroyComponent(e,t),this.components.delete(e),this.emit(`destroyComponent:${e}`,t,this),t.disconnectedEntity&&t.disconnectedEntity(this),delete this[t]}}}class ComponentRegistry{constructor(){this.factories=new Map}registerComponent(e,t){this.factories.set(e,t)}getComponentFactory(e){const t=getComponentName(e),r=this.factories.get(t);if(!r)throw new Error(`ComponentRegistry: unknown factory '${t}'`);return r}createComponent(e,t,r){const n=getComponentName(t),i=this.getComponentFactory(n).create(e,r);e.setComponent(n,i)}updateComponent(e,t,r){const n=getComponentName(t),i=this.getComponentFactory(n),o=e[n];i.update(o,r)}createOrUpdateComponent(e,t,r){const n=getComponentName(t);this[e.hasComponent(n)?"updateComponent":"createComponent"](e,n,r)}destroyComponent(e,t){const r=this.factories.get(getComponentName(e));r&&r.destroy&&r.destroy(t)}}class ECS extends ComponentRegistry{constructor(){super(),this.entities=new Map}createEntity(e,t){const r=new Entity(this,t);if(this.entities.has(r.id))throw new Error(`ECS: duplicate entity.id='${r.id}' are not allowed`);return this.entities.set(r.id,r),Array.isArray(e)&&e.forEach(e=>{Array.isArray(e)?this.createComponent(r,...e):this.createComponent(r,e)}),r}getEntity(e){return this.entities.get(e)}destroyEntity(e){const t=this.entities.get(e);t&&(this.entities.delete(e),t.destroyed||t.destroy())}destroyAllEntities(){this.entities.forEach(e=>e.destroy())}}class ComponentFactory{static registerComponent(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];r.forEach(t=>{e.registerComponent(t.componentName(),new ComponentFactory(t))})}constructor(e){this.componentClass=e}create(e,t){return new this.componentClass(e,t)}update(e,t){e.update&&e.update(t)}destroy(e){e.destroy&&e.destroy()}}var index$4=Object.freeze({ECS:ECS,ComponentFactory:ComponentFactory});export{index$1 as core,index$4 as ecs,eventize,index$2 as renderer,index$3 as toolkit,index as utils};
//# sourceMappingURL=picimo.mjs.map
